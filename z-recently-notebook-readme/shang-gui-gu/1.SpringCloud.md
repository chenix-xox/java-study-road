# ç‰¹åˆ«æ„Ÿè°¢

è§†é¢‘æ•™ç¨‹ï¼šhttps://www.bilibili.com/video/BV1gW421P7RD



## æ— ä¼¤é€Ÿé€šç‰ˆæœ¬

- JDK17
- Cloud 2023.0.0
- SpringBoot 3.2.0
- Cloud Alibaba 2022.0.0.0-RC2
- Maven 3.9
- MySQL 8.0



## æ³¨æ„äº‹é¡¹

å¦‚æœåŒæ—¶ä½¿ç”¨Bootå’ŒCloudï¼Œå°†ç”±Cloudæ¥å†³å®šBootçš„ç‰ˆæœ¬

### ç‰ˆæœ¬å‘å¸ƒè¯´æ˜

[Home Â· alibaba/spring-cloud-alibaba Wiki (github.com)](https://github.com/alibaba/spring-cloud-alibaba/wiki)

å·²è¿ç§»è‡³ï¼š[ç‰ˆæœ¬å‘å¸ƒè¯´æ˜ | Spring Cloud Alibaba (aliyun.com)](https://sca.aliyun.com/zh-cn/docs/2022.0.0.0/overview/version-explain)



# å¤ä¹ ä¸“ç”¨

> ç”±äºä¸ªäººç»å¸¸éš”å¾ˆå·®è¿‡ä¸€æ®µæ—¶é—´ï¼Œé—´æ–­æ€§å­¦ä¹ ï¼Œå› æ­¤è®°å½•å¿«é€Ÿå¤ä¹ æµç¨‹

- **æ‰“å¼€consulæ³¨å†Œä¸­å¿ƒ**

  localhost:8500

- ä¾æ¬¡å¯åŠ¨æœåŠ¡**æä¾›è€…**ï¼šcloud-payment-service-8001/8002

  è®¿é—®æµ‹è¯•ï¼šlocalhost:8001/pay/getInfo   and   localhost:8002/pay/getInfo

  ã€æ­¤å‰æ­¥éª¤ç”±Consulå®Œæˆã€‘

- å¯åŠ¨æœåŠ¡**è°ƒç”¨è€…ï¼š** cloud-consumer-openfeign-order

  è®¿é—®æµ‹è¯•ï¼šlocalhost/feign/pay/mylb

  åšäº†è´Ÿè½½å‡è¡¡ï¼Œè¿”å›ä¿¡æ¯åº”åœ¨8001å’Œ8002æ¨ªè·³

  ã€æ­¤æ­¥éª¤ç”±OpenFeignå®Œæˆã€‘



# ç®€è¿°

## ä¸ƒä¸ªå¸¸ç”¨çš„ä¸»æµç»´åº¦ï¼ˆSpring Cloud 2024ï¼‰

- **æœåŠ¡æ³¨å†Œä¸å‘ç°**

  Eurekaï¼ˆä¸æ¨èï¼‰

  Consul

  Alibaba Nacos

- **æœåŠ¡è°ƒç”¨ä¸è´Ÿè½½å‡è¡¡**

  Ribbonï¼ˆåœæ›´ï¼‰

  LoadBalancer

  OpenFeign

- **åˆ†å¸ƒå¼äº‹åŠ¡**

  Alibaba Seata

  LCN

  Hmily

- **æœåŠ¡ç†”æ–­å’Œé™çº§**

  Hystrixï¼ˆä¸å†ä½¿ç”¨ï¼‰

  Circuit Breakerï¼ˆæ–­è·¯å™¨ï¼‰

  Alibaba Sentinel

- **æœåŠ¡é“¾è·¯è¿½è¸ª**

  Sleuth + Zipkin ï¼ˆé€€å‡ºä¸­..ï¼‰

  Micrometer Tracing

- **æœåŠ¡ç½‘å…³**

  Zuulï¼ˆé€€..ï¼‰

  GateWay

- **åˆ†å¸ƒå¼é…ç½®ç®¡ç†**

  Consul

  Alibaba Nacos



## åˆ›å»ºé¡¹ç›®

- è®¾ç½®packingä¸ºpomï¼Œä»£è¡¨å…¶ä¸ºçˆ¶å·¥ç¨‹

- Mavenä½¿ç”¨`dependencyManagement`å…ƒç´ æä¾›ç®¡ç†ä»¥æ¥ç‰ˆæœ¬å·çš„æ–¹å¼

  **ä¼ é€’ä¾èµ–**

  é€šå¸¸ä¼šåœ¨ä¸€ä¸ªç»„ç»‡æˆ–é¡¹ç›®çš„æœ€é¡¶å±‚çš„çˆ¶POMä¸­çœ‹åˆ°`dependencyManagement`å…ƒç´ 

  pom.xmlä¸­çš„`dependencyManagement`å…ƒç´ ï¼Œèƒ½è®©æ‰€æœ‰å­é¡¹ç›®ä¸­å¼•ç”¨ä¸€ä¸ªä¾èµ–ï¼Œè€Œä¸æ˜¾ç¤ºçš„åˆ—å‡ºç‰ˆæœ¬å·

  Mavenä¼šæ²¿ç€çˆ¶å­å±‚æ¬¡å‘ä¸Šèµ°ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ‹¥æœ‰`dependencyManagement`å…ƒç´ çš„é¡¹ç›®ï¼Œä½¿ç”¨å…¶æŒ‡å®šçš„ç‰ˆæœ¬å·
  **å­é¡¹ç›®**ä¼šç›´æ¥ä½¿ç”¨çˆ¶ç±»çš„ç‰ˆæœ¬ï¼Œä¸éœ€è¦å†é¢å¤–å¼•å…¥ã€‚å¦‚æœéœ€è¦åˆ«çš„ç‰ˆæœ¬ï¼Œç›´æ¥åŠ å…¥versionæ ‡ç­¾å³å¯

  **ä¸ºä»€ä¹ˆä¼šçˆ†çº¢**

  åªæ˜¯å¯¹ä¾èµ–è¿›è¡Œç®¡ç†ï¼Œå¹¶ä¸å®é™…å¼•å…¥

  **è§£å†³æ–¹æ¡ˆï¼š**å–æ¶ˆ`dependencyManagement`æ ‡ç­¾ï¼Œè®©Mavenè¿›è¡Œä¾èµ–ä¸‹è½½ï¼Œå†åŠ ä¸Š`dependencyManagement`æ ‡ç­¾å³å¯

- æ‰“åŒ…å¯åŠ¨æ…¢ï¼Œå¯ä»¥å‹¾é€‰Mavenè·³è¿‡å•å…ƒæµ‹è¯•çš„æŒ‰é’®



## ä½¿ç”¨æŠ€æœ¯äº®ç‚¹

- Mapper4ï¼šç±»ä¼¼MyBatisPlusçš„ç®€ä¾¿MyBatiså¼€å‘å·¥å…·

- å¼•å…¥äº†mybatis-generatoråï¼Œç¼–å†™é…ç½®æ–‡ä»¶...

  åŒå‡»`Maven`**-**`Plugins`**-**`mybatis`**-**`generator`**-**`mybatis-generator:generate`

  å³å¯è‡ªåŠ¨ç”Ÿæˆ**entities**å’Œ**mapper** + **mapper.xml**

  



## å»ºå¾®æœåŠ¡

1. å»ºmodule
2. æ”¹pom
3. å†™yml
4. ä¸»å¯åŠ¨
5. ä¸šåŠ¡ç±»



## å°Tips

1. å¯åŠ¨ç±»ä¸Šï¼ŒåŠ `@MapperScan("com.chenix.cloud.mapper")`

   å°±å¯ä»¥ä¸ç”¨åœ¨æ¯ä¸ª`xxxMapper`ä¸Šå†™@Mapperæ³¨è§£äº†

2. ä¸æ–¹ä¾¿æš´éœ²ç»™å‰ç«¯çš„å­—æ®µï¼Œå¯ä»¥å†™ä¸€ä¸ªXxxDTOå®ä½“ç±»è¿›è¡Œæš´éœ²

   ä¸èƒ½æš´éœ²çš„å°±æ”¾åœ¨Xxx

3. mybatis-generatorå°±æ˜¯ä¸“é—¨å¿«é€Ÿç”Ÿæˆentitieså’Œmapperç”¨çš„ï¼Œå°†å…¶å¤åˆ¶ç²˜è´´åˆ°ä¸»è¦çš„é¡¹ç›®ä¸­

   ç„¶ååˆ é™¤mybatis-generatorä¸‹çš„ï¼Œé¿å…æŒ‡å‘å‡ºé”™

4. æ³¨å…¥å¯ä»¥ç”¨@Autowiredï¼Œä¹Ÿå¯ä»¥ç”¨@Resourceï¼Œçœ‹ä¸ªäººä¹ æƒ¯

   @Autowiredå®¹æ˜“è­¦å‘Š

5. å› ä¸ºç»™å‰ç«¯çœ‹çš„æ˜¯XxxDTOï¼Œå‰ç«¯ä¼ æ¥çš„XxxDTOè¦æ‹·è´åˆ°æœåŠ¡ç«¯å¤„ç†çš„Xxxä¸­

   ä½¿ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œæ‹·è´ï¼š

   ```java
   Pay pay = new Pay();
   BeanUtils.copyProperties(payDTO, pay);
   ```

6. å¼•ç”¨knife4jï¼Œè®¿é—® `ip:port/doc.html`

   ```xml
   <dependency>
       <groupId>com.github.xiaoymin</groupId>
       <artifactId>knife4j-openapi3-jakarta-spring-boot-starter</artifactId>
       <version>${knife4j.version}</version>
   </dependency>
   ```

   ```yaml
   # knife4j
   knife4j:
     enable: true
     setting:
       language: zh_cn
   # springdoc-openapié¡¹ç›®é…ç½®
   springdoc:
     swagger-ui:
       path: /swagger-ui.html
       tags-sorter: alpha
       operations-sorter: alpha
     api-docs:
       path: /v3/api-docs
     group-configs:
       - group: 'default'
         paths-to-match: '/**'
         packages-to-scan: com.chenix.cloud.controller
   ```



## è°ƒæ•´ä¸è¶³

1. æ—¶é—´æ—¥å¿—æ ¼å¼çš„ç»Ÿä¸€å’Œå®šåˆ¶æƒ…å†µï¼šé…ç½®æ–‡ä»¶æ·»åŠ æ—¶é—´æ ¼å¼åŒ–

   ```yaml
   spring:
   	jackson:
     		date-format: yyyy-MM-dd HH:mm:ss
     			time-zone: GMT+8
   ```

   **éSpringBooté¡¹ç›®**ï¼Œå¯ä»¥åœ¨å®ä½“ç±»çš„å¯¹åº”å‚æ•°ä¸Šè¿›è¡Œè®¾ç½®

   `@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")`

2. è¿”å›ç»™å®¢æˆ·ç«¯çš„æ•°æ®ç§ç±»è¿‡å¤šï¼Œå¯å°è£…ç»Ÿä¸€çš„è¿”å›å€¼

   codeï¼Œmsgï¼Œdata å¯æ‰©å±•-timestampï¼ˆæ¥å£è°ƒç”¨æ—¶é—´ï¼‰

3. æšä¸¾æ­¥éª¤ ç½—åˆ—-æ„é€ -éå†

   **ç½—åˆ—**

   ```java
   // æ“ä½œå¤±è´¥
   RC999("999", "æ“ä½œXXXå¤±è´¥"),
   // æ“ä½œæˆåŠŸ
   RC200("200", "success"),
   // æœåŠ¡é™çº§
   RC201("201", "æœåŠ¡å¼€å¯é™çº§ä¿æŠ¤,è¯·ç¨åå†è¯•!"),
   ```

   **æ„é€ **

   ```java
   // è‡ªå®šä¹‰çŠ¶æ€ç 
   private final String code;
   // è‡ªå®šä¹‰æè¿°
   private final String message;
   ReturnCodeEnum(String code, String message) {
       this.code = code;
       this.message = message;
   }
   ```

   **éå†**

   ```java
   //éå†æšä¸¾V1
   public static ReturnCodeEnum getReturnCodeEnum(String code) {
       for (ReturnCodeEnum element : ReturnCodeEnum.values()) {
           if (element.getCode().equalsIgnoreCase(code)) {
               return element;
           }
       }
       return null;
   }
   
   //éå†æšä¸¾V2
   public static ReturnCodeEnum getReturnCodeEnumV2(String code) {
       return Arrays.stream(ReturnCodeEnum.values())
           .filter(x -> x.getCode().equalsIgnoreCase(code))
           .findFirst()
           .orElse(null);
   }
   ```

   **æµ‹è¯•**

   ```java
   System.out.println(getReturnCodeEnumV2("200"));
   System.out.println(getReturnCodeEnumV2("200").getCode());
   System.out.println(getReturnCodeEnumV2("200").getMessage());
   ```

4. æ–°å»ºç»Ÿä¸€çš„è¿”å›å¯¹è±¡

   ```java
   @Data
   @Accessors(chain = true)
   public class ResultData<T> {
       private String code;
       /**
        * ç»“æœçŠ¶æ€ ,å…·ä½“çŠ¶æ€ç å‚è§æšä¸¾ç±»ReturnCodeEnum.java
        */
       private String message;
       private T data;
       private long timestamp;
       public ResultData() {
           this.timestamp = System.currentTimeMillis();
       }
       public static <T> ResultData<T> success(T data) {
           ResultData<T> resultData = new ResultData<>();
           resultData.setCode(ReturnCodeEnum.RC200.getCode());
           resultData.setMessage(ReturnCodeEnum.RC200.getMessage());
           resultData.setData(data);
           return resultData;
       }
       public static <T> ResultData<T> fail(String code, String message) {
           ResultData<T> resultData = new ResultData<>();
           resultData.setCode(code);
           resultData.setMessage(message);
           return resultData;
       }
   }
   ```

5. å…¨å±€å¼‚å¸¸æ¥å…¥è¿”å›çš„æ ‡å‡†æ ¼å¼

   



## å°Tips V2

1. Lomboké‡Œçš„ä¸€ä¸ªæ³¨è§£ï¼š`@Accessors(chain = true)`

   ä½¿ç”¨è¯¥æ³¨è§£é…ç½®ï¼Œå½“newä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œå„ç§setæ“ä½œåï¼Œè¿”å›è¯¥å¯¹è±¡

   ```java
   Xxx xxx = new Xxx().setName("chenix").setAge(18)
   ```

   å‚è€ƒBlogï¼š[@Accessors æ³¨è§£è¯¦è§£-CSDNåšå®¢](https://blog.csdn.net/sunnyzyq/article/details/119992746)



## å°å°å¼•å…¥å¾®æœåŠ¡æ¦‚å¿µ

> Rest Templateæä¾›äº†å¤šç§ä¾¿æ·è®¿é—®è¿œç¨‹HttpæœåŠ¡çš„æ–¹æ³•ï¼Œ 
>
> æ˜¯ä¸€ç§ç®€å•ä¾¿æ·çš„è®¿é—®restfulæœåŠ¡æ¨¡æ¿ç±»ï¼Œæ˜¯Springæä¾›çš„ç”¨äºè®¿é—®RestæœåŠ¡çš„å®¢æˆ·ç«¯æ¨¡æ¿å·¥å…·é›†

### è®¢å•å¾®æœåŠ¡80å¦‚ä½•æ‰èƒ½è°ƒç”¨åˆ°æ”¯ä»˜å¾®æœåŠ¡8001ï¼Ÿ

deleteæ— æ³•è·å–è¿”å›å€¼è§£å†³æ–¹æ¡ˆï¼š[RestTemplateçš„put,deleteè¯·æ±‚æ¥æ”¶è¿”å›å€¼_resttemplate putæ–¹æ³• å“åº”-CSDNåšå®¢](https://blog.csdn.net/weixin_38373006/article/details/88849494)

**é€šè¿‡RestTemplate**

> -config
>
> â€‹	-RestTemplateConfig.java

```java
@Configuration
public class RestTemplateConfig {
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

  

> **controllerç¤ºä¾‹**
>
> - ä½¿ç”¨RestTemplate + è¿œç¨‹æœåŠ¡çš„è¿æ¥ è°ƒç”¨è¿œç¨‹æœåŠ¡æ¥å£

```java
@RestController
@RequestMapping("/order/pay")
public class OrderController {
    public static final String PAYMENT_SRV_URL = "http://localhost:8001";
    @Resource
    private RestTemplate restTemplate;

    @PostMapping(value = "/add")
    public ResultData addOrder(PayDTO payDTO) {
        return restTemplate.postForObject(PAYMENT_SRV_URL + "/pay/add", payDTO, ResultData.class);
    }

    @DeleteMapping(value = "/delete/{id}")
    public void deleteOrder(@PathVariable("id") Integer id) {
        restTemplate.delete(PAYMENT_SRV_URL + "/pay/delete/" + id, id);
    }

    @GetMapping(value = "/get/{id}")
    public ResultData getById(@PathVariable("id") Integer id) {
        return restTemplate.getForObject(PAYMENT_SRV_URL + "/pay/get/" + id, ResultData.class, id);
    }

    @PutMapping(value = "/update")
    public ResultData update(@RequestBody PayDTO payDTO) {
        System.out.println("å¤„ç†çš„æ•°æ®ï¼š" + payDTO);
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        HttpEntity<String> request = new HttpEntity<>(JSON.toJSON(payDTO).toString(), headers);
        ResponseEntity<ResultData> exchange = restTemplate.exchange(
                PAYMENT_SRV_URL + "/pay/update",
                HttpMethod.PUT,
                request,
                ResultData.class
        );
        return exchange.getBody();
    }

    @GetMapping(value = "/getAll")
    public ResultData getAll() {
        return restTemplate.getForObject(PAYMENT_SRV_URL + "/pay/all", ResultData.class);
    }
}
```



## è§‚å¯Ÿé—®é¢˜

### å…¶ä¸€ï¼ˆé‡å¤æ¨¡å—ï¼‰

**å­˜åœ¨é—®é¢˜ï¼š**orderæœåŠ¡å’ŒprovideræœåŠ¡å­˜åœ¨é‡å¤ä»£ç 

[![pFoN5GV.png](https://s21.ax1x.com/2024/03/28/pFoN5GV.png)](https://imgse.com/i/pFoN5GV)











**è§£å†³æ–¹æ¡ˆï¼š**æŠ½å–å…¬å…±éƒ¨åˆ†ï¼Œæ–°å»ºä¸€ä¸ªæœåŠ¡ï¼Œå­˜æ”¾å¯¹å¤–æš´éœ²çš„ç»„ä»¶/api/æ¥å£/å·¥å…·ç±»...

`cloud-api-commons`ï¼Œå°†å¤ç”¨æ€§é«˜çš„éƒ¨åˆ†æ”¾è¿›å»ï¼Œå¹¶è¿›è¡Œinstallæ“ä½œï¼Œæˆä¸ºä¸€ä¸ªjaråŒ…

æˆä¸ºjaråŒ…åï¼Œåœ¨å„ä¸ªæœåŠ¡ä¸­è¿›è¡Œåº”ç”¨å³å¯

### å…¶äºŒï¼ˆControllerä¸­å†™æ­»çš„ç¡¬ç¼–ç URLï¼‰

[![pFoaTHJ.png](https://s21.ax1x.com/2024/03/28/pFoaTHJ.png)](https://imgse.com/i/pFoaTHJ)





å¾®æœåŠ¡æ‰€åœ¨çš„IPåœ°å€å’Œç«¯å£å·ç¡¬ç¼–ç åˆ°è®¢å•å¾®æœåŠ¡ä¸­ï¼Œä¼šå­˜åœ¨éå¸¸å¤šçš„é—®é¢˜

ï¼ˆ1ï¼‰å¦‚æœè®¢å•å¾®æœåŠ¡å’Œæ”¯ä»˜å¾®æœåŠ¡çš„IPåœ°å€æˆ–è€…ç«¯å£å·å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™æ”¯ä»˜å¾®æœåŠ¡å°†å˜å¾—ä¸å¯ç”¨ï¼Œéœ€è¦åŒæ­¥ä¿®æ”¹è®¢å•å¾®æœåŠ¡ä¸­è°ƒç”¨æ”¯ä»˜å¾®æœåŠ¡çš„IPåœ°å€å’Œç«¯å£å·ã€‚

ï¼ˆ2ï¼‰å¦‚æœç³»ç»Ÿä¸­æä¾›äº†å¤šä¸ªè®¢å•å¾®æœåŠ¡å’Œæ”¯ä»˜å¾®æœåŠ¡ï¼Œåˆ™æ— æ³•å®ç°å¾®æœåŠ¡çš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚

ï¼ˆ3ï¼‰å¦‚æœç³»ç»Ÿéœ€è¦æ”¯æŒæ›´é«˜çš„å¹¶å‘ï¼Œéœ€è¦éƒ¨ç½²æ›´å¤šçš„è®¢å•å¾®æœåŠ¡å’Œæ”¯ä»˜å¾®æœåŠ¡ï¼Œç¡¬ç¼–ç è®¢å•å¾®æœåŠ¡åˆ™åç»­çš„ç»´æŠ¤ä¼šå˜å¾—å¼‚å¸¸å¤æ‚ã€‚ 

æ‰€ä»¥ï¼Œåœ¨å¾®æœåŠ¡å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å¼•å…¥**æœåŠ¡æ²»ç†åŠŸèƒ½**ï¼Œå®ç°å¾®æœåŠ¡ä¹‹é—´çš„åŠ¨æ€æ³¨å†Œä¸å‘ç°ï¼Œä»æ­¤åˆ»å¼€å§‹æˆ‘ä»¬æ­£å¼è¿›å…¥SpringCloudå®æˆ˜



# ConsulæœåŠ¡æ³¨å†Œä¸å‘ç°

## ä»¥å‰çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒEureka

**ä¸ºä»€ä¹ˆä¸ç”¨ï¼Ÿ**

1. åœæ›´

2. æ²¡æœ‰ä¸ä¸šåŠ¡ä»£ç è§£è€¦ï¼Œæ··ä¸ºä¸€è°ˆäº†

   ç›®æ ‡æ˜¯ä¸ºäº†å¾—åˆ°ä¸€ä¸ªå•ç‹¬éš”ç¦»å‡ºæ¥çš„ï¼Œè€Œä¸æ˜¯ä½œä¸ºå¾®æœåŠ¡çš„ä¸€éƒ¨åˆ†åµŒå…¥åˆ°ç³»ç»Ÿä¸­

3. Alibaba Nacos å´›èµ·



## å®˜ç½‘

[Consul by HashiCorp](https://www.consul.io/)

## What is Consul?

HashiCorp Consul is a service networking solution that enables teams to manage secure network connectivity between services and across on-prem and multi-cloud environments and runtimes. Consul offers service discovery, service mesh, traffic management, and automated updates to network infrastructure device. You can use these features individually or together in a single Consul deployment.

## Spring-Cloud

https://spring.io/projects/spring-cloud-consul

Spring Cloud Consul provides [Consul](http://consul.io/) integrations for Spring Boot apps through autoconfiguration and binding to the Spring Environment and other Spring programming model idioms. With a few simple annotations you can quickly enable and configure the common patterns inside your application and build large distributed systems with Hashicorpâ€™s Consul. The patterns provided include Service Discovery, Distributed Configuration and Control Bus.

## èƒ½å¹²å˜›

1. æœåŠ¡å‘ç°ï¼šæä¾›HTTPå’ŒDNSä¸¤ç§å‘ç°æ–¹å¼
2. å¥åº·æ£€æµ‹ï¼šæ”¯æŒå¤šç§æ–¹å¼ï¼ŒHTTPã€TCPã€Dockerã€Shellè„šæœ¬å®šåˆ¶åŒ–ç›‘æ§
3. KVå­˜å‚¨
4. å¤šæ•°æ®ä¸­å¿ƒ
5. å¯è§†åŒ–Webç•Œé¢

#### ç‰¹ç‚¹ï¼ˆEnï¼‰

Features of Consul

- Distributed configuration
- Service registration and discovery
- Distributed events
- Distributed locking and sessions
- Supports multiple data centers
- Built in, user-friendly user interface

## ä¸‹è½½

åœ°å€ï¼šhttps://developer.hashicorp.com/consul/install

## è§£å‹ å¹¶æŸ¥çœ‹ç‰ˆæœ¬

åœ¨è§£å‹çš„ç›®å½•ä¸‹çœ‹åˆ°consul.exeï¼Œä½¿ç”¨consul --versionæŸ¥çœ‹ç‰ˆæœ¬

```bash
D:\software\consul_1.18.1_windows_386>consul --version
Consul v1.18.1
Revision 98cb473c
Build Date 2024-03-26T21:59:08Z
Protocol 2 spoken by default, understands 2 to 3 (agent will automatically use protocol >2 when speaking to compatible agents)
```

## ä»¥å¼€å‘è€…æ¨¡å¼å¯åŠ¨

**å‘½ä»¤ï¼š**`consul agent -dev`

**è®¿é—®åœ°å€ï¼š**http://localhost:8500/

## æ‹“å±•

å¦‚ä½•çŸ¥é“å¯åŠ¨ç«¯å£ä¸º8500ï¼Ÿ

æŸ¥çœ‹Githubçš„readme

## ....

## æ³¨å…¥æœåŠ¡

### å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-consul-discovery</artifactId>
</dependency>
```

### ç¼–å†™é…ç½®æ–‡ä»¶

```yaml
spring:
  application:
    name: cloud-payment-service
  cloud:
    # consul é…ç½®
    consul:
      host: localhost
      port: 8500
      discovery:
        service-name: ${spring.application.name}
```

### ä¸»å¯åŠ¨ï¼Œæ¿€æ´»

Applicationä¸Šæ·»åŠ `@EnableDiscoverClient`

### ä¿®å¤æç¤ºè­¦å‘Š

Standard Commons Logging discovery in action with spring-jcl: please remove commons-logging.jar from classpath in order to avoid potential conflicts

è¯´ï¼Œè¯·ç§»é™¤ commons-logging.jar

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-consul-discovery</artifactId>
    <exclusions>
        <exclusion>
            <groupId>commons-logging</groupId>
            <artifactId>commons-logging</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

## è§£å†³ç¡¬ç¼–ç URL

å°†providerå’Œorderéƒ½æ³¨å…¥åˆ°æ³¨å†Œä¸­å¿ƒå

orderéƒ¨åˆ†åŸæœ¬ä½¿ç”¨çš„ç¡¬ç¼–ç 

```java
public static final String PAYMENT_SRV_URL = "http://localhost:8001";
```

å°±å¯ä»¥ä¿®æ”¹ä¸ºï¼š

**psï¼š** cloud-payment-serviceæ˜¯provideråœ¨æ³¨å†Œä¸­å¿ƒä¸Šçš„åç§°

```java
public static final String PAYMENT_SRV_URL = "http://cloud-payment-service";
```



## è§£å†³æŠ¥é”™

### é—®é¢˜

è¿è¡Œåï¼Œè®¿é—®orderç«¯çš„æ¥å£ï¼ŒæŠ¥é”™ï¼š

`java.net.UnknownHostException:cloud-payment-service`

```bash
org.springframework.web.client.ResourceAccessException: I/O error on GET request for "http://cloud-payment-service/pay/all": cloud-payment-service
...
Caused by: java.net.UnknownHostException: cloud-payment-service
```



### è§£å†³æ–¹æ¡ˆ

åœ¨**RestTemplate**å·¥å…·ç±»ä¸ŠåŠ ä¸Š`@LoadBalanced`

å› ä¸ºç”¨çš„æ˜¯**å¾®æœåŠ¡åç§°**è®¿é—®ï¼Œè¯¥æœåŠ¡åå¯èƒ½ä½œä¸ºä¸€ä¸ªé›†ç¾¤ï¼Œå…¶ä¸‹å¯èƒ½å­˜åœ¨å¤šä¸ª**å¾®æœåŠ¡**

å› æ­¤æ·»åŠ `@LoadBalanced`è¿›è¡Œè´Ÿè½½å¹³è¡¡



# ConsulæœåŠ¡é…ç½®ä¸åˆ·æ–°

å¾®æœåŠ¡æ„å‘³ç€è¦å°†å•ä½“åº”ç”¨çš„ä¸šåŠ¡æ‹†åˆ†æˆä¸€ä¸ªä¸ªå­æœåŠ¡

ç”±äºæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦å¿…è¦çš„é…ç½®ä¿¡æ¯

æ‰€ä»¥éœ€è¦ä¸€å¥—é›†ä¸­å¼ã€åŠ¨æ€çš„é…ç½®ç®¡ç†è®¾æ–½

æ¯”å¦‚æŸäº›é…ç½®æ–‡ä»¶çš„å†…å®¹å¤§éƒ¨åˆ†ç›¸åŒï¼Œå½“ä¸»æœºè¿ç§»çš„æ—¶å€™

æˆ‘ä»¬å¸Œæœ›ä¸€æ¬¡è¿ç§»ï¼Œå¤„å¤„ç”Ÿæ•ˆ



## éœ€æ±‚

é€šç”¨å…¨å±€é…ç½®ä¿¡æ¯ï¼Œç›´æ¥æ³¨å†Œåˆ°consulæœåŠ¡å™¨ï¼Œä»consulæœåŠ¡å™¨è·å–

éµå¾ªconsulé…ç½®è§„åˆ™è¦æ±‚



## å¯¼åŒ…

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-consul-config</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
```



## æŒ‰ç…§å¦‚ä¸‹è·¯å¾„è¿›è¡Œé…ç½®æ–‡ä»¶ç¼–å†™

```
config/testApp,dev/
config/testApp/
config/application,dev/
config/application/
```

### æ–°å¢é…ç½®æ–‡ä»¶bootstrap.yml

> - application.yml	æ˜¯ç”¨æˆ·çº§çš„èµ„æºé…ç½®é¡¹
> - bootstrap.yml      ç³»ç»Ÿçº§çš„ï¼Œä¼˜å…ˆçº§æ›´é«˜

ä¸¤è€…å¯ä»¥å…±æœ‰ï¼Œç›¸åŒé…ç½®ï¼Œä¼˜å…ˆè¯»å–`bootstrap.yml`

```yml
spring:
  application:
    name: cloud-payment-service
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        service-name: ${spring.application.name}
      config:
        profile-separator: '-' # default value is ","ï¼Œwe update '-'
        format: YAML
```

Consul provides a [Key/Value Store](https://consul.io/docs/agent/http/kv.html) for storing configuration and other metadata. Spring Cloud Consul Config is an alternative to the [Config Server and Client](https://github.com/spring-cloud/spring-cloud-config). Configuration is loaded into the Spring Environment during the special "bootstrap" phase. Configuration is stored in the `/config` folder by default. Multiple `PropertySource` instances are created based on the applicationâ€™s name and the active profiles that mimics the Spring Cloud Config order of resolving properties. For example, an application with the name "testApp" and with the "dev" profile will have the following property sources created:

```
config/testApp,dev/
config/testApp/
config/application,dev/
config/application/
```

**å¤§è‡´è§£é‡Šï¼š**åœ¨consulå¯åŠ¨çš„8500é¡µé¢ä¸­ï¼ŒK/Vä¸­æ·»åŠ é…ç½®æ–‡ä»¶ï¼Œæ ¼å¼ä¸¥æ ¼éµå®ˆå¦‚ä¸Š

å› ä¸ºâ€œ-â€æ¯”â€œ,â€æ›´ç¬¦åˆä¹ æƒ¯ï¼Œå› æ­¤åœ¨bootstrap.ymlé…ç½®ä¸­å·²ç»æ›´æ¢äº†config profile-separatoråˆ†éš”ç¬¦

## åœ¨8500ç«¯å£æœåŠ¡çš„consulé¡µé¢ä¸­è¿›è¡ŒKVé…ç½®

1. å·¦ä¾§é€‰ä¸­ Key/Value

   å³ä¸Šè§’Create

   è¾“å…¥ `config/`

   **æœ‰'/'è¡¨ç¤ºåˆ›å»ºçš„æ˜¯æ–‡ä»¶å¤¹ï¼Œä¸æ˜¯æ–‡ä»¶**

2. è¿›å…¥ configç›®å½•

   ä¾æ¬¡æ–°å»º cloud-payment-service/  |   cloud-payment-service-dev   |   cloud-payment-service-prod

   cloud-payment-serviceä¸é…ç½®æ–‡ä»¶å¯¹åº”æœåŠ¡çš„application-nameç›¸åŒ

3. è¿›å…¥ cloud-payment-service ç›®å½•ï¼Œåˆ†åˆ«åˆ›å»ºdataï¼Œä¸éœ€è¦æ–œæ 

### æµ‹è¯•

```java
@Value("${server.port}")
private String port;
@Value("${chenix.info}")
private String msg;

@GetMapping("/getInfo")
public String getInfo() {
    return msg + ":" + port;
}
```



## åŠ¨æ€å˜æ›´

**éœ€æ±‚**

consulæœåŠ¡å™¨ä¸Škvä¸­çš„dataå†…å®¹å·²ç»æ”¹å˜

ä½†æ˜¯æœ¬åœ°æ²¡æœ‰ç«‹åˆ»ç”Ÿæ•ˆ

éœ€è¦å®ç°åŠ¨æ€åŠæ—¶åˆ·æ–°ï¼ŒæœåŠ¡å™¨å˜æ›´ï¼Œæœ¬åœ°ç«‹é©¬è·å–



**è§£å†³æ–¹æ¡ˆ**

`@RefreshScope`æ³¨è§£æ·»åŠ åˆ°ä¸»å¯åŠ¨ç±»

ä¸€ä¸ªä¸å»ºè®®ä¿®æ”¹çš„å‚æ•°ï¼Œåšç†è§£ä½¿ç”¨ï¼š

è¡¨ç¤ºæœåŠ¡å™¨æ›´æ–°åï¼Œç­‰å¾…å¤šä¹…ï¼Œæœ¬åœ°ä¼šåˆ·æ–°

é»˜è®¤55s

```yml
spring:
  cloud:
    consul:
      config:
        watch:
          wait-time: 1
```



### å°è¸©å‘

æå‰åœ¨æ¥å£å‰å°±é€šè¿‡@Valueè·å–äº†consulä¸Šçš„å€¼

å› æ­¤å°±ç®—ä¿®æ”¹äº†consulçš„kvå€¼ï¼Œä¹Ÿæ— æ³•å®æ—¶åˆ·æ–°

éœ€è¦å°†è¯¥å€¼æ”¾å…¥æ¥å£çš„å‚æ•°å½“ä¸­

```java
@GetMapping("/getInfo")
public String getInfo(@Value("${chenix.info}") String msg) {
    return msg + ":" + port;
}
```



# ã€waiting..ã€‘ConsulæŒä¹…åŒ–

ä¹‹å‰çš„é…ç½®ï¼Œä¸€æ—¦consulé‡å¯ï¼Œéƒ½ä¼šä½œåºŸ

å› æ­¤éœ€è¦è¿›è¡Œconsulçš„é…ç½®æŒä¹…åŒ–...

## æ•°æ®æŒä¹…åŒ–é…ç½®å¹¶æ³¨å†Œä¸ºWindowsæœåŠ¡

åœ¨consulçš„ç›®å½•ä¸­åˆ›å»ºmydataæ–‡ä»¶å¤¹

å¹¶ç¼–å†™`consul_start.bat`è„šæœ¬è¿è¡Œ

ä½¿å…¶æˆä¸ºåå°ç¨‹åºå¹¶ç»‘å®šmydataæ–‡ä»¶å¤¹è¿›è¡ŒæŒä¹…åŒ–é…ç½®çš„æœ¬åœ°å­˜å‚¨

```bash
@echo.æœåŠ¡å¯åŠ¨......  
@echo off  
@sc create Consul binpath= "[consulç›®å½•]\consul.exe agent -server -ui -bind=127.0.0.1 -client=0.0.0.0 -bootstrap-expect  1  -data-dir [mydataç›®å½•ï¼Œä¸€èˆ¬ä¸consul.exeåŒçº§]   "
@net start Consul
@sc config Consul start= AUTO  
@echo.Consul start is OK......success
@pause
```

ä»¥ç®¡ç†å‘˜è¿è¡Œ`consul_start.bat`



# LoadBalancerè´Ÿè½½å‡è¡¡æœåŠ¡è°ƒç”¨

## ä»¥å‰è´Ÿè½½å‡è¡¡æœåŠ¡è°ƒç”¨Ribbon

æ˜¯Netflix Ribbonå®ç°çš„ä¸€å¥—è´Ÿè½½å¹³è¡¡å·¥å…·

ä¸»è¦ç”¨äºæä¾›å®¢æˆ·ç«¯è½¯ä»¶è´Ÿè½½å‡è¡¡ç®—æ³•å’ŒæœåŠ¡è°ƒç”¨



## å®˜ç½‘æŸ¥çœ‹

åœ¨ `spring-cloud-commons` ä¸‹

[Cloud Native Applications (spring.io)](https://docs.spring.io/spring-cloud-commons/docs/current/reference/html/#spring-cloud-loadbalancer)



**LoadBalanceræœ¬åœ°è´Ÿè½½å‡è¡¡å®¢æˆ·ç«¯** å’Œ **NginxæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡** çš„åŒºåˆ«

- LoadBalanceræ˜¯åœ¨è°ƒç”¨å¾®æœåŠ¡æ¥å£çš„æ—¶å€™ï¼Œä¼šåœ¨æ³¨å†Œä¸­å¿ƒä¸Šè·å–æ³¨å†Œä¿¡æ¯æœåŠ¡åˆ—è¡¨ä¹‹åï¼Œç¼“å­˜åˆ°JVMæœ¬åœ°ï¼Œä»è€Œåœ¨æœ¬åœ°å®ç°RPCè¿œç¨‹æœåŠ¡è°ƒç”¨æŠ€æœ¯

  è‡ªå·±æ‰¾

- Nginxæ˜¯å®¢æˆ·ç«¯å°†æ‰€æœ‰è¯·æ±‚éƒ½äº¤ç»™Nginxï¼ŒNginxå®ç°è½¬å‘è¯·æ±‚





## LoadBalancerå·¥ä½œæ­¥éª¤

1. é€‰æ‹©Consul Serverä»æœåŠ¡ç«¯æŸ¥è¯¢å¹¶æ‹‰å–æœåŠ¡åˆ—è¡¨ï¼ŒæŸ¥è¯¢åˆ°äº†å¤šä¸ªå®ç°å®Œå…¨ä¸€æ ·çš„æœåŠ¡ã€‚

   é»˜è®¤è½®è¯¢è°ƒç”¨è°éƒ½å¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚å®¢æˆ·ç«¯è‡ªå·±é€‰ä¸€ä¸ªæœåŠ¡è¿›è¡Œè°ƒç”¨æ‰§è¡Œ

2. æŒ‰ç…§æŒ‡å®šçš„è´Ÿè½½å‡è¡¡ç­–ç•¥ä»serverå–åˆ°çš„æœåŠ¡æ³¨å†Œåˆ—è¡¨ä¸­ï¼Œç”±å®¢æˆ·ç«¯è‡ªå·±é€‰æ‹©ä¸€ä¸ªåœ°å€ã€‚

   æ‰€ä»¥Load Balanceræ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡å™¨





## æ¨¡æ‹Ÿè´Ÿè½½å‡è¡¡

- 80æ¶ˆè´¹ç«¯å¼•å…¥loadbalancerä¾èµ–

  ```xml
  <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-loadbalancer</artifactId>
  </dependency>
  ```

- 80æ¶ˆè´¹ç«¯controllerå†™å…¥getInfo

- æµè§ˆå™¨è®¿é—®80æ¶ˆè´¹ç«¯çš„getInfoï¼Œå¯ä»¥å‘ç°åœ¨8001ä¸8002ä¹‹é—´ç›¸äº’è°ƒç”¨



## DiscoveryClientè§£æ

> - getServices()ï¼šå¯ä»¥è·å–å‘ç°çš„æ‰€æœ‰æœåŠ¡
> - getInstances()ï¼šè·å–å…·ä½“çš„å®ä¾‹
> - ...

```java
@Resource
private DiscoveryClient discoveryClient;

@GetMapping("/discovery")
public String discovery() {
    List<String> services = discoveryClient.getServices();
    for (String element : services) {
        System.out.println(element);
    }

    System.out.println("===================================");

    List<ServiceInstance> instances = discoveryClient.getInstances("cloud-payment-service");
    for (ServiceInstance element : instances) {
        System.out.println(element.getServiceId() + "\t" + element.getHost() + "\t" + element.getPort() + "\t" + element.getUri());
    }

    return instances.get(0).getServiceId() + ":" + instances.get(0).getPort();
}
```

**æ‰“å°å¦‚ä¸‹ï¼š**

```bash
cloud-consumer-order
cloud-payment-service
consul
===================================
cloud-payment-service	localhost	8001	http://localhost:8001
cloud-payment-service	localhost	8002	http://localhost:8002
```



### è´Ÿè½½å‡è¡¡ç®—æ³•

restæ¥å£ç¬¬å‡ æ¬¡è¯·æ±‚æ•° % æœåŠ¡å™¨é›†ç¾¤æ€»æ•°é‡ = å®é™…è°ƒç”¨æœåŠ¡å™¨ä½ç½®ä¸‹æ ‡



## LoadBalancerç®—æ³•

### é»˜è®¤ç®—æ³•

è½®è¯¢

### ç®—æ³•åˆ‡æ¢

å¯åˆ‡æ¢å…¶ä»–é»˜è®¤ç®—æ³•ï¼šéšæœº..







# ğŸ‘† äºŒé€‰ä¸€ ğŸ‘‡ ï¼ˆä¸€èˆ¬ç”¨ ğŸ‘‡ï¼‰



# OpenFeign

> æœåŠ¡è°ƒç”¨å’Œè´Ÿè½½å‡è¡¡

## å°è®°

æœ‰é—®é¢˜ï¼Œç¿»ç¿»å®˜æ–¹æ–‡æ¡£

[spring-cloud/spring-cloud-openfeign: Support for using OpenFeign in Spring Cloud apps (github.com)](https://github.com/spring-cloud/spring-cloud-openfeign)

## æ¦‚è¿°

> - æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„WebæœåŠ¡å®¢æˆ·ç«¯
>
>
> - åªéœ€è¦åˆ›å»ºä¸€ä¸ªRestæ¥å£ï¼Œåœ¨å…¶ä¸Šæ–¹æ·»åŠ æ³¨è§£`@FeignClient`å³å¯

å¹¶ä¸”æ”¯æŒè´Ÿè½½å‡è¡¡

OpenFeignåŸºæœ¬ä¸Šå°±æ˜¯ç›®å‰ä¸ºæœåŠ¡ä¹‹é—´è°ƒç”¨çš„äº‹å®æ ‡å‡†



### OpenFeignèƒ½å¹²ä»€ä¹ˆ

ä¹‹å‰ä½¿ç”¨SpringCloud LoadBalancer + RestTemplateçš„æ—¶å€™ï¼Œåˆ©ç”¨RestTemplateå¯¹httpè¯·æ±‚çš„å°è£…å¤„ç†å½¢æˆäº†ä¸€å¥—æ¨¡æ¿åŒ–çš„è°ƒç”¨æ–¹æ³•ã€‚

å®é™…å¼€å‘ä¸­ï¼Œç”±äºå¯¹æœåŠ¡ä¾èµ–çš„è°ƒç”¨å¯èƒ½ä¸æ­¢ä¸€å¤„ï¼Œ**å¾€å¾€ä¸€ä¸ªæ¥å£ä¼šè¢«å¤šå¤„è°ƒç”¨ï¼Œé€šå¸¸ä¼šå¯¹æ¯ä¸ªå¾®æœåŠ¡è‡ªè¡Œå°è£…ä¸€äº›å®¢æˆ·ç«¯ç±»æ¥åŒ…è£…è¿™äº›ä¾èµ–å¾®æœåŠ¡çš„è°ƒç”¨ã€‚**

åœ¨OpenFeignçš„å¸®åŠ©ä¸‹ï¼Œ**åªéœ€è¦åˆ›å»ºä¸€ä¸ªæ¥å£å¹¶ä½¿ç”¨æ³¨è§£çš„æ–¹å¼æ¥é…ç½®å®ƒï¼ˆåœ¨ä¸€ä¸ªå¾®æœåŠ¡æ¥å£ä¸Šé¢æ ‡æ³¨ä¸€ä¸ª@FeignClientæ³¨è§£å³å¯ï¼‰**



åŒæ—¶OpenFeignè¿˜é›†æˆäº†SpringCloud LoadBalancer

å¯ä»¥åœ¨ä½¿ç”¨OpenFeignçš„æ—¶å€™æä¾›Httpå®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡ï¼Œä¹Ÿå¯ä»¥é›†æˆé˜¿é‡Œå·´å·´Sentinelæ¥æä¾›ç†”æ–­ã€é™çº§..åŠŸèƒ½

ä¸SpringCloud LoadBalancerä¸åŒçš„æ˜¯ï¼Œ**é€šè¿‡OpenFeignåªéœ€è¦å®šä¹‰æœåŠ¡ç»‘å®šæ¥å£ä¸”ä»¥å£°æ˜å¼çš„æ–¹æ³•ã€‚**



## OpenFeigné€šç”¨æ­¥éª¤

1. æ¥å£+æ³¨è§£

   - å¾®æœåŠ¡APIæ¥å£ + @FeignClientæ³¨è§£æ ‡ç­¾
   - æœåŠ¡æ¶ˆè´¹è€…80 -> è°ƒç”¨å«æœ‰@FeignClientæ³¨è§£çš„APIæœåŠ¡æ¥å£ -> æœåŠ¡æä¾›è€…(8001/8002)

2. æµç¨‹æ­¥éª¤

   1. å»ºModule

   2. æ”¹pomï¼ˆå†™å…¥ä¾èµ–ï¼‰

      ```xml
      <!--openfeign-->
      <dependency>
          <groupId>org.springframework.cloud</groupId>
          <artifactId>spring-cloud-starter-openfeign</artifactId>
      </dependency>
      ```

   3. å†™yml

      ```yaml
      server:
        port: 80
      spring:
        application:
          name: cloud-consumer-openfeign-order
        ####Spring Cloud Consul for Service Discovery
        cloud:
          consul:
            host: localhost
            port: 8500
            discovery:
              prefer-ip-address: true #ä¼˜å…ˆä½¿ç”¨æœåŠ¡ipè¿›è¡Œæ³¨å†Œ
              service-name: ${spring.application.name}
      ```

   4. ä¸»å¯åŠ¨ï¼ˆä¿®æ”¹å¯åŠ¨ç±»åï¼‰

      ```java
      @SpringBootApplication
      @EnableFeignClients
      public class MainOpenFeign80
      {
          public static void main(String[] args){
              SpringApplication.run(MainOpenFeign80.class,args);
          }
      }
      ```

      **PSï¼š**æ·»åŠ `@EnableFeignClients`æ³¨è§£å¼€å¯OpenFeignåŠŸèƒ½å¹¶æ¿€æ´»

      > @EnableDiscoveryClient // å‘consulæ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡
      > @EnableFeignClients // å¼€å¯OpenFeignåŠŸèƒ½å¹¶æ¿€æ´»

   5. ä¸šåŠ¡ç±»..

      - å†™å…¥api-commons

        å¼•å…¥OpenFeignä¾èµ–

        æ–°å»ºæœåŠ¡æ¥å£`PayFeignApi`ï¼Œé…ç½®`@FeignClient`æ³¨è§£
        
        ç­‰åŒäºä¸€ä¸ª å¯¹å¤–æš´éœ²æœåŠ¡ çš„ æ¸…å•
        
        æä¾›è€…å“ªäº›æœåŠ¡å¯ä»¥è¢«è°ƒç”¨ï¼Œç›´æ¥åœ¨PayFeignApiä¸­ä½œä¸ºæ¥å£ï¼ˆinterfaceï¼‰å£°æ˜å‡ºæ¥
        
        ```java
        // valueä¸­å†™æœåŠ¡åç§°ï¼ˆç›´æ¥ä»consulæ³¨å†Œä¸­å¿ƒé‡Œå¤åˆ¶ï¼‰
        @FeignClient(value = "cloud-payment-service")
        public interface PayFeignApi {
            @GetMapping("/pay/getInfo")
            public String getInfo();
            @GetMapping(value = "/pay/get/{id}")
            public ResultData<PayDTO> getPayById(@PathVariable("id") Integer id);
            @PostMapping(value = "/add")
            public ResultData<String> addPay(@RequestBody PayDTO payDTO);
        }
        ```



## OpenFeignå¯¹æ¯”RestTemplate

### æ¶ˆè´¹è€…ç«¯...

### ä»¥å‰RestTemplate

#### ç¼–å†™é…ç½®ç±»

> -config
>
> â€‹	-RestTemplateConfig.java

```java
@Configuration
public class RestTemplateConfig {
    @Bean
    @LoadBalanced
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

#### controllerä¸­å®šä¹‰URL

> -controller
>
> â€‹	-OrderController.java

```java
@RestController
@RequestMapping("/order/pay")
public class OrderController {
    public static final String PAYMENT_SRV_URL = "http://cloud-payment-service";

    @Resource
    private RestTemplate restTemplate;

    @PostMapping(value = "/add")
    public ResultData addOrder(PayDTO payDTO) {
        return restTemplate.postForObject(PAYMENT_SRV_URL + "/pay/add", payDTO, ResultData.class);
    }
    
    ...
}
```

### ç°åœ¨ä½¿ç”¨OpenFeign

#### å…¬å…±æ¥å£åŒ…ä¸­æŒ‡å®šè¿œç¨‹æœåŠ¡

> -api-commonsçš„Moduleä¸­
>
> â€‹	-apis
>
> â€‹		-PayFeignApi.java (interface)

```java
@FeignClient(value = "cloud-payment-service")
public interface PayFeignApi {
    @GetMapping("/pay/getInfo")
    public String getInfo();

    @GetMapping(value = "/pay/get/{id}")
    public ResultData<PayDTO> getPayById(@PathVariable("id") Integer id);

    @PostMapping(value = "/add")
    public ResultData<String> addPay(@RequestBody PayDTO payDTO);
}
```

### controllerä¸­è°ƒç”¨å…¬å…±æ¥å£åŒ…

> -æ¶ˆè´¹è€…åŒ…ä¸­
>
> â€‹	-controller
>
> â€‹		-OrderController.java

```java
@RestController
@RequestMapping("/feign/pay")
public class OrderController {
    @Resource
    private PayFeignApi payFeignApi;

    @PostMapping(value = "/add")
    public ResultData addOrder(PayDTO payDTO) {
        System.out.println("å‡è£…æ–°å¢");
        return payFeignApi.addPay(payDTO);
    }

    @GetMapping(value = "/mylb")
    public String getInfo(){
        System.out.println("æ¨¡æ‹ŸgetInfo");
        return payFeignApi.getInfo();
    }

    @GetMapping(value = "/get/{id}")
    public ResultData getPayById(@PathVariable("id") Integer id) {
        System.out.println("æ¨¡æ‹ŸgetById");
        return payFeignApi.getPayById(id);
    }
}
```



### æµ‹è¯•

- å¯åŠ¨8001
- å¯åŠ¨8002
- å¯åŠ¨OpenFeign80
- å› ä¸ºOpenFeignå¤©ç”Ÿæ”¯æŒè´Ÿè½½å‡è¡¡ï¼Œå› æ­¤å¯ä»¥ç›´æ¥æŸ¥çœ‹/mylbæµ‹è¯•

### æœåŠ¡è°ƒç”¨è·¯çº¿

- `FeignConsumer80`æœåŠ¡ä¸­æ³¨å…¥å…¬å…±æ¥å£ï¼ˆapi-commonsï¼‰ä¸­ï¼Œè¢«`@FeignClient`æ³¨è§£ä¿®é¥°çš„æ¥å£
- é€šè¿‡`@FeignClient`æ¥å£ä¸­çš„valueå‚æ•°ï¼Œæ‰¾åˆ°æ³¨å†Œä¸­å¿ƒconsulä¸­å¯¹åº”çš„ProvideræœåŠ¡
- é€šè¿‡è®¿é—®`FeignConsumer80`ä¸­çš„åœ°å€ï¼Œè¾—è½¬äºå…¬å…±æš´éœ²æ¥å£->å®é™…æœåŠ¡æä¾›è€…

ä¾‹å¦‚ï¼š

åœ¨åœ°å€æ è®¿é—®consumer80çš„åœ°å€ï¼š/feign/pay/get/1

ä¼šä¾æ¬¡è®¿é—®ï¼šconsumer80çš„å¯¹åº”æ–¹æ³•->å…¬å…±æ¥å£ä¸­çš„å¯¹åº”æ¥å£->@FeignClientæŒ‡å®šçš„æœåŠ¡æä¾›è€…ï¼Œå¯¹åº”æ¥å£æ–¹æ³•



## OpenFeigné«˜çº§ç‰¹æ€§

#### è¶…æ—¶æ§åˆ¶

æ¨¡æ‹Ÿè¶…æ—¶æŠ¥é”™ï¼šåœ¨è¢«è°ƒç”¨çš„æä¾›è€…æœåŠ¡å½“ä¸­ï¼Œç¼–å†™**sleepä»£ç **

```java
@Operation(summary = "æ ¹æ®IDè·å–æ”¯ä»˜è®°å½•", description = "æ ¹æ®IDæ£€ç´¢æ”¯ä»˜è®°å½•è¯¦æƒ…")
@GetMapping(value = "/get/{id}")
public ResultData<Pay> getPayById(@PathVariable("id") Integer id) {
    if (id < 0) {
        throw new RuntimeException("idä¸èƒ½ä¸ºè´Ÿæ•°");
    }
    try {
        TimeUnit.SECONDS.sleep(61);
    } catch (InterruptedException e) {
        throw new RuntimeException(e);
    }
    Pay pay = payService.getById(id);
    return ResultData.success(pay, "è·å–æ”¯ä»˜è®°å½•æˆåŠŸ");
}
```

æ­¤æ—¶è®¿é—®æ¶ˆè´¹ç«¯è°ƒç”¨çš„@FeignClientæ ‡æ³¨çš„å…¬å…±æ¥å£ï¼Œå°†è¿›å…¥å»¶æ—¶ç­‰å¾…ã€‚

å› ä¸ºè®¾ç½®çš„`sleep 61s`ï¼Œè€Œ**OpenFeigné»˜è®¤ç­‰å¾…60s**ï¼Œè¶…è¿‡åæŠ¥é”™

**ymlæ–‡ä»¶ä¸­å¼€å¯çš„é…ç½®**

```yaml
connectTimeoutï¼šè¿æ¥è¶…æ—¶æ—¶é—´
readTimeoutï¼šè¯·æ±‚å¤„ç†è¶…æ—¶æ—¶é—´
```

##### ç¤ºä¾‹å…¨å±€é…ç½®

```yaml
spring:
  cloud:
    openfeign:
      client:
        config:
          default:
            #è¿æ¥è¶…æ—¶æ—¶é—´
            connectTimeout: 3000
            #è¯»å–è¶…æ—¶æ—¶é—´
            readTimeout: 3000
```

æ­¤æ—¶è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º3s



##### æŒ‡å®šæœåŠ¡ï¼Œå•ä¸ªæœåŠ¡é…ç½®è¶…æ—¶æ—¶é—´

æŠŠä¸Šé¢é…ç½®æ–‡ä»¶ä¸­çš„defaultæ”¹æˆå¯¹åº”çš„**æœåŠ¡åç§°**

**æœåŠ¡åç§°ï¼š**ä¸å…¬å…±æ¥å£æ–‡ä»¶ä¸­çš„`@FeignClient`ä¸­çš„valueå€¼å¯¹åº”



#### é‡è¯•æœºåˆ¶

- é»˜è®¤é‡è¯•æœºåˆ¶æ˜¯å…³é—­çš„ï¼šåªè°ƒç”¨ä¸€æ¬¡å°±ç»“æŸ

- å¼€å¯RetryeråŠŸèƒ½ï¼š

  - æ–°å¢é…ç½®ç±»FeignConfigå¹¶ä¿®æ”¹Retryeré…ç½®

  - æ¶ˆè´¹è€…ç«¯

    ```java
    @Configuration
    public class FeignConfig {
        @Bean
        public Retryer myRetryer(){
            // é»˜è®¤ä¸èµ°é‡è¯•ç­–ç•¥
            return Retryer.NEVER_RETRY;
        }
    }
    ```

    ğŸ‘† é»˜è®¤é…ç½®ï¼Œè‡ªå®šä¹‰é…ç½® ğŸ‘‡

    ```java
    @Configuration
    public class FeignConfig {
        @Bean
        public Retryer myRetryer() {
    		// åˆå§‹é—´éš”æ—¶é—´100msï¼Œé‡è¯•æœ€å¤§é—´éš”æ—¶é—´1sï¼Œæœ€å¤§è¯·æ±‚æ¬¡æ•°3æ¬¡ï¼ˆç¬¬ä¸€æ¬¡è¯·æ±‚+ä¸¤æ¬¡é‡è¯•ï¼‰
            return new Retryer.Default(100, 1, 3);
        }
    }
    ```

  - æ­¤æ—¶ï¼Œå‘é€ä¸€æ¬¡ä»…å…è®¸è¶…æ—¶4sçš„è¯·æ±‚ï¼Œä¸€æ—¦è¶…æ—¶ï¼Œæœ€ç»ˆæ‰§è¡Œæ—¶é—´ä¸º12s

  - æ²¡æœ‰Feignæ—¥å¿—ï¼Œä¸èƒ½æŠŠä¸‰æ¬¡è¯·æ±‚éƒ½çœ‹åˆ°ï¼Œåªèƒ½çœ‹åˆ°ä¸€æ¬¡è¯·æ±‚è¶…æ—¶ã€‚



#### é»˜è®¤HttpClientä¿®æ”¹

> OpenFeignä¸­çš„HttpClient
>
> å¦‚æœä¸åšç‰¹æ®Šé…ç½®ï¼Œé»˜è®¤ä½¿ç”¨JDKè‡ªå¸¦çš„HttpURLConnectionå‘é€HTTPè¯·æ±‚
>
> ç”±äºé»˜è®¤çš„HttpURLConnectionæ²¡æœ‰è¿æ¥æ± ï¼Œæ€§èƒ½å’Œæ•ˆç‡éƒ½æ¯”è¾ƒä½ï¼Œå¦‚æœé‡‡ç”¨é»˜è®¤çš„ï¼Œæ€§èƒ½ä¸Šä¸æ˜¯æœ€å¥½çš„

> **å®˜æ–¹Tipsï¼š**
>
> ä» Spring Cloud OpenFeign 4 å¼€å§‹ï¼Œä¸å†æ”¯æŒ Feign Apache HttpClient 4ã€‚æˆ‘ä»¬å»ºè®®æ”¹ç”¨ Apache HttpClient 5ã€‚

##### Apache HttpClient5 pomä¾èµ–

```xml
<!-- httpclient5-->
<dependency>
    <groupId>org.apache.httpcomponents.client5</groupId>
    <artifactId>httpclient5</artifactId>
    <version>5.3</version>
</dependency>
<!-- feign-hc5-->
<dependency>
    <groupId>io.github.openfeign</groupId>
    <artifactId>feign-hc5</artifactId>
    <version>13.1</version>
</dependency>
```

##### ymlé…ç½®æ–‡ä»¶å¼€å¯hc5

```yaml
#  Apache HttpClient5 é…ç½®å¼€å¯
spring:
  cloud:
    openfeign:
      httpclient:
        hc5:
          enabled: true
```



#### è¯·æ±‚/å“åº” å‹ç¼©

æ˜¯ä»€ä¹ˆï¼Ÿ

OpenFeign æ”¯æŒå¯¹è¯·æ±‚å’Œå“åº”è¿›è¡ŒGZIPå‹ç¼©ï¼Œä»¥å‡å°‘é€šä¿¡è¿‡ç¨‹ä¸­çš„æ€§èƒ½æŸè€—

**å¼€å¯è¯·æ±‚ä¸å“åº”çš„å‹ç¼©åŠŸèƒ½é…ç½®ï¼š**

```yaml
spring.cloud.openfeign.compression.request.enabled=true
spring.cloud.openfeign.compression.response.enabled=true
```



**ç»†ç²’åº¦åŒ–è®¾ç½®**

é…ç½®å†…å®¹æŒ‡å®šçš„è¯·æ±‚æ•°æ®ç±»å‹ï¼Œè®¾ç½®è¯·æ±‚å‹ç¼©çš„å¤§å°ä¸‹é™

```yaml
spring.cloud.openfeign.compression.request.enabled=true
spring.cloud.openfeign.compression.request.mime-types=text/xml,application/xml,application/json# è§¦å‘å‹ç¼©æ•°æ®ç±»å‹
spring.cloud.openfeign.compression.request.min-request-size=2048 #æœ€å°è§¦å‘å‹ç¼©çš„å¤§å°
```



#### æ—¥å¿—æ‰“å°

**æ—¥å¿—çº§åˆ«ï¼š**

1. **NONEï¼š**é»˜è®¤ä¸æ˜¾ç¤ºä»»ä½•æ—¥å¿—
2. **BASICï¼š**ä»…è®°å½•è¯·æ±‚æ–¹æ³•ã€URLã€å“åº”çŠ¶æ€ç åŠæ‰§è¡Œæ—¶é—´
3. **HEADERSï¼š**é™¤äº†BASICä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯
4. **FULLï¼š**é™¤äº†HEADERSä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„æ­£æ–‡åŠå…ƒæ•°æ®

**å› ä¸ºé»˜è®¤æ˜¯ä¸æ˜¾ç¤ºä»»ä½•æ—¥å¿—**

éœ€è¦åœ¨FeignConfigä¸­å¼€å¯æ—¥å¿—

> -config
>
> â€‹	-FeignConfig.java

```java
@Configuration
public class FeignConfig {
    @Bean
    Logger.Level feignLoggerLevel(){
        return Logger.Level.FULL;
    }
}
```

**åœ¨application.ymlæ–‡ä»¶ä¸­å¼€å¯æ—¥å¿—**s

> å…¬å¼ï¼š `logging.level` + `å«æœ‰@FeignClientæ³¨è§£çš„å®Œæ•´å¸¦åŒ…åçš„æ¥å£å` + `debug`

ä¾‹å¦‚ï¼šç›‘æ§com.xxx.cloudä¸‹çš„apisåŒ…ä¸‹çš„PayFeignApiæ¥å£

```yaml
# feignæ—¥å¿—ä»¥ä»€ä¹ˆçº§åˆ«ç›‘æ§å“ªä¸ªæ¥å£
logging:
  level:
    com.chenix.cloud.apis.PayFeignApi: debug
```



# CircuitBreakeræ–­è·¯å™¨

> æœåŠ¡ç†”æ–­å’Œé™çº§

## Hystrixè¿›å…¥ç»´æŠ¤æ¨¡å¼...

ä»–æ˜¯ä¸€ä¸ªç”¨äºå¤„ç†åˆ†å¸ƒå¼ç³»ç»Ÿç”¨çš„**å»¶è¿Ÿ**å’Œ**å®¹é”™**çš„å¼€æºåº“

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè®¸å¤šä¾èµ–ä¸å¯é¿å…åœ°ä¼šè°ƒç”¨å¤±è´¥ï¼Œæ¯”å¦‚è¶…æ—¶ã€å¼‚å¸¸ç­‰

Hystrixèƒ½ä¿è¯åœ¨ä¸€ä¸ªä¾èµ–å‡ºé—®é¢˜çš„æƒ…å†µä¸‹ï¼Œ**ä¸ä¼šå¯¼è‡´æ•´ä½“æœåŠ¡å¤±è´¥ï¼Œé¿å…çº§è”æ•…éšœï¼Œæé«˜åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¼¹æ€§**

Hystrixåœ¨2024å·²ç»å®£å¸ƒåœæ›´ï¼Œå¹¶éšä¹‹æ¨èäº†**Resilience4j**



## æœåŠ¡é›ªå´©

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸å¯é¿å…å­˜åœ¨çš„é—®é¢˜ï¼š

å¤šä¸ªå¾®æœåŠ¡ä¹‹é—´è°ƒç”¨ï¼Œå‡è®¾**å¾®æœåŠ¡A**<u>è°ƒç”¨</u>**å¾®æœåŠ¡Bå’Œå¾®æœåŠ¡C**

**å¾®æœåŠ¡Bå’Œå¾®æœåŠ¡C**åˆè°ƒç”¨å…¶ä»–çš„å¾®æœåŠ¡ï¼Œå°±æ˜¯æ‰€è°“çš„**â€œæ‰‡å‡ºâ€**

å¦‚æœæ‰‡å‡ºçš„é“¾è·¯ä¸Šï¼ŒæŸä¸ªå¾®æœåŠ¡çš„è°ƒç”¨å“åº”æ—¶é—´è¿‡é•¿orä¸å¯ç”¨ï¼Œå¯¹å¾®æœåŠ¡Açš„è°ƒç”¨å°±ä¼šå ç”¨è¶Šæ¥è¶Šå¤šçš„ç³»ç»Ÿèµ„æº

è¿›è€Œå¼•èµ·ç³»ç»Ÿå´©æºƒï¼Œæ‰€è°“çš„â€œé›ªå´©æ•ˆåº”â€

é€šå¸¸å‘ç°ä¸€ä¸ªæ¨¡å—ä¸‹çš„æŸä¸ªå®ä¾‹å¤±è´¥åï¼Œè¿™ä¸ªæ¨¡å—è¿˜ä¼šç»§ç»­æ¥æ”¶æµé‡ï¼Œç„¶åè¿™ä¸ªæœ‰é—®é¢˜çš„æ¨¡å—è¿˜è°ƒç”¨äº†å…¶ä»–æ¨¡å—ï¼Œè¿™æ ·å°±ä¼šå‘ç”Ÿçº§è”æ•…éšœï¼Œ/ é›ªå´©



### è§£å†³æ–¹æ¡ˆ

æœ‰é—®é¢˜çš„èŠ‚ç‚¹ï¼Œå¿«é€Ÿç†”æ–­ï¼ˆå¿«é€Ÿè¿”å›å¤±è´¥å¤„ç†æˆ–è¿”å›é»˜è®¤å…œåº•æ•°æ®ã€æœåŠ¡é™çº§ã€‘ï¼‰

**â€œæ–­è·¯å™¨â€** æœ¬èº«æ˜¯ä¸€ç§å¼€å…³è£…ç½®ï¼Œå½“æŸä¸ªæœåŠ¡å•å…ƒå‘ç”Ÿæ•…éšœåï¼Œé€šè¿‡æ–­è·¯å™¨çš„æ•…éšœç›‘æ§ï¼ˆç±»ä¼¼ç†”æ–­ä¿é™©ä¸ï¼‰

å‘è°ƒç”¨æ–¹è¿”å›ä¸€ä¸ªä¸ç¬¦åˆé¢„æœŸçš„ã€å¯å¤„ç†çš„å¤‡é€‰å“åº”ï¼ˆFallBackï¼‰ï¼Œè€Œä¸æ˜¯é•¿æ—¶é—´ç­‰å¾…æˆ–æŠ›å‡ºè°ƒç”¨æ–¹æ— æ³•å¤„ç†çš„å¼‚å¸¸

> æ€»ç»“ï¼šå‡ºæ•…éšœäº†â€œä¿é™©ä¸â€è·³é—¸ï¼Œä¸çƒ§æ¯æ•´ä¸ªå®¶



## æ–­è·¯å™¨èƒ½åšçš„äº‹

- æœåŠ¡ç†”æ–­ï¼šè¾¾åˆ°æœ€å¤§æœåŠ¡è®¿é—®åï¼Œä»`CLOSEä¾›ç”µçŠ¶æ€ -> OPENè·³é—¸çŠ¶æ€`ã€‚æ­¤æ—¶è°ƒç”¨æ–¹ä¼šæ¥å—æœåŠ¡é™çº§çš„å¤„ç†ï¼Œå¹¶è¿”å›å‹å¥½çš„å…œåº•æç¤º
- æœåŠ¡é™çº§ï¼šæœåŠ¡å™¨å¿™ï¼Œè¯·ç¨åé‡è¯•...   ä¸è®©å®¢æˆ·ç«¯ç­‰å¾…ï¼Œç«‹å³è¿”å›ä¸€ä¸ªå‹å¥½æç¤ºï¼Œfallback
- æœåŠ¡é™æµï¼šç§’æ€é«˜å¹¶å‘ç­‰æ“ä½œï¼Œé¿å…ä¸€çªèœ‚è¿›æ¥ã€‚æ’é˜Ÿï¼Œ1s Nä¸ªï¼Œæœ‰åºè¿›è¡Œ
- æœåŠ¡é™æ—¶
- æœåŠ¡é¢„çƒ­
- æ¥æ”¶å®æ—¶çš„ç›‘æ§
- å…œåº•çš„å¤„ç†åŠ¨ä½œ
- ...

> `Hystrix`æ·˜æ±°ï¼Œæ›¿ä»£å“ -> `SpringCloudCircuitBreaker`ï¼ˆæä¾›å®ç°ç±»`Resilience4J` å’Œ `Spring Retry`ï¼‰



## Circuit Breaker - è§„èŒƒ

> ### Supported Implementations - å®ç°
>
> - [Resilience4J](https://github.com/resilience4j/resilience4j) -> Resilience For Java
> - [Spring Retry](https://github.com/spring-projects/spring-retry)

**Circuit Breakerçš„ç›®çš„ï¼š** ä¿æŠ¤åˆ†å¸ƒå¼ç³»ç»Ÿé¢è¯•æ•…éšœå’Œå¼‚å¸¸ï¼Œæé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œå¥å£®æ€§

å½“ä¸€ä¸ªç»„ä»¶æˆ–æœåŠ¡å‡ºç°æ•…éšœæ—¶

CircuitBreakerä¼šè¿…é€Ÿåˆ‡æ¢åˆ°å¼€æ”¾OPENçŠ¶æ€ï¼ˆä¿é™©ä¸è·³é—¸æ–­ç”µï¼‰ï¼Œé˜»æ­¢è¯·æ±‚å‘é€åˆ°è¯¥ç»„ä»¶æˆ–æœåŠ¡ä»è€Œé¿å…æ›´å¤šçš„è¯·æ±‚å‘é€åˆ°è¯¥ç»„ä½œæˆ–æœåŠ¡ã€‚

è¿™å¯ä»¥å‡å°‘å¯¹è¯¥ç»„ä»¶æˆ–æœåŠ¡çš„è´Ÿè½½ï¼Œé˜²æ­¢è¯¥ç»„ä»¶æˆ–æœåŠ¡è¿›æ­¥å´©æºƒï¼Œå¹¶ä½¿æ•´ä¸ªç³»ç»Ÿèƒ½å¤Ÿç»§ç»­æ­£å¸¸è¿è¡Œã€‚

åŒæ—¶ï¼ŒCircuitBreakerè¿˜å¯ä»¥æé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œå¥å£®æ€§ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„å„ä¸ªç»„ä»¶ä¹‹é—´è‡ªåŠ¨åˆ‡æ¢ï¼Œä»è€Œé¿å…å•ç‚¹æ•…éšœçš„é—®é¢˜ã€‚



### ä¸‰ä¸ªçŠ¶æ€

- CLOSEDï¼šé—­åˆçŠ¶æ€ï¼Œæ­£å¸¸è¿è¡Œ
- OPENï¼šå‡ºé—®é¢˜ï¼Œæ–­é—¸
- HALF_OPENï¼šåŠå¼€ï¼Œå‘å‡ ä¸ªè¯·æ±‚å°è¯•ï¼ˆæ¢è·¯ï¼‰
  - å°è¯•æˆåŠŸï¼ŒçŠ¶æ€->CLOSEDæ¢å¤æ­£å¸¸
  - å°è¯•å¤±è´¥ï¼ŒçŠ¶æ€->OPENç»§ç»­ä¿æŒæ–­é—¸çŠ¶æ€



## Resilience4J - è½»é‡çº§å®¹é”™æ¡†æ¶

CircuitBreakerä»…æ˜¯ä¸€å¥—è§„èŒƒå’Œæ¥å£ï¼ŒçœŸæ­£çš„å®ç°è€…æ˜¯Resilience4Jï¼ˆè½»é‡çº§å®¹é”™æ¡†æ¶ï¼‰



### å‡ ä¸ªæ ¸å¿ƒæ¨¡å—

> å‰ä¸‰ä¸ªé‡ç‚¹ï¼Œåä¸‰ä¸ªå‡‘æ•°

- â­resilience4j-Circuitbreaker: æ–­è·¯
- â­resilience4j-ratelimiter: é€Ÿç‡é™åˆ¶
- â­resilience4j-bulkhead: èˆ±å£
- resilience4j-retry: è‡ªåŠ¨é‡è¯•ï¼ˆåŒæ­¥orå¼‚æ­¥ï¼‰ **ï¼ˆä¸€èˆ¬è‡ªå·±å†™ï¼‰**
- resilience4j-timelimiter: è¶…æ—¶å¤„ç† **ï¼ˆæœ‰è°·æ­Œæ¡†æ¶ç”¨ï¼‰**
- resilience4j-cache: ç»“æœç¼“å­˜ **ï¼ˆè‚¯å®šç”¨redisï¼ï¼‰**



### ä¸­æ–‡æŒ‡å¯¼æ‰‹å†Œä»“åº“

[GitHub - lmhmhl/Resilience4j-Guides-Chinese: Resilience4j guides in chinese version](https://github.com/lmhmhl/Resilience4j-Guides-Chinese)



## å®æˆ˜

### ç†”æ–­ï¼ˆCircuitBreakerï¼‰ - æœåŠ¡ç†”æ–­ + æœåŠ¡é™çº§

> **æ–­è·¯å™¨çš„çŠ¶æ€**

ä¸‰ä¸ªæ™®é€šçŠ¶æ€ï¼šå…³é—­ï¼ˆCLOSEDï¼‰ã€å¼€å¯ï¼ˆOPENï¼‰ã€åŠå¼€ï¼ˆHALF_OPENï¼‰

ä¸¤ä¸ªç‰¹æ®ŠçŠ¶æ€ï¼šç¦ç”¨ï¼ˆDISABLEDï¼‰ã€å¼ºåˆ¶å¼€å¯ï¼ˆFORCED_OPENï¼‰

- ç†”æ–­å™¨å…³é—­æ—¶ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šé€šè¿‡ç†”æ–­å™¨

  - å¤±è´¥è¶…è¿‡è®¾å®šé˜ˆå€¼ï¼Œç†”æ–­å™¨ä¼šæ‰“å¼€ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»
  - ç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œç†”æ–­å™¨ä¼šä»æ‰“å¼€çŠ¶æ€è½¬æ¢åˆ°æ°å¼€çŠ¶æ€ï¼Œè¿™æ—¶ä»…æœ‰ä¸€å®šæ•°é‡é¢åº¦è¯·æ±‚ä¼šè¢«æ”¾å…¥ï¼Œé‡æ–°è®¡ç®—å¤±è´¥ç‡
  - å¦‚æœå¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼ï¼Œå˜ä¸ºæ‰“å¼€çŠ¶æ€ï¼›ä½äºé˜ˆå€¼ï¼Œå˜ä¸ºå…³é—­çŠ¶æ€

- æ–­è·¯å™¨ä½¿ç”¨æ»‘åŠ¨çª—å£å­˜å‚¨å’Œç»Ÿè®¡è°ƒç”¨çš„ç»“æœï¼Œå¯ä»¥é€‰æ‹©åŸºäºè°ƒç”¨æ•°é‡çš„æ»‘åŠ¨çª—å£oråŸºäºæ—¶é—´çš„æ»‘åŠ¨çª—å£

  - åŸºäºè®¿é—®æ•°é‡çš„æ»‘åŠ¨çª—å£ç»Ÿè®¡æœ€è¿‘Næ¬¡è°ƒç”¨çš„è¿”å›ç»“æœ COUNT_BASED
  - åŸºäºæ—¶é—´çš„æ»‘åŠ¨çª—å£ç»Ÿè®¡æœ€è¿‘Nç§’è°ƒç”¨çš„è¿”å›ç»“æœ TIME_BASED

- ä¸¤ç§ç‰¹æ®ŠçŠ¶æ€ï¼šDISALEDï¼ˆå§‹ç»ˆå…è®¸è®¿é—®ï¼‰ã€FORCED_OPENï¼ˆå§‹ç»ˆæ‹’ç»è®¿é—®ï¼‰

  - è¿™ä¸¤ä¸ªçŠ¶æ€ä¸ä¼šç”Ÿæˆç†”æ–­å™¨äº‹ä»¶ï¼ˆé™¤çŠ¶æ€è½¬æ¢å¤–ï¼‰ï¼Œå¹¶ä¸”ä¸ä¼šè®°å½•äº‹ä»¶çš„æˆåŠŸorå¤±è´¥
  - é€€å‡ºè¿™ä¸¤ä¸ªçŠ¶æ€çš„æ–¹æ³•ï¼šè§¦å‘çŠ¶æ€è½¬æ¢ or é‡ç½®ç†”æ–­å™¨

  

**æ–­è·¯å™¨é…ç½®å‚æ•°å‚è€ƒ**

| é…ç½®å±æ€§                                     | æè¿°                                                         |
| -------------------------------------------- | ------------------------------------------------------------ |
| failure-rate-threshold                       | ä»¥ç™¾åˆ†æ¯”é…ç½®å¤±è´¥ç‡å³°å€¼                                       |
| sliding-window-type                          | æ–­è·¯å™¨çš„æ»‘åŠ¨çª—å£æœŸç±»å‹ å¯ä»¥åŸºäºâ€œæ¬¡æ•°â€ï¼ˆCOUNT_BASEDï¼‰æˆ–è€…â€œæ—¶é—´â€ï¼ˆTIME_BASEDï¼‰è¿›è¡Œç†”æ–­ï¼Œé»˜è®¤æ˜¯COUNT_BASEDã€‚ |
| sliding-window-size                          | è‹¥COUNT_BASEDï¼Œåˆ™10æ¬¡è°ƒç”¨ä¸­æœ‰50%å¤±è´¥ï¼ˆå³5æ¬¡ï¼‰æ‰“å¼€ç†”æ–­æ–­è·¯å™¨ï¼› è‹¥ä¸ºTIME_BASEDåˆ™ï¼Œæ­¤æ—¶è¿˜æœ‰é¢å¤–çš„ä¸¤ä¸ªè®¾ç½®å±æ€§ï¼Œå«ä¹‰ä¸ºï¼šåœ¨Nç§’å†…ï¼ˆsliding-window-sizeï¼‰100%ï¼ˆslow-call-rate-thresholdï¼‰çš„è¯·æ±‚è¶…è¿‡Nç§’ï¼ˆslow-call-duration-thresholdï¼‰æ‰“å¼€æ–­è·¯å™¨ã€‚ |
| slowCallRateThreshold                        | ä»¥ç™¾åˆ†æ¯”çš„æ–¹å¼é…ç½®ï¼Œæ–­è·¯å™¨æŠŠè°ƒç”¨æ—¶é—´å¤§äºslowCallDurationThresholdçš„è°ƒç”¨è§†ä¸ºæ…¢è°ƒç”¨ï¼Œå½“æ…¢è°ƒç”¨æ¯”ä¾‹å¤§äºç­‰äºå³°å€¼æ—¶ï¼Œæ–­è·¯å™¨å¼€å¯ï¼Œå¹¶è¿›å…¥æœåŠ¡é™çº§ã€‚ |
| slowCallDurationThreshold                    | é…ç½®è°ƒç”¨æ—¶é—´çš„å³°å€¼ï¼Œé«˜äºè¯¥å³°å€¼çš„è§†ä¸ºæ…¢è°ƒç”¨ã€‚                 |
| permitted-number-of-calls-in-half-open-state | è¿è¡Œæ–­è·¯å™¨åœ¨HALF_OPENçŠ¶æ€ä¸‹æ—¶è¿›è¡ŒNæ¬¡è°ƒç”¨ï¼Œå¦‚æœæ•…éšœæˆ–æ…¢é€Ÿè°ƒç”¨ä»ç„¶é«˜äºé˜ˆå€¼ï¼Œæ–­è·¯å™¨å†æ¬¡è¿›å…¥æ‰“å¼€çŠ¶æ€ã€‚ |
| minimum-number-of-calls                      | åœ¨æ¯ä¸ªæ»‘åŠ¨çª—å£æœŸæ ·æœ¬æ•°ï¼Œé…ç½®æ–­è·¯å™¨è®¡ç®—é”™è¯¯ç‡æˆ–è€…æ…¢è°ƒç”¨ç‡çš„æœ€å°è°ƒç”¨æ•°ã€‚æ¯”å¦‚è®¾ç½®ä¸º5æ„å‘³ç€ï¼Œåœ¨è®¡ç®—æ•…éšœç‡ä¹‹å‰ï¼Œå¿…é¡»è‡³å°‘è°ƒç”¨5æ¬¡ã€‚å¦‚æœåªè®°å½•äº†4æ¬¡ï¼Œå³ä½¿4æ¬¡éƒ½å¤±è´¥äº†ï¼Œæ–­è·¯å™¨ä¹Ÿä¸ä¼šè¿›å…¥åˆ°æ‰“å¼€çŠ¶æ€ã€‚ |
| wait-duration-in-open-state                  | ä»OPENåˆ°HALF_OPENçŠ¶æ€éœ€è¦ç­‰å¾…çš„æ—¶é—´                          |

 

#### éœ€æ±‚æ¨¡æ‹Ÿ

- 6æ¬¡è®¿é—®ä¸­ï¼Œå½“æ‰§è¡Œæ–¹æ³•çš„å¤±è´¥ç‡è¾¾åˆ°50%æ—¶ï¼ŒCircuitBreakerå°†è¿›å…¥å¼€å¯OPENçŠ¶æ€ï¼ˆä¿é™©ä¸è·³é—¸æ–­ç”µï¼‰æ‹’ç»æ‰€æœ‰è¯·æ±‚
- ç­‰å¾…5såï¼ŒCircuitBreakerå°†è‡ªåŠ¨ä»å¼€å¯OPENçŠ¶æ€åº¦è¿‡åˆ°åŠå¼€HALF_OPENçŠ¶æ€ï¼Œå…è®¸ä¸€äº›è¯·æ±‚é€šè¿‡ä»¥æµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤æ­£å¸¸
- å¦‚è¿˜æ˜¯å¼‚å¸¸ï¼ŒCircuitBreakerå°†é‡æ–°è¿›å…¥å¼€å¯OPENçŠ¶æ€ï¼›å¦‚æ­£å¸¸ï¼Œå°†è¿›å…¥å…³é—­CLOSEé—­åˆçŠ¶æ€ï¼Œæ¢å¤æ­£å¸¸å¤„ç†è¯·æ±‚

#### ç›¸å…³é¢è¯•é¢˜

é¡¹ç›®ä¸­ç¨³å®šæ€§é—®é¢˜å¦‚ä½•è§£å†³ - ç†”æ–­ã€é™çº§...







### éš”ç¦»ï¼ˆBulk Headï¼‰



### é™æµï¼ˆRateLimiterï¼‰









