# ç‰¹åˆ«æ„Ÿè°¢

è§†é¢‘æ•™ç¨‹ï¼šhttps://www.bilibili.com/video/BV1gW421P7RD



## æ— ä¼¤é€Ÿé€šç‰ˆæœ¬

- JDK17
- Cloud 2023.0.0
- SpringBoot 3.2.0
- Cloud Alibaba 2022.0.0.0-RC2
- Maven 3.9
- MySQL 8.0



## æ³¨æ„äº‹é¡¹

å¦‚æœåŒæ—¶ä½¿ç”¨Bootå’ŒCloudï¼Œå°†ç”±Cloudæ¥å†³å®šBootçš„ç‰ˆæœ¬

### ç‰ˆæœ¬å‘å¸ƒè¯´æ˜

[Home Â· alibaba/spring-cloud-alibaba Wiki (github.com)](https://github.com/alibaba/spring-cloud-alibaba/wiki)

å·²è¿ç§»è‡³ï¼š[ç‰ˆæœ¬å‘å¸ƒè¯´æ˜ | Spring Cloud Alibaba (aliyun.com)](https://sca.aliyun.com/zh-cn/docs/2022.0.0.0/overview/version-explain)



# å¤ä¹ ä¸“ç”¨

> ç”±äºä¸ªäººç»å¸¸éš”å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œé—´æ–­æ€§å­¦ä¹ ï¼Œå› æ­¤è®°å½•å¿«é€Ÿå¤ä¹ æµç¨‹

- **æ‰“å¼€consulæ³¨å†Œä¸­å¿ƒ**

  localhost:8500

- ä¾æ¬¡å¯åŠ¨æœåŠ¡**æä¾›è€…**ï¼šcloud-payment-service-8001/8002

  è®¿é—®æµ‹è¯•ï¼šlocalhost:8001/pay/getInfo   and   localhost:8002/pay/getInfo

  ã€æ­¤å‰æ­¥éª¤ç”±Consulå®Œæˆã€‘

- å¯åŠ¨æœåŠ¡**è°ƒç”¨è€…ï¼š** cloud-consumer-openfeign-order

  è®¿é—®æµ‹è¯•ï¼šlocalhost/feign/pay/mylb

  åšäº†è´Ÿè½½å‡è¡¡ï¼Œè¿”å›ä¿¡æ¯åº”åœ¨8001å’Œ8002æ¨ªè·³

  ã€æ­¤æ­¥éª¤ç”±OpenFeignå®Œæˆã€‘

- [![pkYD56K.md.png](https://s21.ax1x.com/2024/06/06/pkYD56K.md.png)](https://imgse.com/i/pkYD56K)





















# ç®€è¿°

## ä¸ƒä¸ªå¸¸ç”¨çš„ä¸»æµç»´åº¦ï¼ˆSpring Cloud 2024ï¼‰

- **æœåŠ¡æ³¨å†Œä¸å‘ç°**

  Eurekaï¼ˆä¸æ¨èï¼‰

  Consul

  Alibaba Nacos

- **æœåŠ¡è°ƒç”¨ä¸è´Ÿè½½å‡è¡¡**

  Ribbonï¼ˆåœæ›´ï¼‰

  LoadBalancer

  OpenFeign

- **åˆ†å¸ƒå¼äº‹åŠ¡**

  Alibaba Seata

  LCN

  Hmily

- **æœåŠ¡ç†”æ–­å’Œé™çº§**

  Hystrixï¼ˆä¸å†ä½¿ç”¨ï¼‰

  Circuit Breakerï¼ˆæ–­è·¯å™¨ï¼‰

  Alibaba Sentinel

- **æœåŠ¡é“¾è·¯è¿½è¸ª**

  Sleuth + Zipkin ï¼ˆé€€å‡ºä¸­..ï¼‰

  Micrometer Tracing

- **æœåŠ¡ç½‘å…³**

  Zuulï¼ˆé€€..ï¼‰

  GateWay

- **åˆ†å¸ƒå¼é…ç½®ç®¡ç†**

  Consul

  Alibaba Nacos



## åˆ›å»ºé¡¹ç›®

- è®¾ç½®packingä¸ºpomï¼Œä»£è¡¨å…¶ä¸ºçˆ¶å·¥ç¨‹

- Mavenä½¿ç”¨`dependencyManagement`å…ƒç´ æä¾›ç®¡ç†ä»¥æ¥ç‰ˆæœ¬å·çš„æ–¹å¼

  **ä¼ é€’ä¾èµ–**

  é€šå¸¸ä¼šåœ¨ä¸€ä¸ªç»„ç»‡æˆ–é¡¹ç›®çš„æœ€é¡¶å±‚çš„çˆ¶POMä¸­çœ‹åˆ°`dependencyManagement`å…ƒç´ 

  pom.xmlä¸­çš„`dependencyManagement`å…ƒç´ ï¼Œèƒ½è®©æ‰€æœ‰å­é¡¹ç›®ä¸­å¼•ç”¨ä¸€ä¸ªä¾èµ–ï¼Œè€Œä¸æ˜¾ç¤ºçš„åˆ—å‡ºç‰ˆæœ¬å·

  Mavenä¼šæ²¿ç€çˆ¶å­å±‚æ¬¡å‘ä¸Šèµ°ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ‹¥æœ‰`dependencyManagement`å…ƒç´ çš„é¡¹ç›®ï¼Œä½¿ç”¨å…¶æŒ‡å®šçš„ç‰ˆæœ¬å·
  **å­é¡¹ç›®**ä¼šç›´æ¥ä½¿ç”¨çˆ¶ç±»çš„ç‰ˆæœ¬ï¼Œä¸éœ€è¦å†é¢å¤–å¼•å…¥ã€‚å¦‚æœéœ€è¦åˆ«çš„ç‰ˆæœ¬ï¼Œç›´æ¥åŠ å…¥versionæ ‡ç­¾å³å¯

  **ä¸ºä»€ä¹ˆä¼šçˆ†çº¢**

  åªæ˜¯å¯¹ä¾èµ–è¿›è¡Œç®¡ç†ï¼Œå¹¶ä¸å®é™…å¼•å…¥

  **è§£å†³æ–¹æ¡ˆï¼š**å–æ¶ˆ`dependencyManagement`æ ‡ç­¾ï¼Œè®©Mavenè¿›è¡Œä¾èµ–ä¸‹è½½ï¼Œå†åŠ ä¸Š`dependencyManagement`æ ‡ç­¾å³å¯

- æ‰“åŒ…å¯åŠ¨æ…¢ï¼Œå¯ä»¥å‹¾é€‰Mavenè·³è¿‡å•å…ƒæµ‹è¯•çš„æŒ‰é’®



## ä½¿ç”¨æŠ€æœ¯äº®ç‚¹

- Mapper4ï¼šç±»ä¼¼MyBatisPlusçš„ç®€ä¾¿MyBatiså¼€å‘å·¥å…·

- å¼•å…¥äº†mybatis-generatoråï¼Œç¼–å†™é…ç½®æ–‡ä»¶...

  åŒå‡»`Maven`**-**`Plugins`**-**`mybatis`**-**`generator`**-**`mybatis-generator:generate`

  å³å¯è‡ªåŠ¨ç”Ÿæˆ**entities**å’Œ**mapper** + **mapper.xml**

  



## å»ºå¾®æœåŠ¡

1. å»ºmodule
2. æ”¹pom
3. å†™yml
4. ä¸»å¯åŠ¨
5. ä¸šåŠ¡ç±»



## å°Tips

1. å¯åŠ¨ç±»ä¸Šï¼ŒåŠ `@MapperScan("com.chenix.cloud.mapper")`

   å°±å¯ä»¥ä¸ç”¨åœ¨æ¯ä¸ª`xxxMapper`ä¸Šå†™@Mapperæ³¨è§£äº†

2. ä¸æ–¹ä¾¿æš´éœ²ç»™å‰ç«¯çš„å­—æ®µï¼Œå¯ä»¥å†™ä¸€ä¸ªXxxDTOå®ä½“ç±»è¿›è¡Œæš´éœ²

   ä¸èƒ½æš´éœ²çš„å°±æ”¾åœ¨Xxx

3. mybatis-generatorå°±æ˜¯ä¸“é—¨å¿«é€Ÿç”Ÿæˆentitieså’Œmapperç”¨çš„ï¼Œå°†å…¶å¤åˆ¶ç²˜è´´åˆ°ä¸»è¦çš„é¡¹ç›®ä¸­

   ç„¶ååˆ é™¤mybatis-generatorä¸‹çš„ï¼Œé¿å…æŒ‡å‘å‡ºé”™

4. æ³¨å…¥å¯ä»¥ç”¨@Autowiredï¼Œä¹Ÿå¯ä»¥ç”¨@Resourceï¼Œçœ‹ä¸ªäººä¹ æƒ¯

   @Autowiredå®¹æ˜“è­¦å‘Š

5. å› ä¸ºç»™å‰ç«¯çœ‹çš„æ˜¯XxxDTOï¼Œå‰ç«¯ä¼ æ¥çš„XxxDTOè¦æ‹·è´åˆ°æœåŠ¡ç«¯å¤„ç†çš„Xxxä¸­

   ä½¿ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œæ‹·è´ï¼š

   ```java
   Pay pay = new Pay();
   BeanUtils.copyProperties(payDTO, pay);
   ```

6. å¼•ç”¨knife4jï¼Œè®¿é—® `ip:port/doc.html`

   ```xml
   <dependency>
       <groupId>com.github.xiaoymin</groupId>
       <artifactId>knife4j-openapi3-jakarta-spring-boot-starter</artifactId>
       <version>${knife4j.version}</version>
   </dependency>
   ```

   ```yaml
   # knife4j
   knife4j:
     enable: true
     setting:
       language: zh_cn
   # springdoc-openapié¡¹ç›®é…ç½®
   springdoc:
     swagger-ui:
       path: /swagger-ui.html
       tags-sorter: alpha
       operations-sorter: alpha
     api-docs:
       path: /v3/api-docs
     group-configs:
       - group: 'default'
         paths-to-match: '/**'
         packages-to-scan: com.chenix.cloud.controller
   ```



## è°ƒæ•´ä¸è¶³

1. æ—¶é—´æ—¥å¿—æ ¼å¼çš„ç»Ÿä¸€å’Œå®šåˆ¶æƒ…å†µï¼šé…ç½®æ–‡ä»¶æ·»åŠ æ—¶é—´æ ¼å¼åŒ–

   ```yaml
   spring:
    jackson:
           date-format: yyyy-MM-dd HH:mm:ss
              time-zone: GMT+8
   ```

   **éSpringBooté¡¹ç›®**ï¼Œå¯ä»¥åœ¨å®ä½“ç±»çš„å¯¹åº”å‚æ•°ä¸Šè¿›è¡Œè®¾ç½®

   `@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")`

2. è¿”å›ç»™å®¢æˆ·ç«¯çš„æ•°æ®ç§ç±»è¿‡å¤šï¼Œå¯å°è£…ç»Ÿä¸€çš„è¿”å›å€¼

   codeï¼Œmsgï¼Œdata å¯æ‰©å±•-timestampï¼ˆæ¥å£è°ƒç”¨æ—¶é—´ï¼‰

3. æšä¸¾æ­¥éª¤ ç½—åˆ—-æ„é€ -éå†

   **ç½—åˆ—**

   ```java
   // æ“ä½œå¤±è´¥
   RC999("999", "æ“ä½œXXXå¤±è´¥"),
   // æ“ä½œæˆåŠŸ
   RC200("200", "success"),
   // æœåŠ¡é™çº§
   RC201("201", "æœåŠ¡å¼€å¯é™çº§ä¿æŠ¤,è¯·ç¨åå†è¯•!"),
   ```

   **æ„é€ **

   ```java
   // è‡ªå®šä¹‰çŠ¶æ€ç 
   private final String code;
   // è‡ªå®šä¹‰æè¿°
   private final String message;
   ReturnCodeEnum(String code, String message) {
       this.code = code;
       this.message = message;
   }
   ```

   **éå†**

   ```java
   //éå†æšä¸¾V1
   public static ReturnCodeEnum getReturnCodeEnum(String code) {
       for (ReturnCodeEnum element : ReturnCodeEnum.values()) {
           if (element.getCode().equalsIgnoreCase(code)) {
               return element;
           }
       }
       return null;
   }
   
   //éå†æšä¸¾V2
   public static ReturnCodeEnum getReturnCodeEnumV2(String code) {
       return Arrays.stream(ReturnCodeEnum.values())
           .filter(x -> x.getCode().equalsIgnoreCase(code))
           .findFirst()
           .orElse(null);
   }
   ```

   **æµ‹è¯•**

   ```java
   System.out.println(getReturnCodeEnumV2("200"));
   System.out.println(getReturnCodeEnumV2("200").getCode());
   System.out.println(getReturnCodeEnumV2("200").getMessage());
   ```

4. æ–°å»ºç»Ÿä¸€çš„è¿”å›å¯¹è±¡

   ```java
   @Data
   @Accessors(chain = true)
   public class ResultData<T> {
       private String code;
       /**
        * ç»“æœçŠ¶æ€ ,å…·ä½“çŠ¶æ€ç å‚è§æšä¸¾ç±»ReturnCodeEnum.java
        */
       private String message;
       private T data;
       private long timestamp;
       public ResultData() {
           this.timestamp = System.currentTimeMillis();
       }
       public static <T> ResultData<T> success(T data) {
           ResultData<T> resultData = new ResultData<>();
           resultData.setCode(ReturnCodeEnum.RC200.getCode());
           resultData.setMessage(ReturnCodeEnum.RC200.getMessage());
           resultData.setData(data);
           return resultData;
       }
       public static <T> ResultData<T> fail(String code, String message) {
           ResultData<T> resultData = new ResultData<>();
           resultData.setCode(code);
           resultData.setMessage(message);
           return resultData;
       }
   }
   ```

5. å…¨å±€å¼‚å¸¸æ¥å…¥è¿”å›çš„æ ‡å‡†æ ¼å¼

   



## å°Tips V2

1. Lomboké‡Œçš„ä¸€ä¸ªæ³¨è§£ï¼š`@Accessors(chain = true)`

   ä½¿ç”¨è¯¥æ³¨è§£é…ç½®ï¼Œå½“newä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œå„ç§setæ“ä½œåï¼Œè¿”å›è¯¥å¯¹è±¡

   ```java
   Xxx xxx = new Xxx().setName("chenix").setAge(18)
   ```

   å‚è€ƒBlogï¼š[@Accessors æ³¨è§£è¯¦è§£-CSDNåšå®¢](https://blog.csdn.net/sunnyzyq/article/details/119992746)



## å°å°å¼•å…¥å¾®æœåŠ¡æ¦‚å¿µ

> Rest Templateæä¾›äº†å¤šç§ä¾¿æ·è®¿é—®è¿œç¨‹HttpæœåŠ¡çš„æ–¹æ³•ï¼Œ 
>
> æ˜¯ä¸€ç§ç®€å•ä¾¿æ·çš„è®¿é—®restfulæœåŠ¡æ¨¡æ¿ç±»ï¼Œæ˜¯Springæä¾›çš„ç”¨äºè®¿é—®RestæœåŠ¡çš„å®¢æˆ·ç«¯æ¨¡æ¿å·¥å…·é›†

### è®¢å•å¾®æœåŠ¡80å¦‚ä½•æ‰èƒ½è°ƒç”¨åˆ°æ”¯ä»˜å¾®æœåŠ¡8001ï¼Ÿ

deleteæ— æ³•è·å–è¿”å›å€¼è§£å†³æ–¹æ¡ˆï¼š[RestTemplateçš„put,deleteè¯·æ±‚æ¥æ”¶è¿”å›å€¼_resttemplate putæ–¹æ³• å“åº”-CSDNåšå®¢](https://blog.csdn.net/weixin_38373006/article/details/88849494)

**é€šè¿‡RestTemplate**

> -config
>
>  -RestTemplateConfig.java

```java
@Configuration
public class RestTemplateConfig {
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

  

> **controllerç¤ºä¾‹**
>
> - ä½¿ç”¨RestTemplate + è¿œç¨‹æœåŠ¡çš„è¿æ¥ è°ƒç”¨è¿œç¨‹æœåŠ¡æ¥å£

```java
@RestController
@RequestMapping("/order/pay")
public class OrderController {
    public static final String PAYMENT_SRV_URL = "http://localhost:8001";
    @Resource
    private RestTemplate restTemplate;

    @PostMapping(value = "/add")
    public ResultData addOrder(PayDTO payDTO) {
        return restTemplate.postForObject(PAYMENT_SRV_URL + "/pay/add", payDTO, ResultData.class);
    }

    @DeleteMapping(value = "/delete/{id}")
    public void deleteOrder(@PathVariable("id") Integer id) {
        restTemplate.delete(PAYMENT_SRV_URL + "/pay/delete/" + id, id);
    }

    @GetMapping(value = "/get/{id}")
    public ResultData getById(@PathVariable("id") Integer id) {
        return restTemplate.getForObject(PAYMENT_SRV_URL + "/pay/get/" + id, ResultData.class, id);
    }

    @PutMapping(value = "/update")
    public ResultData update(@RequestBody PayDTO payDTO) {
        System.out.println("å¤„ç†çš„æ•°æ®ï¼š" + payDTO);
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        HttpEntity<String> request = new HttpEntity<>(JSON.toJSON(payDTO).toString(), headers);
        ResponseEntity<ResultData> exchange = restTemplate.exchange(
                PAYMENT_SRV_URL + "/pay/update",
                HttpMethod.PUT,
                request,
                ResultData.class
        );
        return exchange.getBody();
    }

    @GetMapping(value = "/getAll")
    public ResultData getAll() {
        return restTemplate.getForObject(PAYMENT_SRV_URL + "/pay/all", ResultData.class);
    }
}
```



## è§‚å¯Ÿé—®é¢˜

### å…¶ä¸€ï¼ˆé‡å¤æ¨¡å—ï¼‰

**å­˜åœ¨é—®é¢˜ï¼š**orderæœåŠ¡å’ŒprovideræœåŠ¡å­˜åœ¨é‡å¤ä»£ç 

[![pFoN5GV.png](https://s21.ax1x.com/2024/03/28/pFoN5GV.png)](https://imgse.com/i/pFoN5GV)











**è§£å†³æ–¹æ¡ˆï¼š**æŠ½å–å…¬å…±éƒ¨åˆ†ï¼Œæ–°å»ºä¸€ä¸ªæœåŠ¡ï¼Œå­˜æ”¾å¯¹å¤–æš´éœ²çš„ç»„ä»¶/api/æ¥å£/å·¥å…·ç±»...

`cloud-api-commons`ï¼Œå°†å¤ç”¨æ€§é«˜çš„éƒ¨åˆ†æ”¾è¿›å»ï¼Œå¹¶è¿›è¡Œinstallæ“ä½œï¼Œæˆä¸ºä¸€ä¸ªjaråŒ…

æˆä¸ºjaråŒ…åï¼Œåœ¨å„ä¸ªæœåŠ¡ä¸­è¿›è¡Œåº”ç”¨å³å¯

### å…¶äºŒï¼ˆControllerä¸­å†™æ­»çš„ç¡¬ç¼–ç URLï¼‰

[![pFoaTHJ.png](https://s21.ax1x.com/2024/03/28/pFoaTHJ.png)](https://imgse.com/i/pFoaTHJ)





å¾®æœåŠ¡æ‰€åœ¨çš„IPåœ°å€å’Œç«¯å£å·ç¡¬ç¼–ç åˆ°è®¢å•å¾®æœåŠ¡ä¸­ï¼Œä¼šå­˜åœ¨éå¸¸å¤šçš„é—®é¢˜

ï¼ˆ1ï¼‰å¦‚æœè®¢å•å¾®æœåŠ¡å’Œæ”¯ä»˜å¾®æœåŠ¡çš„IPåœ°å€æˆ–è€…ç«¯å£å·å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™æ”¯ä»˜å¾®æœåŠ¡å°†å˜å¾—ä¸å¯ç”¨ï¼Œéœ€è¦åŒæ­¥ä¿®æ”¹è®¢å•å¾®æœåŠ¡ä¸­è°ƒç”¨æ”¯ä»˜å¾®æœåŠ¡çš„IPåœ°å€å’Œç«¯å£å·ã€‚

ï¼ˆ2ï¼‰å¦‚æœç³»ç»Ÿä¸­æä¾›äº†å¤šä¸ªè®¢å•å¾®æœåŠ¡å’Œæ”¯ä»˜å¾®æœåŠ¡ï¼Œåˆ™æ— æ³•å®ç°å¾®æœåŠ¡çš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚

ï¼ˆ3ï¼‰å¦‚æœç³»ç»Ÿéœ€è¦æ”¯æŒæ›´é«˜çš„å¹¶å‘ï¼Œéœ€è¦éƒ¨ç½²æ›´å¤šçš„è®¢å•å¾®æœåŠ¡å’Œæ”¯ä»˜å¾®æœåŠ¡ï¼Œç¡¬ç¼–ç è®¢å•å¾®æœåŠ¡åˆ™åç»­çš„ç»´æŠ¤ä¼šå˜å¾—å¼‚å¸¸å¤æ‚ã€‚ 

æ‰€ä»¥ï¼Œåœ¨å¾®æœåŠ¡å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å¼•å…¥**æœåŠ¡æ²»ç†åŠŸèƒ½**ï¼Œå®ç°å¾®æœåŠ¡ä¹‹é—´çš„åŠ¨æ€æ³¨å†Œä¸å‘ç°ï¼Œä»æ­¤åˆ»å¼€å§‹æˆ‘ä»¬æ­£å¼è¿›å…¥SpringCloudå®æˆ˜



# ConsulæœåŠ¡æ³¨å†Œä¸å‘ç°

## ä»¥å‰çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒEureka

**ä¸ºä»€ä¹ˆä¸ç”¨ï¼Ÿ**

1. åœæ›´

2. æ²¡æœ‰ä¸ä¸šåŠ¡ä»£ç è§£è€¦ï¼Œæ··ä¸ºä¸€è°ˆäº†

   ç›®æ ‡æ˜¯ä¸ºäº†å¾—åˆ°ä¸€ä¸ªå•ç‹¬éš”ç¦»å‡ºæ¥çš„ï¼Œè€Œä¸æ˜¯ä½œä¸ºå¾®æœåŠ¡çš„ä¸€éƒ¨åˆ†åµŒå…¥åˆ°ç³»ç»Ÿä¸­

3. Alibaba Nacos å´›èµ·



## å®˜ç½‘

[Consul by HashiCorp](https://www.consul.io/)

## What is Consul?

HashiCorp Consul is a service networking solution that enables teams to manage secure network connectivity between services and across on-prem and multi-cloud environments and runtimes. Consul offers service discovery, service mesh, traffic management, and automated updates to network infrastructure device. You can use these features individually or together in a single Consul deployment.

## Spring-Cloud

https://spring.io/projects/spring-cloud-consul

Spring Cloud Consul provides [Consul](http://consul.io/) integrations for Spring Boot apps through autoconfiguration and binding to the Spring Environment and other Spring programming model idioms. With a few simple annotations you can quickly enable and configure the common patterns inside your application and build large distributed systems with Hashicorpâ€™s Consul. The patterns provided include Service Discovery, Distributed Configuration and Control Bus.

## èƒ½å¹²å˜›

1. æœåŠ¡å‘ç°ï¼šæä¾›HTTPå’ŒDNSä¸¤ç§å‘ç°æ–¹å¼
2. å¥åº·æ£€æµ‹ï¼šæ”¯æŒå¤šç§æ–¹å¼ï¼ŒHTTPã€TCPã€Dockerã€Shellè„šæœ¬å®šåˆ¶åŒ–ç›‘æ§
3. KVå­˜å‚¨
4. å¤šæ•°æ®ä¸­å¿ƒ
5. å¯è§†åŒ–Webç•Œé¢

#### ç‰¹ç‚¹ï¼ˆEnï¼‰

Features of Consul

- Distributed configuration
- Service registration and discovery
- Distributed events
- Distributed locking and sessions
- Supports multiple data centers
- Built in, user-friendly user interface

## ä¸‹è½½

åœ°å€ï¼šhttps://developer.hashicorp.com/consul/install

## è§£å‹ å¹¶æŸ¥çœ‹ç‰ˆæœ¬

åœ¨è§£å‹çš„ç›®å½•ä¸‹çœ‹åˆ°consul.exeï¼Œä½¿ç”¨consul --versionæŸ¥çœ‹ç‰ˆæœ¬

```bash
D:\software\consul_1.18.1_windows_386>consul --version
Consul v1.18.1
Revision 98cb473c
Build Date 2024-03-26T21:59:08Z
Protocol 2 spoken by default, understands 2 to 3 (agent will automatically use protocol >2 when speaking to compatible agents)
```

## ä»¥å¼€å‘è€…æ¨¡å¼å¯åŠ¨

**å‘½ä»¤ï¼š**`consul agent -dev`

**è®¿é—®åœ°å€ï¼š**http://localhost:8500/

## æ‹“å±•

å¦‚ä½•çŸ¥é“å¯åŠ¨ç«¯å£ä¸º8500ï¼Ÿ

æŸ¥çœ‹Githubçš„readme

## ....

## æ³¨å…¥æœåŠ¡

### å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-consul-discovery</artifactId>
</dependency>
```

### ç¼–å†™é…ç½®æ–‡ä»¶

```yaml
spring:
  application:
    name: cloud-payment-service
  cloud:
    # consul é…ç½®
    consul:
      host: localhost
      port: 8500
      discovery:
        service-name: ${spring.application.name}
```

### ä¸»å¯åŠ¨ï¼Œæ¿€æ´»

Applicationä¸Šæ·»åŠ `@EnableDiscoverClient`

### ä¿®å¤æç¤ºè­¦å‘Š

Standard Commons Logging discovery in action with spring-jcl: please remove commons-logging.jar from classpath in order to avoid potential conflicts

è¯´ï¼Œè¯·ç§»é™¤ commons-logging.jar

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-consul-discovery</artifactId>
    <exclusions>
        <exclusion>
            <groupId>commons-logging</groupId>
            <artifactId>commons-logging</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

## è§£å†³ç¡¬ç¼–ç URL

å°†providerå’Œorderéƒ½æ³¨å…¥åˆ°æ³¨å†Œä¸­å¿ƒå

orderéƒ¨åˆ†åŸæœ¬ä½¿ç”¨çš„ç¡¬ç¼–ç 

```java
public static final String PAYMENT_SRV_URL = "http://localhost:8001";
```

å°±å¯ä»¥ä¿®æ”¹ä¸ºï¼š

**psï¼š** cloud-payment-serviceæ˜¯provideråœ¨æ³¨å†Œä¸­å¿ƒä¸Šçš„åç§°

```java
public static final String PAYMENT_SRV_URL = "http://cloud-payment-service";
```



## è§£å†³æŠ¥é”™

### é—®é¢˜

è¿è¡Œåï¼Œè®¿é—®orderç«¯çš„æ¥å£ï¼ŒæŠ¥é”™ï¼š

`java.net.UnknownHostException:cloud-payment-service`

```bash
org.springframework.web.client.ResourceAccessException: I/O error on GET request for "http://cloud-payment-service/pay/all": cloud-payment-service
...
Caused by: java.net.UnknownHostException: cloud-payment-service
```



### è§£å†³æ–¹æ¡ˆ

åœ¨**RestTemplate**å·¥å…·ç±»ä¸ŠåŠ ä¸Š`@LoadBalanced`

å› ä¸ºç”¨çš„æ˜¯**å¾®æœåŠ¡åç§°**è®¿é—®ï¼Œè¯¥æœåŠ¡åå¯èƒ½ä½œä¸ºä¸€ä¸ªé›†ç¾¤ï¼Œå…¶ä¸‹å¯èƒ½å­˜åœ¨å¤šä¸ª**å¾®æœåŠ¡**

å› æ­¤æ·»åŠ `@LoadBalanced`è¿›è¡Œè´Ÿè½½å¹³è¡¡



# ConsulæœåŠ¡é…ç½®ä¸åˆ·æ–°

å¾®æœåŠ¡æ„å‘³ç€è¦å°†å•ä½“åº”ç”¨çš„ä¸šåŠ¡æ‹†åˆ†æˆä¸€ä¸ªä¸ªå­æœåŠ¡

ç”±äºæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦å¿…è¦çš„é…ç½®ä¿¡æ¯

æ‰€ä»¥éœ€è¦ä¸€å¥—é›†ä¸­å¼ã€åŠ¨æ€çš„é…ç½®ç®¡ç†è®¾æ–½

æ¯”å¦‚æŸäº›é…ç½®æ–‡ä»¶çš„å†…å®¹å¤§éƒ¨åˆ†ç›¸åŒï¼Œå½“ä¸»æœºè¿ç§»çš„æ—¶å€™

æˆ‘ä»¬å¸Œæœ›ä¸€æ¬¡è¿ç§»ï¼Œå¤„å¤„ç”Ÿæ•ˆ



## éœ€æ±‚

é€šç”¨å…¨å±€é…ç½®ä¿¡æ¯ï¼Œç›´æ¥æ³¨å†Œåˆ°consulæœåŠ¡å™¨ï¼Œä»consulæœåŠ¡å™¨è·å–

éµå¾ªconsulé…ç½®è§„åˆ™è¦æ±‚



## å¯¼åŒ…

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-consul-config</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
```



## æŒ‰ç…§å¦‚ä¸‹è·¯å¾„è¿›è¡Œé…ç½®æ–‡ä»¶ç¼–å†™

```
config/testApp,dev/
config/testApp/
config/application,dev/
config/application/
```

### æ–°å¢é…ç½®æ–‡ä»¶bootstrap.yml

> - application.yml æ˜¯ç”¨æˆ·çº§çš„èµ„æºé…ç½®é¡¹
> - bootstrap.yml      ç³»ç»Ÿçº§çš„ï¼Œä¼˜å…ˆçº§æ›´é«˜

ä¸¤è€…å¯ä»¥å…±æœ‰ï¼Œç›¸åŒé…ç½®ï¼Œä¼˜å…ˆè¯»å–`bootstrap.yml`

```yml
spring:
  application:
    name: cloud-payment-service
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        service-name: ${spring.application.name}
      config:
        profile-separator: '-' # default value is ","ï¼Œwe update '-'
        format: YAML
```

Consul provides a [Key/Value Store](https://consul.io/docs/agent/http/kv.html) for storing configuration and other metadata. Spring Cloud Consul Config is an alternative to the [Config Server and Client](https://github.com/spring-cloud/spring-cloud-config). Configuration is loaded into the Spring Environment during the special "bootstrap" phase. Configuration is stored in the `/config` folder by default. Multiple `PropertySource` instances are created based on the applicationâ€™s name and the active profiles that mimics the Spring Cloud Config order of resolving properties. For example, an application with the name "testApp" and with the "dev" profile will have the following property sources created:

```
config/testApp,dev/
config/testApp/
config/application,dev/
config/application/
```

**å¤§è‡´è§£é‡Šï¼š**åœ¨consulå¯åŠ¨çš„8500é¡µé¢ä¸­ï¼ŒK/Vä¸­æ·»åŠ é…ç½®æ–‡ä»¶ï¼Œæ ¼å¼ä¸¥æ ¼éµå®ˆå¦‚ä¸Š

å› ä¸ºâ€œ-â€æ¯”â€œ,â€æ›´ç¬¦åˆä¹ æƒ¯ï¼Œå› æ­¤åœ¨bootstrap.ymlé…ç½®ä¸­å·²ç»æ›´æ¢äº†config profile-separatoråˆ†éš”ç¬¦

## åœ¨8500ç«¯å£æœåŠ¡çš„consulé¡µé¢ä¸­è¿›è¡ŒKVé…ç½®

1. å·¦ä¾§é€‰ä¸­ Key/Value

   å³ä¸Šè§’Create

   è¾“å…¥ `config/`

   **æœ‰'/'è¡¨ç¤ºåˆ›å»ºçš„æ˜¯æ–‡ä»¶å¤¹ï¼Œä¸æ˜¯æ–‡ä»¶**

2. è¿›å…¥ configç›®å½•

   ä¾æ¬¡æ–°å»º cloud-payment-service/  |   cloud-payment-service-dev   |   cloud-payment-service-prod

   cloud-payment-serviceä¸é…ç½®æ–‡ä»¶å¯¹åº”æœåŠ¡çš„application-nameç›¸åŒ

3. è¿›å…¥ cloud-payment-service ç›®å½•ï¼Œåˆ†åˆ«åˆ›å»ºdataï¼Œä¸éœ€è¦æ–œæ 

### æµ‹è¯•

```java
@Value("${server.port}")
private String port;
@Value("${chenix.info}")
private String msg;

@GetMapping("/getInfo")
public String getInfo() {
    return msg + ":" + port;
}
```



## åŠ¨æ€å˜æ›´

**éœ€æ±‚**

consulæœåŠ¡å™¨ä¸Škvä¸­çš„dataå†…å®¹å·²ç»æ”¹å˜

ä½†æ˜¯æœ¬åœ°æ²¡æœ‰ç«‹åˆ»ç”Ÿæ•ˆ

éœ€è¦å®ç°åŠ¨æ€åŠæ—¶åˆ·æ–°ï¼ŒæœåŠ¡å™¨å˜æ›´ï¼Œæœ¬åœ°ç«‹é©¬è·å–



**è§£å†³æ–¹æ¡ˆ**

`@RefreshScope`æ³¨è§£æ·»åŠ åˆ°ä¸»å¯åŠ¨ç±»

ä¸€ä¸ªä¸å»ºè®®ä¿®æ”¹çš„å‚æ•°ï¼Œåšç†è§£ä½¿ç”¨ï¼š

è¡¨ç¤ºæœåŠ¡å™¨æ›´æ–°åï¼Œç­‰å¾…å¤šä¹…ï¼Œæœ¬åœ°ä¼šåˆ·æ–°

é»˜è®¤55s

```yml
spring:
  cloud:
    consul:
      config:
        watch:
          wait-time: 1
```



### å°è¸©å‘

æå‰åœ¨æ¥å£å‰å°±é€šè¿‡@Valueè·å–äº†consulä¸Šçš„å€¼

å› æ­¤å°±ç®—ä¿®æ”¹äº†consulçš„kvå€¼ï¼Œä¹Ÿæ— æ³•å®æ—¶åˆ·æ–°

éœ€è¦å°†è¯¥å€¼æ”¾å…¥æ¥å£çš„å‚æ•°å½“ä¸­

```java
@GetMapping("/getInfo")
public String getInfo(@Value("${chenix.info}") String msg) {
    return msg + ":" + port;
}
```



# ã€waiting..ã€‘ConsulæŒä¹…åŒ–

ä¹‹å‰çš„é…ç½®ï¼Œä¸€æ—¦consulé‡å¯ï¼Œéƒ½ä¼šä½œåºŸ

å› æ­¤éœ€è¦è¿›è¡Œconsulçš„é…ç½®æŒä¹…åŒ–...

## æ•°æ®æŒä¹…åŒ–é…ç½®å¹¶æ³¨å†Œä¸ºWindowsæœåŠ¡

åœ¨consulçš„ç›®å½•ä¸­åˆ›å»ºmydataæ–‡ä»¶å¤¹

å¹¶ç¼–å†™`consul_start.bat`è„šæœ¬è¿è¡Œ

ä½¿å…¶æˆä¸ºåå°ç¨‹åºå¹¶ç»‘å®šmydataæ–‡ä»¶å¤¹è¿›è¡ŒæŒä¹…åŒ–é…ç½®çš„æœ¬åœ°å­˜å‚¨

```bash
@echo.æœåŠ¡å¯åŠ¨......  
@echo off  
@sc create Consul binpath= "[consulç›®å½•]\consul.exe agent -server -ui -bind=127.0.0.1 -client=0.0.0.0 -bootstrap-expect  1  -data-dir [mydataç›®å½•ï¼Œä¸€èˆ¬ä¸consul.exeåŒçº§]   "
@net start Consul
@sc config Consul start= AUTO  
@echo.Consul start is OK......success
@pause
```

ä»¥ç®¡ç†å‘˜è¿è¡Œ`consul_start.bat`



# LoadBalancerè´Ÿè½½å‡è¡¡æœåŠ¡è°ƒç”¨

## ä»¥å‰è´Ÿè½½å‡è¡¡æœåŠ¡è°ƒç”¨Ribbon

æ˜¯Netflix Ribbonå®ç°çš„ä¸€å¥—è´Ÿè½½å¹³è¡¡å·¥å…·

ä¸»è¦ç”¨äºæä¾›å®¢æˆ·ç«¯è½¯ä»¶è´Ÿè½½å‡è¡¡ç®—æ³•å’ŒæœåŠ¡è°ƒç”¨



## å®˜ç½‘æŸ¥çœ‹

åœ¨ `spring-cloud-commons` ä¸‹

[Cloud Native Applications (spring.io)](https://docs.spring.io/spring-cloud-commons/docs/current/reference/html/#spring-cloud-loadbalancer)



**LoadBalanceræœ¬åœ°è´Ÿè½½å‡è¡¡å®¢æˆ·ç«¯** å’Œ **NginxæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡** çš„åŒºåˆ«

- LoadBalanceræ˜¯åœ¨è°ƒç”¨å¾®æœåŠ¡æ¥å£çš„æ—¶å€™ï¼Œä¼šåœ¨æ³¨å†Œä¸­å¿ƒä¸Šè·å–æ³¨å†Œä¿¡æ¯æœåŠ¡åˆ—è¡¨ä¹‹åï¼Œç¼“å­˜åˆ°JVMæœ¬åœ°ï¼Œä»è€Œåœ¨æœ¬åœ°å®ç°RPCè¿œç¨‹æœåŠ¡è°ƒç”¨æŠ€æœ¯

  è‡ªå·±æ‰¾

- Nginxæ˜¯å®¢æˆ·ç«¯å°†æ‰€æœ‰è¯·æ±‚éƒ½äº¤ç»™Nginxï¼ŒNginxå®ç°è½¬å‘è¯·æ±‚





## LoadBalancerå·¥ä½œæ­¥éª¤

1. é€‰æ‹©Consul Serverä»æœåŠ¡ç«¯æŸ¥è¯¢å¹¶æ‹‰å–æœåŠ¡åˆ—è¡¨ï¼ŒæŸ¥è¯¢åˆ°äº†å¤šä¸ªå®ç°å®Œå…¨ä¸€æ ·çš„æœåŠ¡ã€‚

   é»˜è®¤è½®è¯¢è°ƒç”¨è°éƒ½å¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚å®¢æˆ·ç«¯è‡ªå·±é€‰ä¸€ä¸ªæœåŠ¡è¿›è¡Œè°ƒç”¨æ‰§è¡Œ

2. æŒ‰ç…§æŒ‡å®šçš„è´Ÿè½½å‡è¡¡ç­–ç•¥ä»serverå–åˆ°çš„æœåŠ¡æ³¨å†Œåˆ—è¡¨ä¸­ï¼Œç”±å®¢æˆ·ç«¯è‡ªå·±é€‰æ‹©ä¸€ä¸ªåœ°å€ã€‚

   æ‰€ä»¥Load Balanceræ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡å™¨





## æ¨¡æ‹Ÿè´Ÿè½½å‡è¡¡

- 80æ¶ˆè´¹ç«¯å¼•å…¥loadbalancerä¾èµ–

  ```xml
  <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-loadbalancer</artifactId>
  </dependency>
  ```

- 80æ¶ˆè´¹ç«¯controllerå†™å…¥getInfo

- æµè§ˆå™¨è®¿é—®80æ¶ˆè´¹ç«¯çš„getInfoï¼Œå¯ä»¥å‘ç°åœ¨8001ä¸8002ä¹‹é—´ç›¸äº’è°ƒç”¨



## DiscoveryClientè§£æ

> - getServices()ï¼šå¯ä»¥è·å–å‘ç°çš„æ‰€æœ‰æœåŠ¡
> - getInstances()ï¼šè·å–å…·ä½“çš„å®ä¾‹
> - ...

```java
@Resource
private DiscoveryClient discoveryClient;

@GetMapping("/discovery")
public String discovery() {
    List<String> services = discoveryClient.getServices();
    for (String element : services) {
        System.out.println(element);
    }

    System.out.println("===================================");

    List<ServiceInstance> instances = discoveryClient.getInstances("cloud-payment-service");
    for (ServiceInstance element : instances) {
        System.out.println(element.getServiceId() + "\t" + element.getHost() + "\t" + element.getPort() + "\t" + element.getUri());
    }

    return instances.get(0).getServiceId() + ":" + instances.get(0).getPort();
}
```

**æ‰“å°å¦‚ä¸‹ï¼š**

```bash
cloud-consumer-order
cloud-payment-service
consul
===================================
cloud-payment-service   localhost  8001   http://localhost:8001
cloud-payment-service   localhost  8002   http://localhost:8002
```



### è´Ÿè½½å‡è¡¡ç®—æ³•

restæ¥å£ç¬¬å‡ æ¬¡è¯·æ±‚æ•° % æœåŠ¡å™¨é›†ç¾¤æ€»æ•°é‡ = å®é™…è°ƒç”¨æœåŠ¡å™¨ä½ç½®ä¸‹æ ‡



## LoadBalancerç®—æ³•

### é»˜è®¤ç®—æ³•

è½®è¯¢

### ç®—æ³•åˆ‡æ¢

å¯åˆ‡æ¢å…¶ä»–é»˜è®¤ç®—æ³•ï¼šéšæœº..







# ğŸ‘† äºŒé€‰ä¸€ ğŸ‘‡ ï¼ˆä¸€èˆ¬ç”¨ ğŸ‘‡ï¼‰



# OpenFeign

> æœåŠ¡è°ƒç”¨å’Œè´Ÿè½½å‡è¡¡

## å°è®°

æœ‰é—®é¢˜ï¼Œç¿»ç¿»å®˜æ–¹æ–‡æ¡£

[spring-cloud/spring-cloud-openfeign: Support for using OpenFeign in Spring Cloud apps (github.com)](https://github.com/spring-cloud/spring-cloud-openfeign)

## æ¦‚è¿°

> - æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„WebæœåŠ¡å®¢æˆ·ç«¯
>
>
> - åªéœ€è¦åˆ›å»ºä¸€ä¸ªRestæ¥å£ï¼Œåœ¨å…¶ä¸Šæ–¹æ·»åŠ æ³¨è§£`@FeignClient`å³å¯

å¹¶ä¸”æ”¯æŒè´Ÿè½½å‡è¡¡

OpenFeignåŸºæœ¬ä¸Šå°±æ˜¯ç›®å‰ä¸ºæœåŠ¡ä¹‹é—´è°ƒç”¨çš„äº‹å®æ ‡å‡†



### OpenFeignèƒ½å¹²ä»€ä¹ˆ

ä¹‹å‰ä½¿ç”¨SpringCloud LoadBalancer + RestTemplateçš„æ—¶å€™ï¼Œåˆ©ç”¨RestTemplateå¯¹httpè¯·æ±‚çš„å°è£…å¤„ç†å½¢æˆäº†ä¸€å¥—æ¨¡æ¿åŒ–çš„è°ƒç”¨æ–¹æ³•ã€‚

å®é™…å¼€å‘ä¸­ï¼Œç”±äºå¯¹æœåŠ¡ä¾èµ–çš„è°ƒç”¨å¯èƒ½ä¸æ­¢ä¸€å¤„ï¼Œ**å¾€å¾€ä¸€ä¸ªæ¥å£ä¼šè¢«å¤šå¤„è°ƒç”¨ï¼Œé€šå¸¸ä¼šå¯¹æ¯ä¸ªå¾®æœåŠ¡è‡ªè¡Œå°è£…ä¸€äº›å®¢æˆ·ç«¯ç±»æ¥åŒ…è£…è¿™äº›ä¾èµ–å¾®æœåŠ¡çš„è°ƒç”¨ã€‚**

åœ¨OpenFeignçš„å¸®åŠ©ä¸‹ï¼Œ**åªéœ€è¦åˆ›å»ºä¸€ä¸ªæ¥å£å¹¶ä½¿ç”¨æ³¨è§£çš„æ–¹å¼æ¥é…ç½®å®ƒï¼ˆåœ¨ä¸€ä¸ªå¾®æœåŠ¡æ¥å£ä¸Šé¢æ ‡æ³¨ä¸€ä¸ª@FeignClientæ³¨è§£å³å¯ï¼‰**



åŒæ—¶OpenFeignè¿˜é›†æˆäº†SpringCloud LoadBalancer

å¯ä»¥åœ¨ä½¿ç”¨OpenFeignçš„æ—¶å€™æä¾›Httpå®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡ï¼Œä¹Ÿå¯ä»¥é›†æˆé˜¿é‡Œå·´å·´Sentinelæ¥æä¾›ç†”æ–­ã€é™çº§..åŠŸèƒ½

ä¸SpringCloud LoadBalancerä¸åŒçš„æ˜¯ï¼Œ**é€šè¿‡OpenFeignåªéœ€è¦å®šä¹‰æœåŠ¡ç»‘å®šæ¥å£ä¸”ä»¥å£°æ˜å¼çš„æ–¹æ³•ã€‚**



## OpenFeigné€šç”¨æ­¥éª¤

1. æ¥å£+æ³¨è§£

   - å¾®æœåŠ¡APIæ¥å£ + @FeignClientæ³¨è§£æ ‡ç­¾
   - æœåŠ¡æ¶ˆè´¹è€…80 -> è°ƒç”¨å«æœ‰@FeignClientæ³¨è§£çš„APIæœåŠ¡æ¥å£ -> æœåŠ¡æä¾›è€…(8001/8002)

2. æµç¨‹æ­¥éª¤

   1. å»ºModule

   2. æ”¹pomï¼ˆå†™å…¥ä¾èµ–ï¼‰

      ```xml
      <!--openfeign-->
      <dependency>
          <groupId>org.springframework.cloud</groupId>
          <artifactId>spring-cloud-starter-openfeign</artifactId>
      </dependency>
      ```

   3. å†™yml

      ```yaml
      server:
        port: 80
      spring:
        application:
          name: cloud-consumer-openfeign-order
        ####Spring Cloud Consul for Service Discovery
        cloud:
          consul:
            host: localhost
            port: 8500
            discovery:
              prefer-ip-address: true #ä¼˜å…ˆä½¿ç”¨æœåŠ¡ipè¿›è¡Œæ³¨å†Œ
              service-name: ${spring.application.name}
      ```

   4. ä¸»å¯åŠ¨ï¼ˆä¿®æ”¹å¯åŠ¨ç±»åï¼‰

      ```java
      @SpringBootApplication
      @EnableFeignClients
      public class MainOpenFeign80
      {
          public static void main(String[] args){
              SpringApplication.run(MainOpenFeign80.class,args);
          }
      }
      ```

      **PSï¼š**æ·»åŠ `@EnableFeignClients`æ³¨è§£å¼€å¯OpenFeignåŠŸèƒ½å¹¶æ¿€æ´»

      > @EnableDiscoveryClient // å‘consulæ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡
      > @EnableFeignClients // å¼€å¯OpenFeignåŠŸèƒ½å¹¶æ¿€æ´»

   5. ä¸šåŠ¡ç±»..

      - å†™å…¥api-commons

        å¼•å…¥OpenFeignä¾èµ–

        æ–°å»ºæœåŠ¡æ¥å£`PayFeignApi`ï¼Œé…ç½®`@FeignClient`æ³¨è§£
        
        ç­‰åŒäºä¸€ä¸ª å¯¹å¤–æš´éœ²æœåŠ¡ çš„ æ¸…å•
        
        æä¾›è€…å“ªäº›æœåŠ¡å¯ä»¥è¢«è°ƒç”¨ï¼Œç›´æ¥åœ¨PayFeignApiä¸­ä½œä¸ºæ¥å£ï¼ˆinterfaceï¼‰å£°æ˜å‡ºæ¥
        
        ```java
        // valueä¸­å†™æœåŠ¡åç§°ï¼ˆç›´æ¥ä»consulæ³¨å†Œä¸­å¿ƒé‡Œå¤åˆ¶ï¼‰
        @FeignClient(value = "cloud-payment-service")
        public interface PayFeignApi {
            @GetMapping("/pay/getInfo")
            public String getInfo();
            @GetMapping(value = "/pay/get/{id}")
            public ResultData<PayDTO> getPayById(@PathVariable("id") Integer id);
            @PostMapping(value = "/add")
            public ResultData<String> addPay(@RequestBody PayDTO payDTO);
        }
        ```



## OpenFeignå¯¹æ¯”RestTemplate

### æ¶ˆè´¹è€…ç«¯...

### ä»¥å‰RestTemplate

#### ç¼–å†™é…ç½®ç±»

> -config
>
>  -RestTemplateConfig.java

```java
@Configuration
public class RestTemplateConfig {
    @Bean
    @LoadBalanced
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

#### controllerä¸­å®šä¹‰URL

> -controller
>
>  -OrderController.java

```java
@RestController
@RequestMapping("/order/pay")
public class OrderController {
    public static final String PAYMENT_SRV_URL = "http://cloud-payment-service";

    @Resource
    private RestTemplate restTemplate;

    @PostMapping(value = "/add")
    public ResultData addOrder(PayDTO payDTO) {
        return restTemplate.postForObject(PAYMENT_SRV_URL + "/pay/add", payDTO, ResultData.class);
    }
    
    ...
}
```

### ç°åœ¨ä½¿ç”¨OpenFeign

#### å…¬å…±æ¥å£åŒ…ä¸­æŒ‡å®šè¿œç¨‹æœåŠ¡

> -api-commonsçš„Moduleä¸­
>
>  -apis
>
>     -PayFeignApi.java (interface)

```java
@FeignClient(value = "cloud-payment-service")
public interface PayFeignApi {
    @GetMapping("/pay/getInfo")
    public String getInfo();

    @GetMapping(value = "/pay/get/{id}")
    public ResultData<PayDTO> getPayById(@PathVariable("id") Integer id);

    @PostMapping(value = "/add")
    public ResultData<String> addPay(@RequestBody PayDTO payDTO);
}
```

### controllerä¸­è°ƒç”¨å…¬å…±æ¥å£åŒ…

> -æ¶ˆè´¹è€…åŒ…ä¸­
>
>  -controller
>
>     -OrderController.java

```java
@RestController
@RequestMapping("/feign/pay")
public class OrderController {
    @Resource
    private PayFeignApi payFeignApi;

    @PostMapping(value = "/add")
    public ResultData addOrder(PayDTO payDTO) {
        System.out.println("å‡è£…æ–°å¢");
        return payFeignApi.addPay(payDTO);
    }

    @GetMapping(value = "/mylb")
    public String getInfo(){
        System.out.println("æ¨¡æ‹ŸgetInfo");
        return payFeignApi.getInfo();
    }

    @GetMapping(value = "/get/{id}")
    public ResultData getPayById(@PathVariable("id") Integer id) {
        System.out.println("æ¨¡æ‹ŸgetById");
        return payFeignApi.getPayById(id);
    }
}
```



### æµ‹è¯•

- å¯åŠ¨8001
- å¯åŠ¨8002
- å¯åŠ¨OpenFeign80
- å› ä¸ºOpenFeignå¤©ç”Ÿæ”¯æŒè´Ÿè½½å‡è¡¡ï¼Œå› æ­¤å¯ä»¥ç›´æ¥æŸ¥çœ‹/mylbæµ‹è¯•

### æœåŠ¡è°ƒç”¨è·¯çº¿

- `FeignConsumer80`æœåŠ¡ä¸­æ³¨å…¥å…¬å…±æ¥å£ï¼ˆapi-commonsï¼‰ä¸­ï¼Œè¢«`@FeignClient`æ³¨è§£ä¿®é¥°çš„æ¥å£
- é€šè¿‡`@FeignClient`æ¥å£ä¸­çš„valueå‚æ•°ï¼Œæ‰¾åˆ°æ³¨å†Œä¸­å¿ƒconsulä¸­å¯¹åº”çš„ProvideræœåŠ¡
- é€šè¿‡è®¿é—®`FeignConsumer80`ä¸­çš„åœ°å€ï¼Œè¾—è½¬äºå…¬å…±æš´éœ²æ¥å£->å®é™…æœåŠ¡æä¾›è€…

ä¾‹å¦‚ï¼š

åœ¨åœ°å€æ è®¿é—®consumer80çš„åœ°å€ï¼š/feign/pay/get/1

ä¼šä¾æ¬¡è®¿é—®ï¼šconsumer80çš„å¯¹åº”æ–¹æ³•->å…¬å…±æ¥å£ä¸­çš„å¯¹åº”æ¥å£->@FeignClientæŒ‡å®šçš„æœåŠ¡æä¾›è€…ï¼Œå¯¹åº”æ¥å£æ–¹æ³•



## OpenFeigné«˜çº§ç‰¹æ€§

#### è¶…æ—¶æ§åˆ¶

æ¨¡æ‹Ÿè¶…æ—¶æŠ¥é”™ï¼šåœ¨è¢«è°ƒç”¨çš„æä¾›è€…æœåŠ¡å½“ä¸­ï¼Œç¼–å†™**sleepä»£ç **

```java
@Operation(summary = "æ ¹æ®IDè·å–æ”¯ä»˜è®°å½•", description = "æ ¹æ®IDæ£€ç´¢æ”¯ä»˜è®°å½•è¯¦æƒ…")
@GetMapping(value = "/get/{id}")
public ResultData<Pay> getPayById(@PathVariable("id") Integer id) {
    if (id < 0) {
        throw new RuntimeException("idä¸èƒ½ä¸ºè´Ÿæ•°");
    }
    try {
        TimeUnit.SECONDS.sleep(61);
    } catch (InterruptedException e) {
        throw new RuntimeException(e);
    }
    Pay pay = payService.getById(id);
    return ResultData.success(pay, "è·å–æ”¯ä»˜è®°å½•æˆåŠŸ");
}
```

æ­¤æ—¶è®¿é—®æ¶ˆè´¹ç«¯è°ƒç”¨çš„@FeignClientæ ‡æ³¨çš„å…¬å…±æ¥å£ï¼Œå°†è¿›å…¥å»¶æ—¶ç­‰å¾…ã€‚

å› ä¸ºè®¾ç½®çš„`sleep 61s`ï¼Œè€Œ**OpenFeigné»˜è®¤ç­‰å¾…60s**ï¼Œè¶…è¿‡åæŠ¥é”™

**ymlæ–‡ä»¶ä¸­å¼€å¯çš„é…ç½®**

```yaml
connectTimeoutï¼šè¿æ¥è¶…æ—¶æ—¶é—´
readTimeoutï¼šè¯·æ±‚å¤„ç†è¶…æ—¶æ—¶é—´
```

##### ç¤ºä¾‹å…¨å±€é…ç½®

```yaml
spring:
  cloud:
    openfeign:
      client:
        config:
          default:
            #è¿æ¥è¶…æ—¶æ—¶é—´
            connectTimeout: 3000
            #è¯»å–è¶…æ—¶æ—¶é—´
            readTimeout: 3000
```

æ­¤æ—¶è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º3s



##### æŒ‡å®šæœåŠ¡ï¼Œå•ä¸ªæœåŠ¡é…ç½®è¶…æ—¶æ—¶é—´

æŠŠä¸Šé¢é…ç½®æ–‡ä»¶ä¸­çš„defaultæ”¹æˆå¯¹åº”çš„**æœåŠ¡åç§°**

**æœåŠ¡åç§°ï¼š**ä¸å…¬å…±æ¥å£æ–‡ä»¶ä¸­çš„`@FeignClient`ä¸­çš„valueå€¼å¯¹åº”



#### é‡è¯•æœºåˆ¶

- é»˜è®¤é‡è¯•æœºåˆ¶æ˜¯å…³é—­çš„ï¼šåªè°ƒç”¨ä¸€æ¬¡å°±ç»“æŸ

- å¼€å¯RetryeråŠŸèƒ½ï¼š

  - æ–°å¢é…ç½®ç±»FeignConfigå¹¶ä¿®æ”¹Retryeré…ç½®

  - æ¶ˆè´¹è€…ç«¯

    ```java
    @Configuration
    public class FeignConfig {
        @Bean
        public Retryer myRetryer(){
            // é»˜è®¤ä¸èµ°é‡è¯•ç­–ç•¥
            return Retryer.NEVER_RETRY;
        }
    }
    ```

    ğŸ‘† é»˜è®¤é…ç½®ï¼Œè‡ªå®šä¹‰é…ç½® ğŸ‘‡

    ```java
    @Configuration
    public class FeignConfig {
        @Bean
        public Retryer myRetryer() {
           // åˆå§‹é—´éš”æ—¶é—´100msï¼Œé‡è¯•æœ€å¤§é—´éš”æ—¶é—´1sï¼Œæœ€å¤§è¯·æ±‚æ¬¡æ•°3æ¬¡ï¼ˆç¬¬ä¸€æ¬¡è¯·æ±‚+ä¸¤æ¬¡é‡è¯•ï¼‰
            return new Retryer.Default(100, 1, 3);
        }
    }
    ```

  - æ­¤æ—¶ï¼Œå‘é€ä¸€æ¬¡ä»…å…è®¸è¶…æ—¶4sçš„è¯·æ±‚ï¼Œä¸€æ—¦è¶…æ—¶ï¼Œæœ€ç»ˆæ‰§è¡Œæ—¶é—´ä¸º12s

  - æ²¡æœ‰Feignæ—¥å¿—ï¼Œä¸èƒ½æŠŠä¸‰æ¬¡è¯·æ±‚éƒ½çœ‹åˆ°ï¼Œåªèƒ½çœ‹åˆ°ä¸€æ¬¡è¯·æ±‚è¶…æ—¶ã€‚



#### é»˜è®¤HttpClientä¿®æ”¹

> OpenFeignä¸­çš„HttpClient
>
> å¦‚æœä¸åšç‰¹æ®Šé…ç½®ï¼Œé»˜è®¤ä½¿ç”¨JDKè‡ªå¸¦çš„HttpURLConnectionå‘é€HTTPè¯·æ±‚
>
> ç”±äºé»˜è®¤çš„HttpURLConnectionæ²¡æœ‰è¿æ¥æ± ï¼Œæ€§èƒ½å’Œæ•ˆç‡éƒ½æ¯”è¾ƒä½ï¼Œå¦‚æœé‡‡ç”¨é»˜è®¤çš„ï¼Œæ€§èƒ½ä¸Šä¸æ˜¯æœ€å¥½çš„

> **å®˜æ–¹Tipsï¼š**
>
> ä» Spring Cloud OpenFeign 4 å¼€å§‹ï¼Œä¸å†æ”¯æŒ Feign Apache HttpClient 4ã€‚æˆ‘ä»¬å»ºè®®æ”¹ç”¨ Apache HttpClient 5ã€‚

##### Apache HttpClient5 pomä¾èµ–

```xml
<!-- httpclient5-->
<dependency>
    <groupId>org.apache.httpcomponents.client5</groupId>
    <artifactId>httpclient5</artifactId>
    <version>5.3</version>
</dependency>
<!-- feign-hc5-->
<dependency>
    <groupId>io.github.openfeign</groupId>
    <artifactId>feign-hc5</artifactId>
    <version>13.1</version>
</dependency>
```

##### ymlé…ç½®æ–‡ä»¶å¼€å¯hc5

```yaml
#  Apache HttpClient5 é…ç½®å¼€å¯
spring:
  cloud:
    openfeign:
      httpclient:
        hc5:
          enabled: true
```



#### è¯·æ±‚/å“åº” å‹ç¼©

æ˜¯ä»€ä¹ˆï¼Ÿ

OpenFeign æ”¯æŒå¯¹è¯·æ±‚å’Œå“åº”è¿›è¡ŒGZIPå‹ç¼©ï¼Œä»¥å‡å°‘é€šä¿¡è¿‡ç¨‹ä¸­çš„æ€§èƒ½æŸè€—

**å¼€å¯è¯·æ±‚ä¸å“åº”çš„å‹ç¼©åŠŸèƒ½é…ç½®ï¼š**

```yaml
spring.cloud.openfeign.compression.request.enabled=true
spring.cloud.openfeign.compression.response.enabled=true
```



**ç»†ç²’åº¦åŒ–è®¾ç½®**

é…ç½®å†…å®¹æŒ‡å®šçš„è¯·æ±‚æ•°æ®ç±»å‹ï¼Œè®¾ç½®è¯·æ±‚å‹ç¼©çš„å¤§å°ä¸‹é™

```yaml
spring.cloud.openfeign.compression.request.enabled=true
spring.cloud.openfeign.compression.request.mime-types=text/xml,application/xml,application/json# è§¦å‘å‹ç¼©æ•°æ®ç±»å‹
spring.cloud.openfeign.compression.request.min-request-size=2048 #æœ€å°è§¦å‘å‹ç¼©çš„å¤§å°
```



#### æ—¥å¿—æ‰“å°

**æ—¥å¿—çº§åˆ«ï¼š**

1. **NONEï¼š**é»˜è®¤ä¸æ˜¾ç¤ºä»»ä½•æ—¥å¿—
2. **BASICï¼š**ä»…è®°å½•è¯·æ±‚æ–¹æ³•ã€URLã€å“åº”çŠ¶æ€ç åŠæ‰§è¡Œæ—¶é—´
3. **HEADERSï¼š**é™¤äº†BASICä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯
4. **FULLï¼š**é™¤äº†HEADERSä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„æ­£æ–‡åŠå…ƒæ•°æ®

**å› ä¸ºé»˜è®¤æ˜¯ä¸æ˜¾ç¤ºä»»ä½•æ—¥å¿—**

éœ€è¦åœ¨FeignConfigä¸­å¼€å¯æ—¥å¿—

> -config
>
>  -FeignConfig.java

```java
@Configuration
public class FeignConfig {
    @Bean
    Logger.Level feignLoggerLevel(){
        return Logger.Level.FULL;
    }
}
```

**åœ¨application.ymlæ–‡ä»¶ä¸­å¼€å¯æ—¥å¿—**s

> å…¬å¼ï¼š `logging.level` + `å«æœ‰@FeignClientæ³¨è§£çš„å®Œæ•´å¸¦åŒ…åçš„æ¥å£å` + `debug`

ä¾‹å¦‚ï¼šç›‘æ§com.xxx.cloudä¸‹çš„apisåŒ…ä¸‹çš„PayFeignApiæ¥å£

```yaml
# feignæ—¥å¿—ä»¥ä»€ä¹ˆçº§åˆ«ç›‘æ§å“ªä¸ªæ¥å£
logging:
  level:
    com.chenix.cloud.apis.PayFeignApi: debug
```



# CircuitBreakeræ–­è·¯å™¨

> æœåŠ¡ç†”æ–­å’Œé™çº§

## Hystrixè¿›å…¥ç»´æŠ¤æ¨¡å¼...

ä»–æ˜¯ä¸€ä¸ªç”¨äºå¤„ç†åˆ†å¸ƒå¼ç³»ç»Ÿç”¨çš„**å»¶è¿Ÿ**å’Œ**å®¹é”™**çš„å¼€æºåº“

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè®¸å¤šä¾èµ–ä¸å¯é¿å…åœ°ä¼šè°ƒç”¨å¤±è´¥ï¼Œæ¯”å¦‚è¶…æ—¶ã€å¼‚å¸¸ç­‰

Hystrixèƒ½ä¿è¯åœ¨ä¸€ä¸ªä¾èµ–å‡ºé—®é¢˜çš„æƒ…å†µä¸‹ï¼Œ**ä¸ä¼šå¯¼è‡´æ•´ä½“æœåŠ¡å¤±è´¥ï¼Œé¿å…çº§è”æ•…éšœï¼Œæé«˜åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¼¹æ€§**

Hystrixåœ¨2024å·²ç»å®£å¸ƒåœæ›´ï¼Œå¹¶éšä¹‹æ¨èäº†**Resilience4j**



## æœåŠ¡é›ªå´©

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸å¯é¿å…å­˜åœ¨çš„é—®é¢˜ï¼š

å¤šä¸ªå¾®æœåŠ¡ä¹‹é—´è°ƒç”¨ï¼Œå‡è®¾**å¾®æœåŠ¡A**<u>è°ƒç”¨</u>**å¾®æœåŠ¡Bå’Œå¾®æœåŠ¡C**

**å¾®æœåŠ¡Bå’Œå¾®æœåŠ¡C**åˆè°ƒç”¨å…¶ä»–çš„å¾®æœåŠ¡ï¼Œå°±æ˜¯æ‰€è°“çš„**â€œæ‰‡å‡ºâ€**

å¦‚æœæ‰‡å‡ºçš„é“¾è·¯ä¸Šï¼ŒæŸä¸ªå¾®æœåŠ¡çš„è°ƒç”¨å“åº”æ—¶é—´è¿‡é•¿orä¸å¯ç”¨ï¼Œå¯¹å¾®æœåŠ¡Açš„è°ƒç”¨å°±ä¼šå ç”¨è¶Šæ¥è¶Šå¤šçš„ç³»ç»Ÿèµ„æº

è¿›è€Œå¼•èµ·ç³»ç»Ÿå´©æºƒï¼Œæ‰€è°“çš„â€œé›ªå´©æ•ˆåº”â€

é€šå¸¸å‘ç°ä¸€ä¸ªæ¨¡å—ä¸‹çš„æŸä¸ªå®ä¾‹å¤±è´¥åï¼Œè¿™ä¸ªæ¨¡å—è¿˜ä¼šç»§ç»­æ¥æ”¶æµé‡ï¼Œç„¶åè¿™ä¸ªæœ‰é—®é¢˜çš„æ¨¡å—è¿˜è°ƒç”¨äº†å…¶ä»–æ¨¡å—ï¼Œè¿™æ ·å°±ä¼šå‘ç”Ÿçº§è”æ•…éšœï¼Œ/ é›ªå´©



### è§£å†³æ–¹æ¡ˆ

æœ‰é—®é¢˜çš„èŠ‚ç‚¹ï¼Œå¿«é€Ÿç†”æ–­ï¼ˆå¿«é€Ÿè¿”å›å¤±è´¥å¤„ç†æˆ–è¿”å›é»˜è®¤å…œåº•æ•°æ®ã€æœåŠ¡é™çº§ã€‘ï¼‰

**â€œæ–­è·¯å™¨â€** æœ¬èº«æ˜¯ä¸€ç§å¼€å…³è£…ç½®ï¼Œå½“æŸä¸ªæœåŠ¡å•å…ƒå‘ç”Ÿæ•…éšœåï¼Œé€šè¿‡æ–­è·¯å™¨çš„æ•…éšœç›‘æ§ï¼ˆç±»ä¼¼ç†”æ–­ä¿é™©ä¸ï¼‰

å‘è°ƒç”¨æ–¹è¿”å›ä¸€ä¸ªä¸ç¬¦åˆé¢„æœŸçš„ã€å¯å¤„ç†çš„å¤‡é€‰å“åº”ï¼ˆFallBackï¼‰ï¼Œè€Œä¸æ˜¯é•¿æ—¶é—´ç­‰å¾…æˆ–æŠ›å‡ºè°ƒç”¨æ–¹æ— æ³•å¤„ç†çš„å¼‚å¸¸

> æ€»ç»“ï¼šå‡ºæ•…éšœäº†â€œä¿é™©ä¸â€è·³é—¸ï¼Œä¸çƒ§æ¯æ•´ä¸ªå®¶



## æ–­è·¯å™¨èƒ½åšçš„äº‹

- æœåŠ¡ç†”æ–­ï¼šè¾¾åˆ°æœ€å¤§æœåŠ¡è®¿é—®åï¼Œä»`CLOSEä¾›ç”µçŠ¶æ€ -> OPENè·³é—¸çŠ¶æ€`ã€‚æ­¤æ—¶è°ƒç”¨æ–¹ä¼šæ¥å—æœåŠ¡é™çº§çš„å¤„ç†ï¼Œå¹¶è¿”å›å‹å¥½çš„å…œåº•æç¤º
- æœåŠ¡é™çº§ï¼šæœåŠ¡å™¨å¿™ï¼Œè¯·ç¨åé‡è¯•...   ä¸è®©å®¢æˆ·ç«¯ç­‰å¾…ï¼Œç«‹å³è¿”å›ä¸€ä¸ªå‹å¥½æç¤ºï¼Œfallback
- æœåŠ¡é™æµï¼šç§’æ€é«˜å¹¶å‘ç­‰æ“ä½œï¼Œé¿å…ä¸€çªèœ‚è¿›æ¥ã€‚æ’é˜Ÿï¼Œ1s Nä¸ªï¼Œæœ‰åºè¿›è¡Œ
- æœåŠ¡é™æ—¶
- æœåŠ¡é¢„çƒ­
- æ¥æ”¶å®æ—¶çš„ç›‘æ§
- å…œåº•çš„å¤„ç†åŠ¨ä½œ
- ...

> `Hystrix`æ·˜æ±°ï¼Œæ›¿ä»£å“ -> `SpringCloudCircuitBreaker`ï¼ˆæä¾›å®ç°ç±»`Resilience4J` å’Œ `Spring Retry`ï¼‰



## Circuit Breaker - è§„èŒƒ

> ### Supported Implementations - å®ç°
>
> - [Resilience4J](https://github.com/resilience4j/resilience4j) -> Resilience For Java
> - [Spring Retry](https://github.com/spring-projects/spring-retry)

**Circuit Breakerçš„ç›®çš„ï¼š** ä¿æŠ¤åˆ†å¸ƒå¼ç³»ç»Ÿé¢è¯•æ•…éšœå’Œå¼‚å¸¸ï¼Œæé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œå¥å£®æ€§

å½“ä¸€ä¸ªç»„ä»¶æˆ–æœåŠ¡å‡ºç°æ•…éšœæ—¶

CircuitBreakerä¼šè¿…é€Ÿåˆ‡æ¢åˆ°å¼€æ”¾OPENçŠ¶æ€ï¼ˆä¿é™©ä¸è·³é—¸æ–­ç”µï¼‰ï¼Œé˜»æ­¢è¯·æ±‚å‘é€åˆ°è¯¥ç»„ä»¶æˆ–æœåŠ¡ä»è€Œé¿å…æ›´å¤šçš„è¯·æ±‚å‘é€åˆ°è¯¥ç»„ä½œæˆ–æœåŠ¡ã€‚

è¿™å¯ä»¥å‡å°‘å¯¹è¯¥ç»„ä»¶æˆ–æœåŠ¡çš„è´Ÿè½½ï¼Œé˜²æ­¢è¯¥ç»„ä»¶æˆ–æœåŠ¡è¿›æ­¥å´©æºƒï¼Œå¹¶ä½¿æ•´ä¸ªç³»ç»Ÿèƒ½å¤Ÿç»§ç»­æ­£å¸¸è¿è¡Œã€‚

åŒæ—¶ï¼ŒCircuitBreakerè¿˜å¯ä»¥æé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œå¥å£®æ€§ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„å„ä¸ªç»„ä»¶ä¹‹é—´è‡ªåŠ¨åˆ‡æ¢ï¼Œä»è€Œé¿å…å•ç‚¹æ•…éšœçš„é—®é¢˜ã€‚



### ä¸‰ä¸ªçŠ¶æ€

- CLOSEDï¼šé—­åˆçŠ¶æ€ï¼Œæ­£å¸¸è¿è¡Œ
- OPENï¼šå‡ºé—®é¢˜ï¼Œæ–­é—¸
- HALF_OPENï¼šåŠå¼€ï¼Œå‘å‡ ä¸ªè¯·æ±‚å°è¯•ï¼ˆæ¢è·¯ï¼‰
  - å°è¯•æˆåŠŸï¼ŒçŠ¶æ€->CLOSEDæ¢å¤æ­£å¸¸
  - å°è¯•å¤±è´¥ï¼ŒçŠ¶æ€->OPENç»§ç»­ä¿æŒæ–­é—¸çŠ¶æ€



## Resilience4J - è½»é‡çº§å®¹é”™æ¡†æ¶

CircuitBreakerä»…æ˜¯ä¸€å¥—è§„èŒƒå’Œæ¥å£ï¼ŒçœŸæ­£çš„å®ç°è€…æ˜¯Resilience4Jï¼ˆè½»é‡çº§å®¹é”™æ¡†æ¶ï¼‰



### å‡ ä¸ªæ ¸å¿ƒæ¨¡å—

> å‰ä¸‰ä¸ªé‡ç‚¹ï¼Œåä¸‰ä¸ªå‡‘æ•°

- â­resilience4j-Circuitbreaker: æ–­è·¯
- â­resilience4j-ratelimiter: é€Ÿç‡é™åˆ¶
- â­resilience4j-bulkhead: èˆ±å£
- resilience4j-retry: è‡ªåŠ¨é‡è¯•ï¼ˆåŒæ­¥orå¼‚æ­¥ï¼‰ **ï¼ˆä¸€èˆ¬è‡ªå·±å†™ï¼‰**
- resilience4j-timelimiter: è¶…æ—¶å¤„ç† **ï¼ˆæœ‰è°·æ­Œæ¡†æ¶ç”¨ï¼‰**
- resilience4j-cache: ç»“æœç¼“å­˜ **ï¼ˆè‚¯å®šç”¨redisï¼ï¼‰**



### ä¸­æ–‡æŒ‡å¯¼æ‰‹å†Œä»“åº“

[GitHub - lmhmhl/Resilience4j-Guides-Chinese: Resilience4j guides in chinese version](https://github.com/lmhmhl/Resilience4j-Guides-Chinese)



## å®æˆ˜

### ç†”æ–­ï¼ˆCircuitBreakerï¼‰ - æœåŠ¡ç†”æ–­ + æœåŠ¡é™çº§

#### ä¸¤ç§ç†”æ–­æ–¹å¼

1. æŒ‰æ•°é‡
2. æŒ‰æ—¶é—´



> **æ–­è·¯å™¨çš„çŠ¶æ€**

ä¸‰ä¸ªæ™®é€šçŠ¶æ€ï¼šå…³é—­ï¼ˆCLOSEDï¼‰ã€å¼€å¯ï¼ˆOPENï¼‰ã€åŠå¼€ï¼ˆHALF_OPENï¼‰

ä¸¤ä¸ªç‰¹æ®ŠçŠ¶æ€ï¼šç¦ç”¨ï¼ˆDISABLEDï¼‰ã€å¼ºåˆ¶å¼€å¯ï¼ˆFORCED_OPENï¼‰

- ç†”æ–­å™¨å…³é—­æ—¶ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šé€šè¿‡ç†”æ–­å™¨

  - å¤±è´¥è¶…è¿‡è®¾å®šé˜ˆå€¼ï¼Œç†”æ–­å™¨ä¼šæ‰“å¼€ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»
  - ç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œç†”æ–­å™¨ä¼šä»æ‰“å¼€çŠ¶æ€è½¬æ¢åˆ°æ°å¼€çŠ¶æ€ï¼Œè¿™æ—¶ä»…æœ‰ä¸€å®šæ•°é‡é¢åº¦è¯·æ±‚ä¼šè¢«æ”¾å…¥ï¼Œé‡æ–°è®¡ç®—å¤±è´¥ç‡
  - å¦‚æœå¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼ï¼Œå˜ä¸ºæ‰“å¼€çŠ¶æ€ï¼›ä½äºé˜ˆå€¼ï¼Œå˜ä¸ºå…³é—­çŠ¶æ€

- æ–­è·¯å™¨ä½¿ç”¨æ»‘åŠ¨çª—å£å­˜å‚¨å’Œç»Ÿè®¡è°ƒç”¨çš„ç»“æœï¼Œå¯ä»¥é€‰æ‹©åŸºäºè°ƒç”¨æ•°é‡çš„æ»‘åŠ¨çª—å£oråŸºäºæ—¶é—´çš„æ»‘åŠ¨çª—å£

  - åŸºäºè®¿é—®æ•°é‡çš„æ»‘åŠ¨çª—å£ç»Ÿè®¡æœ€è¿‘Næ¬¡è°ƒç”¨çš„è¿”å›ç»“æœ COUNT_BASED
  - åŸºäºæ—¶é—´çš„æ»‘åŠ¨çª—å£ç»Ÿè®¡æœ€è¿‘Nç§’è°ƒç”¨çš„è¿”å›ç»“æœ TIME_BASED

- ä¸¤ç§ç‰¹æ®ŠçŠ¶æ€ï¼šDISALEDï¼ˆå§‹ç»ˆå…è®¸è®¿é—®ï¼‰ã€FORCED_OPENï¼ˆå§‹ç»ˆæ‹’ç»è®¿é—®ï¼‰

  - è¿™ä¸¤ä¸ªçŠ¶æ€ä¸ä¼šç”Ÿæˆç†”æ–­å™¨äº‹ä»¶ï¼ˆé™¤çŠ¶æ€è½¬æ¢å¤–ï¼‰ï¼Œå¹¶ä¸”ä¸ä¼šè®°å½•äº‹ä»¶çš„æˆåŠŸorå¤±è´¥
  - é€€å‡ºè¿™ä¸¤ä¸ªçŠ¶æ€çš„æ–¹æ³•ï¼šè§¦å‘çŠ¶æ€è½¬æ¢ or é‡ç½®ç†”æ–­å™¨

  

**æ–­è·¯å™¨é…ç½®å‚æ•°å‚è€ƒ**

| é…ç½®å±æ€§                                     | æè¿°                                                         |
| -------------------------------------------- | ------------------------------------------------------------ |
| failure-rate-threshold                       | ä»¥ç™¾åˆ†æ¯”é…ç½®å¤±è´¥ç‡å³°å€¼                                       |
| sliding-window-type                          | æ–­è·¯å™¨çš„æ»‘åŠ¨çª—å£æœŸç±»å‹ å¯ä»¥åŸºäºâ€œæ¬¡æ•°â€ï¼ˆCOUNT_BASEDï¼‰æˆ–è€…â€œæ—¶é—´â€ï¼ˆTIME_BASEDï¼‰è¿›è¡Œç†”æ–­ï¼Œé»˜è®¤æ˜¯COUNT_BASEDã€‚ |
| sliding-window-size                          | è‹¥COUNT_BASEDï¼Œåˆ™10æ¬¡è°ƒç”¨ä¸­æœ‰50%å¤±è´¥ï¼ˆå³5æ¬¡ï¼‰æ‰“å¼€ç†”æ–­æ–­è·¯å™¨ï¼› è‹¥ä¸ºTIME_BASEDåˆ™ï¼Œæ­¤æ—¶è¿˜æœ‰é¢å¤–çš„ä¸¤ä¸ªè®¾ç½®å±æ€§ï¼Œå«ä¹‰ä¸ºï¼šåœ¨Nç§’å†…ï¼ˆsliding-window-sizeï¼‰100%ï¼ˆslow-call-rate-thresholdï¼‰çš„è¯·æ±‚è¶…è¿‡Nç§’ï¼ˆslow-call-duration-thresholdï¼‰æ‰“å¼€æ–­è·¯å™¨ã€‚ |
| slowCallRateThreshold                        | ä»¥ç™¾åˆ†æ¯”çš„æ–¹å¼é…ç½®ï¼Œæ–­è·¯å™¨æŠŠè°ƒç”¨æ—¶é—´å¤§äºslowCallDurationThresholdçš„è°ƒç”¨è§†ä¸ºæ…¢è°ƒç”¨ï¼Œå½“æ…¢è°ƒç”¨æ¯”ä¾‹å¤§äºç­‰äºå³°å€¼æ—¶ï¼Œæ–­è·¯å™¨å¼€å¯ï¼Œå¹¶è¿›å…¥æœåŠ¡é™çº§ã€‚ |
| slowCallDurationThreshold                    | é…ç½®è°ƒç”¨æ—¶é—´çš„å³°å€¼ï¼Œé«˜äºè¯¥å³°å€¼çš„è§†ä¸ºæ…¢è°ƒç”¨ã€‚                 |
| permitted-number-of-calls-in-half-open-state | è¿è¡Œæ–­è·¯å™¨åœ¨HALF_OPENçŠ¶æ€ä¸‹æ—¶è¿›è¡ŒNæ¬¡è°ƒç”¨ï¼Œå¦‚æœæ•…éšœæˆ–æ…¢é€Ÿè°ƒç”¨ä»ç„¶é«˜äºé˜ˆå€¼ï¼Œæ–­è·¯å™¨å†æ¬¡è¿›å…¥æ‰“å¼€çŠ¶æ€ã€‚ |
| minimum-number-of-calls                      | åœ¨æ¯ä¸ªæ»‘åŠ¨çª—å£æœŸæ ·æœ¬æ•°ï¼Œé…ç½®æ–­è·¯å™¨è®¡ç®—é”™è¯¯ç‡æˆ–è€…æ…¢è°ƒç”¨ç‡çš„æœ€å°è°ƒç”¨æ•°ã€‚æ¯”å¦‚è®¾ç½®ä¸º5æ„å‘³ç€ï¼Œåœ¨è®¡ç®—æ•…éšœç‡ä¹‹å‰ï¼Œå¿…é¡»è‡³å°‘è°ƒç”¨5æ¬¡ã€‚å¦‚æœåªè®°å½•äº†4æ¬¡ï¼Œå³ä½¿4æ¬¡éƒ½å¤±è´¥äº†ï¼Œæ–­è·¯å™¨ä¹Ÿä¸ä¼šè¿›å…¥åˆ°æ‰“å¼€çŠ¶æ€ã€‚ |
| wait-duration-in-open-state                  | ä»OPENåˆ°HALF_OPENçŠ¶æ€éœ€è¦ç­‰å¾…çš„æ—¶é—´                          |

 

#### éœ€æ±‚æ¨¡æ‹Ÿ

- 6æ¬¡è®¿é—®ä¸­ï¼Œå½“æ‰§è¡Œæ–¹æ³•çš„å¤±è´¥ç‡è¾¾åˆ°50%æ—¶ï¼ŒCircuitBreakerå°†è¿›å…¥å¼€å¯OPENçŠ¶æ€ï¼ˆä¿é™©ä¸è·³é—¸æ–­ç”µï¼‰æ‹’ç»æ‰€æœ‰è¯·æ±‚
- ç­‰å¾…5såï¼ŒCircuitBreakerå°†è‡ªåŠ¨ä»å¼€å¯OPENçŠ¶æ€åº¦è¿‡åˆ°åŠå¼€HALF_OPENçŠ¶æ€ï¼Œå…è®¸ä¸€äº›è¯·æ±‚é€šè¿‡ä»¥æµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤æ­£å¸¸
- å¦‚è¿˜æ˜¯å¼‚å¸¸ï¼ŒCircuitBreakerå°†é‡æ–°è¿›å…¥å¼€å¯OPENçŠ¶æ€ï¼›å¦‚æ­£å¸¸ï¼Œå°†è¿›å…¥å…³é—­CLOSEé—­åˆçŠ¶æ€ï¼Œæ¢å¤æ­£å¸¸å¤„ç†è¯·æ±‚

#### ç›¸å…³é¢è¯•é¢˜

é¡¹ç›®ä¸­ç¨³å®šæ€§é—®é¢˜å¦‚ä½•è§£å†³ - ç†”æ–­ã€é™çº§...



#### å®æˆ˜æ¼”ç»ƒ

> ##### **è°¨è®°ï¼š**
>
> 1. ä»…å¯åŠ¨ä¸€ä¸ªæä¾›è€…é¡¹ç›®ï¼ˆå¦‚8001ï¼‰
> 2. å¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹è€…é¡¹ç›®
> 3. å¦åˆ™ï¼Œå®¹æ˜“å› è´Ÿè½½å‡è¡¡ï¼Œå› 8002ä¸­æ²¡æœ‰å¯¹åº”çš„æ¥å£ï¼Œå¯¼è‡´å¤±è´¥æ¬¡æ•°ç›´æ¥è¾¾åˆ°50%ï¼ˆæŒ‰æ¬¡æ•°æ–­è·¯ï¼‰
> 4. è§£å†³æ–¹æ¡ˆï¼š8002æ·»åŠ å¯¹åº”æ¥å£

**æœåŠ¡æä¾›è€…ä¸­æä¾›ä»£ç ï¼ˆä¼šå¯¼è‡´æ–­è·¯çš„æ–¹æ³•ï¼‰ï¼š**

```java
@RestController
public class PayCircuitController {
    //=========Resilience4j CircuitBreaker çš„ä¾‹å­
    @GetMapping(value = "/pay/circuit/{id}")
    public String myCircuit(@PathVariable("id") Integer id) {
        if (id == -4) {
            throw new RuntimeException("----circuit id ä¸èƒ½è´Ÿæ•°");
        }
        if (id == 9999) {
            try {
                TimeUnit.SECONDS.sleep(5);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        return "Hello, circuit! inputId:  " + id + " \t " + IdUtil.simpleUUID();
    }
}
```



**æš´éœ²è¯¥æ¥å£åˆ°æ³¨å†Œä¸­å¿ƒ**

```java
@FeignClient(value = "cloud-payment-service")
public interface PayFeignApi {
    @GetMapping(value = "/pay/circuit/{id}")
    public String myCircuit(@PathVariable("id") Integer id);
}
```



**ç»™æ¶ˆè´¹è€…å¼•å…¥æ–­è·¯å™¨ä¾èµ–**

```xml
<!--resilience4j-circuitbreaker-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-circuitbreaker-resilience4j</artifactId>
</dependency>
<!-- ç”±äºæ–­è·¯ä¿æŠ¤ç­‰éœ€è¦AOPå®ç°ï¼Œæ‰€ä»¥å¿…é¡»å¯¼å…¥AOPåŒ… -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
</dependency>
```



**åœ¨æ¶ˆè´¹è€…ä¸­é…ç½®circuitbreaker**

- COUNT_BASED

```yaml
# å¼€å¯circuitbreakerå’Œåˆ†ç»„æ¿€æ´» spring.cloud.openfeign.circuitbreaker.enabled
circuitbreaker:
  enabled: true
  group:
    enabled: true #æ²¡å¼€åˆ†ç»„æ°¸è¿œä¸ç”¨åˆ†ç»„çš„é…ç½®ã€‚ç²¾ç¡®ä¼˜å…ˆã€åˆ†ç»„æ¬¡ä¹‹(å¼€äº†åˆ†ç»„)ã€é»˜è®¤æœ€å
```

```yaml
# Resilience4j CircuitBreaker æŒ‰ç…§æ¬¡æ•°ï¼šCOUNT_BASED çš„ä¾‹å­
#  6æ¬¡è®¿é—®ä¸­å½“æ‰§è¡Œæ–¹æ³•çš„å¤±è´¥ç‡è¾¾åˆ°50%æ—¶CircuitBreakerå°†è¿›å…¥å¼€å¯OPENçŠ¶æ€(ä¿é™©ä¸è·³é—¸æ–­ç”µ)æ‹’ç»æ‰€æœ‰è¯·æ±‚ã€‚
#  ç­‰å¾…5ç§’åï¼ŒCircuitBreaker å°†è‡ªåŠ¨ä»å¼€å¯OPENçŠ¶æ€è¿‡æ¸¡åˆ°åŠå¼€HALF_OPENçŠ¶æ€ï¼Œå…è®¸ä¸€äº›è¯·æ±‚é€šè¿‡ä»¥æµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤æ­£å¸¸ã€‚
#  å¦‚è¿˜æ˜¯å¼‚å¸¸CircuitBreaker å°†é‡æ–°è¿›å…¥å¼€å¯OPENçŠ¶æ€ï¼›å¦‚æ­£å¸¸å°†è¿›å…¥å…³é—­CLOSEé—­åˆçŠ¶æ€æ¢å¤æ­£å¸¸å¤„ç†è¯·æ±‚ã€‚
resilience4j:
  circuitbreaker:
    configs:
      default:
        # è®¾ç½®50%çš„è°ƒç”¨å¤±è´¥æ—¶æ‰“å¼€æ–­è·¯å™¨ï¼Œè¶…è¿‡å¤±è´¥è¯·æ±‚ç™¾åˆ†â½CircuitBreakerå˜ä¸ºOPENçŠ¶æ€ã€‚
        failureRateThreshold: 50
        # æ»‘åŠ¨çª—å£çš„ç±»å‹
        slidingWindowType: COUNT_BASED
        # æ»‘åŠ¨çª—â¼çš„â¼¤â¼©é…ç½®COUNT_BASEDè¡¨ç¤º6ä¸ªè¯·æ±‚ï¼Œé…ç½®TIME_BASEDè¡¨ç¤º6ç§’
        slidingWindowSize: 6
        # æ–­è·¯å™¨è®¡ç®—å¤±è´¥ç‡æˆ–æ…¢è°ƒç”¨ç‡ä¹‹å‰æ‰€éœ€çš„æœ€å°æ ·æœ¬(æ¯ä¸ªæ»‘åŠ¨çª—å£å‘¨æœŸ)ã€‚
        # å¦‚æœminimumNumberOfCallsä¸º10ï¼Œåˆ™å¿…é¡»æœ€å°‘è®°å½•10ä¸ªæ ·æœ¬ï¼Œç„¶åæ‰èƒ½è®¡ç®—å¤±è´¥ç‡ã€‚
        # å¦‚æœåªè®°å½•äº†9æ¬¡è°ƒç”¨ï¼Œå³ä½¿æ‰€æœ‰9æ¬¡è°ƒç”¨éƒ½å¤±è´¥ï¼Œæ–­è·¯å™¨ä¹Ÿä¸ä¼šå¼€å¯ã€‚
        minimumNumberOfCalls: 6
        # æ˜¯å¦å¯ç”¨è‡ªåŠ¨ä»å¼€å¯çŠ¶æ€è¿‡æ¸¡åˆ°åŠå¼€çŠ¶æ€ï¼Œé»˜è®¤å€¼ä¸ºtrueã€‚
        # å¦‚æœå¯ç”¨ï¼ŒCircuitBreakerå°†è‡ªåŠ¨ä»å¼€å¯çŠ¶æ€è¿‡æ¸¡åˆ°åŠå¼€çŠ¶æ€ï¼Œå¹¶å…è®¸ä¸€äº›è¯·æ±‚é€šè¿‡ä»¥æµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤æ­£å¸¸
        automaticTransitionFromOpenToHalfOpenEnabled: true
        # ä»OPENåˆ°HALF_OPENçŠ¶æ€éœ€è¦ç­‰å¾…çš„æ—¶é—´
        waitDurationInOpenState: 5s
        # åŠå¼€çŠ¶æ€å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°ï¼Œé»˜è®¤å€¼ä¸º10ã€‚
        # åœ¨åŠå¼€çŠ¶æ€ä¸‹ï¼ŒCircuitBreakerå°†å…è®¸æœ€å¤špermittedNumberOfCallsInHalfOpenStateä¸ªè¯·æ±‚é€šè¿‡
        # å¦‚æœå…¶ä¸­æœ‰ä»»ä½•ä¸€ä¸ªè¯·æ±‚å¤±è´¥ï¼ŒCircuitBreakerå°†é‡æ–°è¿›å…¥å¼€å¯çŠ¶æ€ã€‚
        permittedNumberOfCallsInHalfOpenState: 2
        recordExceptions:
          - java.lang.Exception
    instances:
      cloud-payment-service:
        baseConfig: default
```

**æµ‹è¯•åœºæ™¯ï¼š**

1. ä¸åœè®¿é—®[localhost/feign/pay/circuit/11](http://localhost/feign/pay/circuit/11)ï¼Œä¸æ–­å¾—åˆ°éšæœºuuid

2. è®¿é—®ä¸¤æ¬¡[localhost/feign/pay/circuit/11](http://localhost/feign/pay/circuit/11)ï¼Œå†è®¿é—®å››æ¬¡[localhost/feign/pay/circuit/-4](http://localhost/feign/pay/circuit/-4)

   å› ä¸º-4æ˜¯æŠ¥é”™çš„ï¼Œè¶…è¿‡äº†ç™¾åˆ†ä¹‹äº”åçš„å‡ºé”™æ¦‚ç‡ï¼Œç›´æ¥æœåŠ¡ç†”æ–­

   5såï¼Œå°†åŠå¼€æµ‹è¯•ï¼Œåˆ¤æ–­æœ€ç»ˆæ˜¯å¦æ¢å¤

   



- TIME_BASED

```yaml
resilience4j:
  timelimiter:
    configs:
      default:
        timeout-duration: 10s #ç¥å‘çš„ä½ç½®ï¼Œtimelimiter é»˜è®¤é™åˆ¶è¿œç¨‹1sï¼Œè¶…äº1så°±è¶…æ—¶å¼‚å¸¸ï¼Œé…ç½®äº†é™çº§ï¼Œå°±èµ°é™çº§é€»è¾‘
  circuitbreaker:
    configs:
      default:
        failureRateThreshold: 50 #è®¾ç½®50%çš„è°ƒç”¨å¤±è´¥æ—¶æ‰“å¼€æ–­è·¯å™¨ï¼Œè¶…è¿‡å¤±è´¥è¯·æ±‚ç™¾åˆ†â½CircuitBreakerå˜ä¸ºOPENçŠ¶æ€ã€‚
        slowCallDurationThreshold: 2s #æ…¢è°ƒç”¨æ—¶é—´é˜ˆå€¼ï¼Œé«˜äºè¿™ä¸ªé˜ˆå€¼çš„è§†ä¸ºæ…¢è°ƒç”¨å¹¶å¢åŠ æ…¢è°ƒç”¨æ¯”ä¾‹ã€‚
        slowCallRateThreshold: 30 #æ…¢è°ƒç”¨ç™¾åˆ†æ¯”å³°å€¼ï¼Œæ–­è·¯å™¨æŠŠè°ƒç”¨æ—¶é—´â¼¤äºslowCallDurationThresholdï¼Œè§†ä¸ºæ…¢è°ƒç”¨ï¼Œå½“æ…¢è°ƒç”¨æ¯”ä¾‹é«˜äºé˜ˆå€¼ï¼Œæ–­è·¯å™¨æ‰“å¼€ï¼Œå¹¶å¼€å¯æœåŠ¡é™çº§
        slidingWindowType: TIME_BASED # æ»‘åŠ¨çª—å£çš„ç±»å‹
        slidingWindowSize: 2 #æ»‘åŠ¨çª—å£çš„å¤§å°é…ç½®ï¼Œé…ç½®TIME_BASEDè¡¨ç¤º2ç§’
        minimumNumberOfCalls: 2 #æ–­è·¯å™¨è®¡ç®—å¤±è´¥ç‡æˆ–æ…¢è°ƒç”¨ç‡ä¹‹å‰æ‰€éœ€çš„æœ€å°æ ·æœ¬(æ¯ä¸ªæ»‘åŠ¨çª—å£å‘¨æœŸ)ã€‚
        permittedNumberOfCallsInHalfOpenState: 2 #åŠå¼€çŠ¶æ€å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°ï¼Œé»˜è®¤å€¼ä¸º10ã€‚
        waitDurationInOpenState: 5s #ä»OPENåˆ°HALF_OPENçŠ¶æ€éœ€è¦ç­‰å¾…çš„æ—¶é—´
        recordExceptions:
          - java.lang.Exception
    instances:
      cloud-payment-service:
        baseConfig: default
```

**æµ‹è¯•åœºæ™¯ï¼š**

1. è¿ç»­å››ä¸ªé¡µé¢è®¿é—®[localhost/feign/pay/circuit/9999](http://localhost/feign/pay/circuit/9999)ï¼Œä¼šå»¶è¿Ÿ5s

2. å†æ¬¡è®¿é—®/11ï¼Œä¼šæœåŠ¡é™çº§ï¼Œå› ä¸ºè¶…è¿‡50%çš„è®¿é—®è®°å½•è¶…æ—¶äº†

   ç­‰å¾…5såæ¢å¤æ­£å¸¸



**æ¶ˆè´¹è€…ç«¯ä½¿ç”¨æ–­è·¯å™¨**

- @CircuitBreakerï¼šä½¿ç”¨æ–­è·¯å™¨
  - nameï¼šæŒ‡å®šä½¿ç”¨é…ç½®
  - fallbackMethodï¼šæŒ‡å®šå›è°ƒæ–¹æ³•

```java
@GetMapping(value = "/feign/pay/circuit/{id}")
@CircuitBreaker(name = "cloud-payment-service", fallbackMethod = "myCircuitFallback")
public String myCircuitBreaker(@PathVariable("id") Integer id){
    return payFeignApi.myCircuit(id);
}

//myCircuitFallbackå°±æ˜¯æœåŠ¡é™çº§åçš„å…œåº•å¤„ç†æ–¹æ³•
public String myCircuitFallback(Integer id,Throwable t) {
    // è¿™é‡Œæ˜¯å®¹é”™å¤„ç†é€»è¾‘ï¼Œè¿”å›å¤‡ç”¨ç»“æœ
    return id + ",myCircuitFallbackï¼Œç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•-----/(ã„’oã„’)/~~";
}
```



### éš”ç¦»ï¼ˆBulk Headï¼‰

- é™å¹¶å‘
- ä¾èµ–éš”ç¦»&è´Ÿè½½ä¿æŠ¤ï¼šç”¨æ¥é™åˆ¶å¯¹äºä¸‹æ¸¸æœåŠ¡çš„æœ€å¤§å¹¶å‘æ•°é‡çš„é™åˆ¶

#### ä¸¤ç§éš”ç¦»å®ç°æ–¹å¼ï¼š

- SemaphoreBulkhead(ä¿¡å·é‡èˆ±å£ï¼‰
- FixedThreadPoolBulkhead(å›ºå®šçº¿ç¨‹æ± èˆ±å£ï¼‰



#### èˆ±å£ä¾èµ–

```xml
<!--resilience4j-bulkhead-->
<dependency>
    <groupId>io.github.resilience4j</groupId>
    <artifactId>resilience4j-bulkhead</artifactId>
</dependency>
```



#### æä¾›è€…æ–°å¢æ¥å£

8001å’Œ8002éƒ½æ–°å¢ï¼Œå¦åˆ™è´Ÿè½½å‡è¡¡ä¼šå¯¼è‡´é”™è¯¯åˆ¤æ–­æœ‰é—®é¢˜

```java
@RestController
@Slf4j
public class PayBulkheadController {
    @GetMapping(value = "/pay/bulkhead/{id}")
    public String myBulkhead(@PathVariable("id") Integer id) {
        if (id == -4) {
            throw new RuntimeException("----bulkhead id ä¸èƒ½-4");
        }
        if (id == 9999) {
            try {
                TimeUnit.SECONDS.sleep(5);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        return "Helloã€8001ã€‘, bulkhead! inputId:  " + id + " \t " + IdUtil.simpleUUID();
    }
}
```



#### ä¿¡å·é‡èˆ±å£

> **ä¿¡å·é‡èˆ±å£ï¼ˆSemaphoreBulkheadï¼‰åŸç†**
>
> å½“ä¿¡å·é‡æœ‰ç©ºé—²æ—¶ï¼Œè¿›å…¥ç³»ç»Ÿçš„è¯·æ±‚ä¼šç›´æ¥è·å–ä¿¡å·é‡å¹¶å¼€å§‹ä¸šåŠ¡å¤„ç†ã€‚
>
> å½“ä¿¡å·é‡å…¨è¢«å ç”¨æ—¶ï¼Œæ¥ä¸‹æ¥çš„è¯·æ±‚å°†ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼ŒSemaphoreBulkheadæä¾›äº†ä¸€ä¸ªé˜»å¡è®¡æ—¶å™¨ï¼Œ
>
> å¦‚æœé˜»å¡çŠ¶æ€çš„è¯·æ±‚åœ¨é˜»å¡è®¡æ—¶å†…æ— æ³•è·å–åˆ°ä¿¡å·é‡åˆ™ç³»ç»Ÿä¼šæ‹’ç»è¿™äº›è¯·æ±‚ã€‚
>
> è‹¥è¯·æ±‚åœ¨é˜»å¡è®¡æ—¶å†…è·å–åˆ°äº†ä¿¡å·é‡ï¼Œé‚£å°†ç›´æ¥è·å–ä¿¡å·é‡å¹¶æ‰§è¡Œç›¸åº”çš„ä¸šåŠ¡å¤„ç†ã€‚

##### YMLé…ç½®

```yaml
resilience4j:
  bulkhead:
    configs:
      default:
        maxConcurrentCalls: 2 # éš”ç¦»å…è®¸å¹¶å‘çº¿ç¨‹æ‰§è¡Œçš„æœ€å¤§æ•°é‡
        maxWaitDuration: 1s # å½“è¾¾åˆ°å¹¶å‘è°ƒç”¨æ•°é‡æ—¶ï¼Œæ–°çš„çº¿ç¨‹çš„é˜»å¡æ—¶é—´ï¼Œæˆ‘åªæ„¿æ„ç­‰å¾…1ç§’ï¼Œè¿‡æ—¶ä¸å€™è¿›èˆ±å£å…œåº•fallback
    instances:
      cloud-payment-service:
        baseConfig: default
  timelimiter:
    configs:
      default:
        timeout-duration: 20s
```

##### æ¶ˆè´¹è€…æ–°å¢æ¥å£

- @Bulkheadï¼šèˆ±å£æ³¨è§£
  - nameï¼šæœåŠ¡åç§°
  - fallbackMethodï¼šå›è°ƒæ–¹æ³•
  - typeï¼šéš”ç¦»æ–¹å¼

```java
/**
 * (èˆ¹çš„)èˆ±å£,éš”ç¦» ä¿¡å·èˆ±å£
 */
@GetMapping(value = "/feign/pay/bulkhead/semaphore/{id}")
@Bulkhead(name = "cloud-payment-service",fallbackMethod = "myBulkheadFallback",type = Bulkhead.Type.SEMAPHORE)
public String myBulkhead(@PathVariable("id") Integer id)
{
    return payFeignApi.myBulkhead(id);
}
public String myBulkheadFallback(Throwable t)
{
    return "myBulkheadFallbackï¼Œéš”æ¿è¶…å‡ºæœ€å¤§æ•°é‡é™åˆ¶ï¼Œç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•-----/(ã„’oã„’)/~~";
}
```

**æµ‹è¯•ï¼š**

è¯·æ±‚1ã€2éƒ½è®¿é—®/9999ï¼Œéœ€è¦ç­‰å¾…5s

æ­¤æ—¶è¯·æ±‚3è®¿é—®/3ï¼Œå› ä¸ºå·²ç»æœ‰ä¸¤ä¸ªå¹¶å‘çº¿ç¨‹äº†ï¼Œä»–å°†ç­‰å¾…1sï¼Œ1såæ²¡æœ‰æ‰§è¡Œå°±è¿›è¡ŒæœåŠ¡éš”ç¦»

**è¸©å‘ï¼š**

1. è®¾ç½®openfeignçš„è¿æ¥è¶…æ—¶å’Œè¯»å–è¶…æ—¶æ—¶é—´ä¸º3sï¼Œè€Œ/9999éœ€è¦ç­‰å¾…5sï¼Œå› æ­¤ä¸è®ºå¦‚ä½•è¯·æ±‚éƒ½æ˜¯æœ‰é—®é¢˜çš„

2. circuitbreakerå¿…é¡»å¼€å¯åˆ†ç»„æ¿€æ´»ï¼ˆcircuitbreaker.group.enabledï¼‰ï¼Œå¦åˆ™/3å°±ç®—æ²¡æœ‰å¹¶å‘æ§½ä¹Ÿèƒ½è®¿é—®æˆåŠŸ

   ```yaml
   server:
     port: 80
   spring:
     application:
       name: cloud-consumer-openfeign-order
     cloud:
       openfeign:
         ...
         # å¼€å¯circuitbreakerå’Œåˆ†ç»„æ¿€æ´» spring.cloud.openfeign.circuitbreaker.enabled
         circuitbreaker:
           enabled: true
           group:
             enabled: true #æ²¡å¼€åˆ†ç»„æ°¸è¿œä¸ç”¨åˆ†ç»„çš„é…ç½®ã€‚ç²¾ç¡®ä¼˜å…ˆã€åˆ†ç»„æ¬¡ä¹‹(å¼€äº†åˆ†ç»„)ã€é»˜è®¤æœ€å
   ```





#### **å›ºå®šçº¿ç¨‹æ± èˆ±å£**

> **å›ºå®šçº¿ç¨‹æ± èˆ±å£ï¼ˆFixedThreadPoolBulkheadï¼‰**
>
> FixedThreadPoolBulkheadçš„åŠŸèƒ½ä¸SemaphoreBulkheadä¸€æ ·ä¹Ÿæ˜¯**ç”¨äºé™åˆ¶å¹¶å‘æ‰§è¡Œçš„æ¬¡æ•°**çš„
>
> ä½†æ˜¯äºŒè€…çš„å®ç°åŸç†å­˜åœ¨å·®åˆ«è€Œä¸”è¡¨ç°æ•ˆæœä¹Ÿå­˜åœ¨ç»†å¾®çš„å·®åˆ«
>
> FixedThreadPoolBulkheadä½¿ç”¨**ä¸€ä¸ªå›ºå®šçº¿ç¨‹æ± **å’Œ**ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—**æ¥å®ç°èˆ±å£ã€‚
>
> - å½“çº¿ç¨‹æ± ä¸­å­˜åœ¨ç©ºé—²æ—¶ï¼Œåˆ™æ­¤æ—¶è¿›å…¥ç³»ç»Ÿçš„è¯·æ±‚å°†ç›´æ¥è¿›å…¥çº¿ç¨‹æ± å¼€å¯æ–°çº¿ç¨‹æˆ–ä½¿ç”¨ç©ºé—²çº¿ç¨‹æ¥å¤„ç†è¯·æ±‚ã€‚
> - å½“çº¿ç¨‹æ± ä¸­æ— ç©ºé—²æ—¶æ—¶ï¼Œæ¥ä¸‹æ¥çš„è¯·æ±‚å°†è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œ
>   - è‹¥ç­‰å¾…é˜Ÿåˆ—ä»ç„¶æ— å‰©ä½™ç©ºé—´æ—¶æ¥ä¸‹æ¥çš„è¯·æ±‚å°†ç›´æ¥è¢«æ‹’ç»ï¼Œ
>   - åœ¨é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ç­‰å¾…çº¿ç¨‹æ± å‡ºç°ç©ºé—²æ—¶ï¼Œå°†è¿›å…¥çº¿ç¨‹æ± è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚
> - å¦å¤–ï¼šThreadPoolBulkheadåªå¯¹CompletableFutureæ–¹æ³•æœ‰æ•ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…åˆ›å»ºè¿”å›CompletableFutureç±»å‹çš„æ–¹æ³•

##### æ¶ˆè´¹è€…æ–°å¢æ¥å£

```java
@GetMapping(value = "/feign/pay/bulkhead/threadpool/{id}")
@Bulkhead(name = "cloud-payment-service", fallbackMethod = "myBulkheadPoolFallback", type = Bulkhead.Type.THREADPOOL)
public CompletableFuture<String> myBulkheadTHREADPOOL(@PathVariable("id") Integer id) {
    System.out.println(Thread.currentThread().getName() + "\t" + "enter the method!!!");
    try {
        TimeUnit.SECONDS.sleep(3);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    System.out.println(Thread.currentThread().getName() + "\t" + "exist the method!!!");

    return CompletableFuture.supplyAsync(() -> payFeignApi.myBulkhead(id) + "\t" + " Bulkhead.Type.THREADPOOL");
}

public CompletableFuture<String> myBulkheadPoolFallback(Integer id, Throwable t) {
    return CompletableFuture.supplyAsync(() -> "ã€å›ºå®šçº¿ç¨‹æ± èˆ±å£ã€‘Bulkhead.Type.THREAD POOLï¼Œç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•-----/(ã„’oã„’)/~~");
}
```



##### YMLé…ç½®

```yaml
####resilience4j bulkhead -THREADPOOLçš„ä¾‹å­
resilience4j:
  timelimiter:
    configs:
      default:
        timeout-duration: 10s #timelimiteré»˜è®¤é™åˆ¶è¿œç¨‹1sï¼Œè¶…è¿‡æŠ¥é”™ä¸å¥½æ¼”ç¤ºæ•ˆæœæ‰€ä»¥åŠ ä¸Š10ç§’
  thread-pool-bulkhead:
    configs:
      default:
        core-thread-pool-size: 2
        max-thread-pool-size: 2
        queue-capacity: 2
    instances:
      cloud-payment-service:
        baseConfig: default
# spring.cloud.openfeign.circuitbreaker.group.enabled è¯·è®¾ç½®ä¸ºfalse æ–°å¯çº¿ç¨‹å’ŒåŸæ¥ä¸»çº¿ç¨‹è„±ç¦»
```

ä¾æ¬¡è¯·æ±‚/1ã€/2ã€/3ã€/4ã€/5

/1&/2ç­‰å¾…3åè¾“å‡ºï¼Œ/3&/4åœ¨é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å‰é¢æ‰§è¡Œå®Œå°±è¡¥ä¸Šå»ï¼Œ5ç›´æ¥é™çº§ï¼ˆ1&2åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œ3&4åœ¨æ’é˜Ÿï¼Œ5å°±ä¸å…è®¸è¿›æ¥äº†ï¼‰

/3ä¹Ÿä¼šç­‰/1æ‰§è¡Œå®Œåå†æ‰§è¡Œ

**çº¿ç¨‹æ± éš”ç¦»å°±æ˜¯æ ¹æ®çº¿ç¨‹æ± å·²æœ‰çš„æ•°é‡åŠé˜Ÿåˆ—æ•°é‡è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå·²æ»¡ï¼Œå°†ç›´æ¥è¿›è¡ŒæœåŠ¡é™çº§**



### é™å¹¶å‘å’Œé™æµå°æ’æ›²

- é™å¹¶å‘ï¼Œæ˜¯é™åˆ¶åŒä¸€æ—¶åˆ»å¯ä»¥æ‰§è¡Œçš„è¯·æ±‚æ•°é‡ç­‰..
- é™æµï¼Œæ˜¯é™åˆ¶ä¸€æ®µæ—¶é—´å†…ï¼Œå¯ä»¥æ¥æ”¶çš„è¯·æ±‚æ•°é‡..

**====å¦‚ï¼š**

- å…¬å›­çš„æ€»å®¹é‡æ˜¯3000äººï¼Œè¿™å°±æ˜¯å¹¶å‘ï¼Œå¤šäº†æ— æ³•æ‰§è¡Œï¼›
- å…¬å›­ä¸‹åˆå››ç‚¹åˆ°å››ç‚¹ååˆ†ï¼Œä¸€å…±åªæ¥çº³20äººï¼Œè¿™å°±æ˜¯é™æµ
- ç§’æ€ä¸šåŠ¡ï¼Œç¬æ—¶å¤§é‡è¯·æ±‚è¿‡æ¥ï¼Œéœ€é™æµ



### é™æµï¼ˆRateLimiterï¼‰

#### å®˜ç½‘

- https://resilience4j.readme.io/docs/ratelimiter
- https://github.com/lmhmhl/Resilience4j-Guides-Chinese/blob/main/core-modules/ratelimiter.md

#### æ¦‚è¿°

- é™åˆ¶é¢‘ç‡

- å¸¸è§çš„é™æµç®—æ³•ï¼š

  - æ¼æ–—ç®—æ³•ï¼ˆLeaky Bucketï¼‰

    <img src="D:\File\markdownPictures\image-20240724163417459.png" alt="image-20240724163417459" style="zoom:33%;" />

    **ç¼ºç‚¹ï¼š**è¿™é‡Œæœ‰ä¸¤ä¸ªå˜é‡ï¼Œä¸€ä¸ªæ˜¯æ¡¶çš„å¤§å°ï¼Œæ”¯æŒæµé‡çªå‘å¢å¤šæ—¶å¯ä»¥å­˜å¤šå°‘çš„æ°´ï¼ˆburstï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯æ°´æ¡¶æ¼æ´çš„å¤§å°ï¼ˆrateï¼‰ã€‚å› ä¸ºæ¼æ¡¶çš„æ¼å‡ºé€Ÿç‡æ˜¯å›ºå®šçš„å‚æ•°ï¼Œæ‰€ä»¥ï¼Œå³ä½¿ç½‘ç»œä¸­ä¸å­˜åœ¨èµ„æºå†²çªï¼ˆæ²¡æœ‰å‘ç”Ÿæ‹¥å¡ï¼‰ï¼Œæ¼æ¡¶ç®—æ³•ä¹Ÿä¸èƒ½ä½¿æµçªå‘ï¼ˆburstï¼‰åˆ°ç«¯å£é€Ÿç‡ã€‚å› æ­¤ï¼Œæ¼æ¡¶ç®—æ³•å¯¹äºå­˜åœ¨çªå‘ç‰¹æ€§çš„æµé‡æ¥è¯´ç¼ºä¹æ•ˆç‡ã€‚

    <img src="D:\File\markdownPictures\image-20240724163259552.png" alt="image-20240724163259552" style="zoom:33%;" />

  - ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆToken Bucketï¼‰-SpringCloudé»˜è®¤ç®—æ³•

    **ä¸ªäººç†è§£ï¼š**è¯·æ±‚ä»¥ä»€ä¹ˆé¢‘ç‡æ¥ï¼Œä¸çŸ¥é“ã€‚ä½†æ˜¯æä¾›ä»¤ç‰Œæ˜¯å‡åŒ€æä¾›ï¼Œå¹¶ä¸”æ€»é‡ä¸€å®šï¼Œå¦‚æœä¸€ç¬é—´ä»¤ç‰Œæ‹¿å®Œäº†ï¼Œæ²¡æœ‰ä»¤ç‰Œï¼Œä¹Ÿå°±é™åˆ¶ä½äº†ã€‚

    <img src="D:\File\markdownPictures\image-20240724170009606.png" alt="image-20240724170009606" style="zoom:33%;" />

  - æ»šåŠ¨æ—¶é—´çª—ï¼ˆtumbling time windowï¼‰

    æ²¡å¤ªç†è§£ï¼ŒæŒ‰æ—¶é—´æ®µåˆ‡å‰²è‹¥å¹²ä¸ªç”¨æˆ·è¯·æ±‚çš„æ¬¡æ•°æ€»å’Œï¼Œè¶…è¿‡å›ºå®šå€¼å°±å°†è¶…è¿‡éƒ¨åˆ†é€å»æ’é˜Ÿï¼Ÿ

    ç¼ºç‚¹æ˜¯ï¼Œæœ€å¤§å…è®¸100ï¼Œä»¥ä¸€åˆ†é’Ÿä¸ºæ—¶é—´æ®µåˆ‡å‰²çš„è¯ï¼Œ12:00:59æ¥äº†100ä¸ªè¯·æ±‚ï¼Œ12:01:00åˆ°12:01:01åˆæ¥äº†100ä¸ªï¼Œåˆšå¥½åˆ‡å‰²è½¬æ¢çš„æ—¶é—´èŠ‚ç‚¹ï¼Œæ¥äº†doubleå€ï¼Œå¾ˆcrazyï¼

    <img src="D:\File\markdownPictures\image-20240725103034624.png" alt="image-20240725103034624" style="zoom:33%;" />

  - æ»‘åŠ¨äº‹ä»¶çª—å£ï¼ˆsliding time windowsï¼‰

    <img src="D:\File\markdownPictures\image-20240725103054990.png" alt="image-20240725103054990" style="zoom:33%;" />





#### å¿«é€Ÿå¼€å§‹

##### æä¾›è€…æ–°å¢æ¥å£

```java
@GetMapping(value = "/pay/ratelimit/{id}")
public String myRatelimit(@PathVariable("id") Integer id)
{
    return "Hello, myRatelimitæ¬¢è¿åˆ°æ¥ inputId:  "+id+" \t " + IdUtil.simpleUUID();
}
```

##### å…¬å…±æ¥å£æ–°å¢

```java
@GetMapping(value = "/pay/ratelimit/{id}")
public String myRatelimit(@PathVariable("id") Integer id);
```

##### æ¶ˆè´¹è€…æ–°å¢é™æµä¾èµ–

```xml
<!--resilience4j-ratelimiter-->
<dependency>
    <groupId>io.github.resilience4j</groupId>
    <artifactId>resilience4j-ratelimiter</artifactId>
</dependency>
```

##### æ¶ˆè´¹è€…æ–°å¢é…ç½®æ–‡ä»¶

```yml
####resilience4j ratelimiter é™æµçš„ä¾‹å­
resilience4j:
  ratelimiter:
    configs:
      default:
        limitForPeriod: 2 #åœ¨ä¸€æ¬¡åˆ·æ–°å‘¨æœŸå†…ï¼Œå…è®¸æ‰§è¡Œçš„æœ€å¤§è¯·æ±‚æ•°
        limitRefreshPeriod: 1s # é™æµå™¨æ¯éš”limitRefreshPeriodåˆ·æ–°ä¸€æ¬¡ï¼Œå°†å…è®¸å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°é‡é‡ç½®ä¸ºlimitForPeriod
        timeout-duration: 1 # çº¿ç¨‹ç­‰å¾…æƒé™çš„é»˜è®¤ç­‰å¾…æ—¶é—´
    instances:
        cloud-payment-service:
          baseConfig: default
```

##### æ¶ˆè´¹è€…æ–°å¢æ¥å£

```java
@GetMapping(value = "/feign/pay/ratelimit/{id}")
@RateLimiter(name = "cloud-payment-service",fallbackMethod = "myRatelimitFallback")
public String myBulkhead(@PathVariable("id") Integer id){
    return payFeignApi.myRatelimit(id);
}
public String myRatelimitFallback(Integer id,Throwable t){
    return "ä½ è¢«é™æµäº†ï¼Œç¦æ­¢è®¿é—®/(ã„’oã„’)/~~";
}
```

##### æ•ˆæœ

[localhost/feign/pay/ratelimit/11](http://localhost/feign/pay/ratelimit/11)

1så†…è¿ç»­ç‚¹å‡»ä¸‰æ¬¡å¦‚ä¸Šé“¾æ¥ï¼Œç¬¬ä¸‰æ¬¡ä¼šè¢«é™æµ~



# Sleuthï¼ˆMicrometerï¼‰åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

## Sleuthè¿›å…¥ç»´æŠ¤çŠ¶æ€..

æ›¿æ¢æ–¹æ¡ˆï¼šMicrometer Tracing

Sleuthä¸é€‚ç”¨äºSpringBoot3.x+ï¼Œä¸»è¦æ”¯æŒSpringBoot2.x+



## å‰æƒ…æè¦

![image-20240725114427080](D:\File\markdownPictures\image-20240725114427080.png)



## æ¦‚è¿°

### å®˜ç½‘ 

- micrometerï¼š

  https://micrometer.io/docs/tracing

- sleuthï¼š

  https://spring.io/projects/spring-cloud-sleuth#overview

  https://github.com/spring-cloud/spring-cloud-sleuth

### ZipKinï¼Ÿ

Spring Cloud Sleuthï¼ˆMicrometerï¼‰æä¾›åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼Œæ”¯æŒä½¿ç”¨ZipKinå±•ç°

<img src="D:\File\markdownPictures\image-20240725135048573.png" alt="image-20240725135048573" style="zoom:33%;" />

### å°ç»“

Spring Cloud Sleuthæä¾›ä¸€æ¬¡åˆ†å¸ƒå¼è¯·æ±‚çš„å®Œæ•´é“¾è·¯è¿½è¸ªï¼Œè¿›è¡Œæ—¥å¿—è®°å½•å’Œæ€§èƒ½ç›‘æ§

å¹¶å°†è°ƒç”¨æƒ…å†µé›†ä¸­ä»¥Webå±•ç¤º

**è¡Œä¸šå†…å…¶ä»–æˆç†Ÿè§£å†³æ–¹æ¡ˆï¼š**

<img src="D:\File\markdownPictures\image-20240725135425726.png" alt="image-20240725135425726" style="zoom:33%;" />



## ç®€å•åŸç†å±•ç¤º

<img src="D:\File\markdownPictures\image-20240725145227248.png" alt="image-20240725145227248" style="zoom:33%;" />

> é‚£ä¹ˆä¸€æ¡é“¾è·¯è¿½è¸ªä¼šåœ¨æ¯ä¸ªæœåŠ¡è°ƒç”¨çš„æ—¶å€™åŠ ä¸ŠTrace ID å’Œ Span ID
>
> é“¾è·¯é€šè¿‡TraceIdå”¯ä¸€æ ‡è¯†ï¼Œ
>
> Spanæ ‡è¯†å‘èµ·çš„è¯·æ±‚ä¿¡æ¯ï¼Œå„spané€šè¿‡parent id å…³è”èµ·æ¥ (Span:è¡¨ç¤ºè°ƒç”¨é“¾è·¯æ¥æºï¼Œé€šä¿—çš„ç†è§£spanå°±æ˜¯ä¸€æ¬¡è¯·æ±‚ä¿¡æ¯)

<img src="D:\File\markdownPictures\image-20240725145116502.png" alt="image-20240725145116502" style="zoom:40%;" />





# ZipKin

## æ¦‚è¿°

Zipkinæ˜¯ä¸€ç§åˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ªç³»ç»Ÿå›¾å½¢åŒ–çš„å·¥å…·ï¼ŒZipkin æ˜¯ Twitter å¼€æºçš„åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿï¼Œèƒ½å¤Ÿæ”¶é›†å¾®æœåŠ¡è¿è¡Œè¿‡ç¨‹ä¸­çš„å®æ—¶è°ƒç”¨é“¾è·¯ä¿¡æ¯ï¼Œå¹¶èƒ½å¤Ÿå°†è¿™äº›è°ƒç”¨é“¾è·¯ä¿¡æ¯å±•ç¤ºåˆ°Webå›¾å½¢åŒ–ç•Œé¢ä¸Šä¾›å¼€å‘äººå‘˜åˆ†æï¼Œå¼€å‘äººå‘˜èƒ½å¤Ÿä»ZipKinä¸­åˆ†æå‡ºè°ƒç”¨é“¾è·¯ä¸­çš„æ€§èƒ½ç“¶é¢ˆï¼Œè¯†åˆ«å‡ºå­˜åœ¨é—®é¢˜çš„åº”ç”¨ç¨‹åºï¼Œè¿›è€Œå®šä½é—®é¢˜å’Œè§£å†³é—®é¢˜ã€‚

**å®˜ç½‘ï¼š** [OpenZipkin Â·åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ](https://zipkin.io/)

å¯åŠ¨åè®¿é—®ï¼ˆç«¯å£9411ï¼‰ï¼š[Zipkin](http://localhost:9411/zipkin/)



# Micrometer & ZipKin

- Micrometerï¼šæ•°æ®é‡‡æ ·
- ZipKinï¼šå›¾å½¢å±•ç¤º

```xml
<properties>
    <micrometer-tracing.version>1.2.0</micrometer-tracing.version>
    <micrometer-observation.version>1.12.0</micrometer-observation.version>
    <feign-micrometer.version>12.5</feign-micrometer.version>
    <zipkin-reporter-brave.version>2.17.0</zipkin-reporter-brave.version>
</properties>

<dependencyManagement>
    <dependencies>
        <!--micrometer-tracing-bomå¯¼å…¥é“¾è·¯è¿½è¸ªç‰ˆæœ¬ä¸­å¿ƒ  1-->
        <dependency>
            <groupId>io.micrometer</groupId>
            <artifactId>micrometer-tracing-bom</artifactId>
            <version>${micrometer-tracing.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        <!--micrometer-tracingæŒ‡æ ‡è¿½è¸ª  2-->
        <dependency>
            <groupId>io.micrometer</groupId>
            <artifactId>micrometer-tracing</artifactId>
            <version>${micrometer-tracing.version}</version>
        </dependency>
        <!--micrometer-tracing-bridge-braveé€‚é…zipkinçš„æ¡¥æ¥åŒ… 3-->
        <dependency>
            <groupId>io.micrometer</groupId>
            <artifactId>micrometer-tracing-bridge-brave</artifactId>
            <version>${micrometer-tracing.version}</version>
        </dependency>
        <!--micrometer-observation 4-->
        <dependency>
            <groupId>io.micrometer</groupId>
            <artifactId>micrometer-observation</artifactId>
            <version>${micrometer-observation.version}</version>
        </dependency>
        <!--feign-micrometer 5-->
        <dependency>
            <groupId>io.github.openfeign</groupId>
            <artifactId>feign-micrometer</artifactId>
            <version>${feign-micrometer.version}</version>
        </dependency>
        <!--zipkin-reporter-brave 6-->
        <dependency>
            <groupId>io.zipkin.reporter2</groupId>
            <artifactId>zipkin-reporter-brave</artifactId>
            <version>${zipkin-reporter-brave.version}</version>
        </dependency>
    </dependencies>
</dependencyManagement>
```

## ä¾èµ–çˆ†çº¢è¶…çº§ç‰›é€¼è§£å†³æ–¹æ¡ˆ

å»æ‰dependencyManagementï¼Œé‡æ–°å¼•å…¥ä¸‹è½½åˆ°æœ¬åœ°ï¼Œå†åŠ ä¸ŠdependencyManagement

## ç»§ç»­

ç”±äºMicrometer Tracingæ˜¯ä¸€ä¸ªé—¨é¢å·¥å…·è‡ªèº«å¹¶æ²¡æœ‰å®ç°å®Œæ•´çš„é“¾è·¯è¿½è¸ªç³»ç»Ÿï¼Œå…·ä½“çš„é“¾è·¯è¿½è¸ªå¦å¤–éœ€è¦å¼•å…¥çš„æ˜¯ç¬¬ä¸‰æ–¹é“¾è·¯è¿½è¸ªç³»ç»Ÿçš„ä¾èµ–ï¼š

[![pkOiukR.png](https://s21.ax1x.com/2024/07/30/pkOiukR.png)](https://imgse.com/i/pkOiukR)



**è¡¥å……åŒ…ï¼š** spring-boot-starter-actuator  SpringBootæ¡†æ¶çš„ä¸€ä¸ªæ¨¡å—ç”¨äºç›‘è§†å’Œç®¡ç†åº”ç”¨ç¨‹åº



## å¯åŠ¨

1. è®¿é—® http://localhost/feign/micrometer/80
2. è¿›å…¥ http://localhost:9411/zipkin æŸ¥çœ‹é“¾è·¯



# Gatewayç½‘å…³

æœ‰Nginxï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦Gatewayï¼Ÿ

## æ¦‚è¿°

- å®˜ç½‘ï¼šhttps://docs.spring.io/spring-cloud-gateway/docs/4.0.4/reference/html/

- Gatewayæ˜¯åœ¨Springç”Ÿæ€ç³»ç»Ÿä¹‹ä¸Šæ„å»ºçš„APIç½‘å…³æœåŠ¡ï¼ŒåŸºäºSpring6ï¼ŒSpring Boot 3å’ŒProject Reactorç­‰æŠ€æœ¯ã€‚å®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ï¼Œå¹¶ä¸ºå®ƒä»¬æä¾›è·¨é¢†åŸŸçš„å…³æ³¨ç‚¹ï¼Œä¾‹å¦‚ï¼šå®‰å…¨æ€§ã€ç›‘æ§/åº¦é‡å’Œæ¢å¤èƒ½åŠ›ã€‚

- [![pkOFG80.png](https://s21.ax1x.com/2024/07/30/pkOFG80.png)](https://imgse.com/i/pkOFG80)

- Cloudå…¨å®¶æ¡¶ä¸­æœ‰ä¸ªå¾ˆé‡è¦çš„ç»„ä»¶å°±æ˜¯ç½‘å…³ï¼Œåœ¨1.xç‰ˆæœ¬ä¸­éƒ½æ˜¯é‡‡ç”¨çš„Zuulç½‘å…³ï¼›

  ä½†åœ¨2.xç‰ˆæœ¬ä¸­ï¼Œzuulçš„å‡çº§ä¸€ç›´è·³ç¥¨ï¼ŒSpringCloudæœ€åè‡ªå·±ç ”å‘äº†ä¸€ä¸ªç½‘å…³SpringCloud Gatewayæ›¿ä»£Zuulï¼Œ

  é‚£å°±æ˜¯SpringCloud Gatewayä¸€å¥è¯ï¼šgatewayæ˜¯åŸzuul1.xç‰ˆçš„æ›¿ä»£

### ä½œç”¨

- åå‘ä»£ç†
- é‰´æƒ
- æµé‡æ§åˆ¶
- ç†”æ–­
- æ—¥å¿—ç›‘æ§



### å°ç»“

- Spring Cloud Gatewayç»„ä»¶çš„æ ¸å¿ƒæ˜¯ä¸€ç³»åˆ—çš„è¿‡æ»¤å™¨ï¼Œé€šè¿‡è¿™äº›è¿‡æ»¤å™¨å¯ä»¥å°†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚è½¬å‘(è·¯ç”±)åˆ°å¯¹åº”çš„å¾®æœåŠ¡ã€‚ 
- Spring Cloud Gatewayæ˜¯åŠ åœ¨æ•´ä¸ªå¾®æœåŠ¡æœ€å‰æ²¿çš„é˜²ç«å¢™å’Œä»£ç†å™¨ï¼Œéšè—å¾®æœåŠ¡ç»“ç‚¹IPç«¯å£ä¿¡æ¯ï¼Œä»è€ŒåŠ å¼ºå®‰å…¨ä¿æŠ¤ã€‚
- Spring Cloud Gatewayæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œéœ€è¦æ³¨å†Œè¿›æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚

[![pkOFNKU.png](https://s21.ax1x.com/2024/07/30/pkOFNKU.png)](https://imgse.com/i/pkOFNKU)





















## ä¸‰å¤§æ ¸å¿ƒ

- **Route(è·¯ç”±)**

  è·¯ç”±æ˜¯æ„å»ºç½‘å…³çš„åŸºæœ¬æ¨¡å—ï¼Œå®ƒç”±IDï¼Œç›®æ ‡URIï¼Œä¸€ç³»åˆ—çš„æ–­è¨€å’Œè¿‡æ»¤å™¨ç»„æˆï¼Œå¦‚æœæ–­è¨€ä¸ºtrueåˆ™åŒ¹é…è¯¥è·¯ç”±

- **Predicate(æ–­è¨€)**

  å‚è€ƒçš„æ˜¯Java8çš„java.util.function.Predicate

  å¼€å‘äººå‘˜å¯ä»¥åŒ¹é…HTTPè¯·æ±‚ä¸­çš„æ‰€æœ‰å†…å®¹(ä¾‹å¦‚è¯·æ±‚å¤´æˆ–è¯·æ±‚å‚æ•°)ï¼Œ**å¦‚æœè¯·æ±‚ä¸æ–­è¨€ç›¸åŒ¹é…åˆ™è¿›è¡Œè·¯ç”±**

- **Filter(è¿‡æ»¤)**

  æŒ‡çš„æ˜¯Springæ¡†æ¶ä¸­GatewayFilterçš„å®ä¾‹ï¼Œä½¿ç”¨è¿‡æ»¤å™¨ï¼Œå¯ä»¥åœ¨è¯·æ±‚è¢«è·¯ç”±å‰æˆ–è€…ä¹‹åå¯¹è¯·æ±‚è¿›è¡Œä¿®æ”¹ã€‚



## å·¥ä½œæµç¨‹

- å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ã€‚ç„¶ååœ¨ Gateway Handler Mapping ä¸­æ‰¾åˆ°ä¸è¯·æ±‚ç›¸åŒ¹é…çš„è·¯ç”±ï¼Œå°†å…¶å‘é€åˆ° Gateway Web Handlerã€‚Handler å†é€šè¿‡æŒ‡å®šçš„è¿‡æ»¤å™¨é“¾æ¥å°†è¯·æ±‚å‘é€åˆ°æˆ‘ä»¬å®é™…çš„æœåŠ¡æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç„¶åè¿”å›ã€‚
- è¿‡æ»¤å™¨ä¹‹é—´ç”¨è™šçº¿åˆ†å¼€æ˜¯å› ä¸ºè¿‡æ»¤å™¨å¯èƒ½ä¼šåœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰(Pre)æˆ–ä¹‹å(Post)æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚
- åœ¨â€œpreâ€ç±»å‹çš„è¿‡æ»¤å™¨å¯ä»¥åš**å‚æ•°æ ¡éªŒã€æƒé™æ ¡éªŒã€æµé‡ç›‘æ§ã€æ—¥å¿—è¾“å‡ºã€åè®®è½¬æ¢ç­‰;**
- åœ¨â€œpostâ€ç±»å‹çš„è¿‡æ»¤å™¨ä¸­å¯ä»¥åš**å“åº”å†…å®¹ã€å“åº”å¤´çš„ä¿®æ”¹ï¼Œæ—¥å¿—çš„è¾“å‡ºï¼Œæµé‡ç›‘æ§**ç­‰æœ‰ç€éå¸¸é‡è¦çš„ä½œç”¨ã€‚

### æ ¸å¿ƒé€»è¾‘

è·¯ç”±è½¬å‘+æ–­è¨€åˆ¤æ–­+æ‰§è¡Œè¿‡æ»¤å™¨é“¾



## å¿«é€Ÿå¼€å§‹ - å‡†å¤‡å·¥ä½œ

é¦–å…ˆä¸€ç‚¹ï¼Œç½‘å…³æ˜¯ä¸€ä¸ªå•ç‹¬çš„å·¥ç¨‹

æ–°å»ºå·¥ç¨‹ New Module

### POM

```xml
<dependencies>
    <!--gateway-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-gateway</artifactId>
    </dependency>
    <!--æœåŠ¡æ³¨å†Œå‘ç°consul discovery,ç½‘å…³ä¹Ÿè¦æ³¨å†Œè¿›æœåŠ¡æ³¨å†Œä¸­å¿ƒç»Ÿä¸€ç®¡æ§-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-consul-discovery</artifactId>
    </dependency>
    <!-- æŒ‡æ ‡ç›‘æ§å¥åº·æ£€æŸ¥çš„actuator,ç½‘å…³æ˜¯å“åº”å¼ç¼–ç¨‹åˆ é™¤æ‰spring-boot-starter-web dependency-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
</dependencies>
```



### YAML

```yaml
server:
  port: 9527

spring:
  application:
    name: cloud-gateway #ä»¥å¾®æœåŠ¡æ³¨å†Œè¿›consulæˆ–nacosæœåŠ¡åˆ—è¡¨å†…
  cloud:
    consul: #é…ç½®consulåœ°å€
      host: localhost
      port: 8500
      discovery:
        prefer-ip-address: true
        service-name: ${spring.application.name}
```



### MAINAPPLICATIONï¼ˆå¯åŠ¨ç±»ï¼‰

```java
@SpringBootApplication
@EnableDiscoveryClient //æœåŠ¡æ³¨å†Œå’Œå‘ç°
public class Main9527 {
    public static void main(String[] args) {
        SpringApplication.run(Main9527.class, args);
    }
}
```



### ä¸šåŠ¡ç±»

ç½‘å…³ä¸ä¸šåŠ¡æ— å…³



## å¿«é€Ÿå¼€å§‹ - å¼€å†™ï¼

[![pkOAJnU.md.png](https://s21.ax1x.com/2024/07/30/pkOAJnU.md.png)](https://imgse.com/i/pkOAJnU)

















**è¯‰æ±‚ï¼š** ä¸æƒ³æš´éœ²çœŸå®çš„æä¾›è€…ç«¯å£ï¼Œå³8001ã€‚å¸Œæœ›å¤–é¢å¥—ä¸€å±‚9527ç½‘å…³

åŸæœ¬è®¿é—®8001æµ‹è¯•æ¥å£è·¯å¾„ï¼šhttp://localhost:8001/pay/gateway/info

æ·»åŠ ç½‘å…³é…ç½®åè®¿é—®è·¯å¾„ï¼šhttp://localhost:9527/pay/gateway/info

è¯´æ˜8001å‰æ·»åŠ å¾®æœåŠ¡æˆåŠŸï¼

é…ç½®å¦‚ä¸‹ï¼š

```yaml
server:
  port: 9527
spring:
  cloud:
    ...
    gateway:
      routes:
        - id: pay_routh1 #pay_routh1                #è·¯ç”±çš„ID(ç±»ä¼¼mysqlä¸»é”®ID)ï¼Œæ²¡æœ‰å›ºå®šè§„åˆ™ä½†è¦æ±‚å”¯ä¸€ï¼Œå»ºè®®é…åˆæœåŠ¡å
          uri: http://localhost:8001                #åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€
          predicates:
            - Path=/pay/gateway/get/**              # æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”±

        - id: pay_routh2 #pay_routh2                #è·¯ç”±çš„ID(ç±»ä¼¼mysqlä¸»é”®ID)ï¼Œæ²¡æœ‰å›ºå®šè§„åˆ™ä½†è¦æ±‚å”¯ä¸€ï¼Œå»ºè®®é…åˆæœåŠ¡å
          uri: http://localhost:8001                #åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€
          predicates:
            - Path=/pay/gateway/info/**              # æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”±
```



ç°åœ¨è¦åšåˆ°ï¼Œå¯åŠ¨80è®¢å•å¾®æœåŠ¡ï¼Œèƒ½é€šè¿‡consulæ³¨å†Œä¸­å¿ƒï¼Œé€šè¿‡å¾®æœåŠ¡åç§°æ‰¾åˆ°8001æ”¯ä»˜å¾®æœåŠ¡è¿›è¡Œè°ƒç”¨

80 -> 9527 -> 8001

### é—®é¢˜

æ¶ˆè´¹è€…ä¸­ç¼–å†™äº†è°ƒç”¨çš„æ¥å£ï¼Œç½‘å…³å…³é—­orå¼€å¯éƒ½ä¸å½±å“æ˜¯å¦è°ƒç”¨æˆåŠŸ

ç»•å¼€äº†ç½‘å…³çš„åŸå› æ˜¯ï¼Ÿ

æ¶ˆè´¹è€…è°ƒç”¨çš„æ¥å£ç›´æ¥æ˜¯æä¾›è€…çš„ï¼Œè€Œéèµ°ç½‘å…³

ä¿®æ”¹æ¶ˆè´¹è€…è°ƒç”¨æ¥å£çš„æœåŠ¡å`@FeignClient(value = "cloud-gateway")`

æ­¤æ—¶ï¼Œå¦‚æœç½‘å…³æœåŠ¡ä¸å¯åŠ¨ï¼Œä¸æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒï¼Œå°†æŠ¥é”™ï¼š

```bash
Caused by: feign.FeignException$ServiceUnavailable: [503] during [GET] to [http://cloud-gateway/pay/gateway/info] [PayFeignApi#getGatewayInfo()]: [Load balancer does not contain an instance for the service cloud-gateway]
```





## Gatewayé«˜çº§ç‰¹æ€§

### Routeä»¥å¾®æœåŠ¡åï¼ŒåŠ¨æ€è·å–æœåŠ¡URI

#### æ­¤å‰ç½‘å…³é…ç½®é—®é¢˜

[<img src="https://s21.ax1x.com/2024/08/05/pkvQwNt.png" alt="pkvQwNt.png" style="zoom: 67%;" />](https://imgse.com/i/pkvQwNt)



















ç›´æ¥ç»“åˆæ³¨å†Œä¸­å¿ƒçš„æœåŠ¡åï¼Œä¸€ä¸ªåå­—ä¸‹é¢å¯ä»¥å­˜åœ¨å¤šä¸ªç«¯å£çš„ç›¸åŒæœåŠ¡

#### æ–°é…ç½®æ ¼å¼

```yaml
gateway:
	routes:
		- id: pay_routh1 #pay_routh1                #è·¯ç”±çš„ID(ç±»ä¼¼mysqlä¸»é”®ID)ï¼Œæ²¡æœ‰å›ºå®šè§„åˆ™ä½†è¦æ±‚å”¯ä¸€ï¼Œå»ºè®®é…åˆæœåŠ¡å
		  uri: lb://cloud-payment-service                #åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€
		  predicates:
			- Path=/pay/gateway/get/**              # æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”±

		- id: pay_routh2 #pay_routh2                #è·¯ç”±çš„ID(ç±»ä¼¼mysqlä¸»é”®ID)ï¼Œæ²¡æœ‰å›ºå®šè§„åˆ™ä½†è¦æ±‚å”¯ä¸€ï¼Œå»ºè®®é…åˆæœåŠ¡å
		  uri: lb://cloud-payment-service              #åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€
		  predicates:
			- Path=/pay/gateway/info/**              # æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”±
```



### Predicateæ–­è¨€ï¼ˆè°“è¯ï¼‰

#### å¸¸ç”¨å†…ç½®Route Predicate

- **å®˜ç½‘**

  https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway/configuring-route-predicate-factories-and-filter-factories.html

- **ä¸¤ç§é…ç½®äºŒé€‰ä¸€ï¼š**

  - Shortcut Configuration

    ```yaml
    spring:
      cloud:
        gateway:
          routes:
          - id: after_route
            uri: https://example.org
            predicates:
            - Cookie=mycookie,mycookievalue
    ```

  - Fully Expanded Arguments

    ```yaml
    spring:
      cloud:
        gateway:
          routes:
          - id: after_route
            uri: https://example.org
            predicates:
            - name: Cookie
              args:
                name: mycookie
                regexp: mycookievalue
    ```

#### å¸¸ç”¨æ–­è¨€API

idï¼šè‡ªå®šä¹‰è·¯ç”±çš„IDï¼Œä¿æŒå”¯ä¸€

uriï¼šæœåŠ¡åœ°å€

predicatesï¼šè·¯ç”±æ¡ä»¶ï¼ŒPredicateæ¥æ”¶ä¸€ä¸ªè¾“å…¥å‚æ•°è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼

â€‹			è¯¥å±æ€§åŒ…å«å¤šç§é»˜è®¤æ–¹æ³•æ¥å°†Predicateç»„åˆæˆå…¶ä»–å¤æ‚çš„é€»è¾‘ï¼ˆä¸ã€æˆ–ã€éï¼‰

#### After / Before / Between  Route Predicate

ä½¿ç”¨æ—¶é—´æ ¼å¼**ZonedDateTime**ï¼Œé…ç½®å¦‚ä¸‹

è¡¨æ˜ï¼Œåœ¨2024.08.05 01:28:39ä¹‹åæ‰èƒ½è®¿é—®è¯¥è·¯ç”±

```yaml
predicates:
  - Path=/pay/gateway/get/**              # æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”±
  - After = 2024-08-05T01:28:39.362106800+08:00[Asia/Hong_Kong]
```

ZonedDateTimeè·å–æ–¹å¼

```java
// é»˜è®¤æ—¶åŒº
ZonedDateTime zbj = ZonedDateTime.now();
System.out.println(zbj);
```



#### Cookie Route Predicate

> Cookie Route Predicateéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ Cookie name ,ä¸€ä¸ªæ˜¯æ­£åˆ™è¡¨è¾¾å¼ã€‚
>
> è·¯ç”±è§„åˆ™ä¼šé€šè¿‡è·å–å¯¹åº”çš„ Cookie name å€¼å’Œæ­£åˆ™è¡¨è¾¾å¼å»åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ä¸Šå°±ä¼šæ‰§è¡Œè·¯ç”±ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…ä¸Šåˆ™ä¸æ‰§è¡Œ

```yaml
predicates:
  - Path=/pay/gateway/get/**              # æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”±
  - Cookie=username,cdd
```



#### ...

Headerã€Hostã€Pathã€Queryã€RemoteAddrã€Method

- **Header**

  ä¸¤ä¸ªå‚æ•°ï¼šä¸€ä¸ªæ˜¯å±æ€§åç§°å’Œä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿™ä¸ªå±æ€§å€¼å’Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åˆ™æ‰§è¡Œã€‚

- **Host**

  Host Route Predicate æ¥æ”¶ä¸€ç»„å‚æ•°ï¼Œä¸€ç»„åŒ¹é…çš„åŸŸååˆ—è¡¨ï¼Œè¿™ä¸ªæ¨¡æ¿æ˜¯ä¸€ä¸ª ant åˆ†éš”çš„æ¨¡æ¿ï¼Œç”¨.å·ä½œä¸ºåˆ†éš”ç¬¦ã€‚

  å®ƒé€šè¿‡å‚æ•°ä¸­çš„ä¸»æœºåœ°å€ä½œä¸ºåŒ¹é…è§„åˆ™

- **Query**

  æ”¯æŒä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å±æ€§åï¼Œä¸€ä¸ªä¸ºå±æ€§å€¼ï¼Œå±æ€§å€¼å¯ä»¥æ˜¯æ­£åˆ™è¡¨è¾¾å¼ã€‚

- **RemoteAddr**

  [<img src="https://s21.ax1x.com/2024/08/05/pkvQz8K.png" alt="pkvQz8K.png" style="zoom: 50%;" />](https://imgse.com/i/pkvQz8K)









```yaml
predicates:
	- Path=/pay/gateway/get/**              # æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”±
	- After=2023-11-20T17:38:13.586918800+08:00[Asia/Shanghai]
	- Before=2023-12-29T17:58:13.586918800+08:00[Asia/Shanghai]
	- Between=2023-11-21T17:38:13.586918800+08:00[Asia/Shanghai],2023-11-22T17:38:13.586918800+08:00[Asia/Shanghai]
	- Cookie=username,zzyy
    - Header=X-Request-Id, \d+  # è¯·æ±‚å¤´è¦æœ‰X-Request-Idå±æ€§å¹¶ä¸”å€¼ä¸ºæ•´æ•°çš„æ­£åˆ™è¡¨è¾¾å¼
    - Host=**.atguigu.com
    - Query=username, \d+  # è¦æœ‰å‚æ•°åusernameå¹¶ä¸”å€¼è¿˜è¦æ˜¯æ•´æ•°æ‰èƒ½è·¯ç”±
    - RemoteAddr=192.168.124.1/24 # å¤–éƒ¨è®¿é—®æˆ‘çš„IPé™åˆ¶ï¼Œæœ€å¤§è·¨åº¦ä¸è¶…è¿‡32ï¼Œç›®å‰æ˜¯1~24å®ƒä»¬æ˜¯ CIDR è¡¨ç¤ºæ³•ã€‚
    - Method=GET,POST
```

#### å°ç»“

Predicateå°±æ˜¯ä¸ºäº†å®ç°ä¸€ç»„åŒ¹é…è§„åˆ™ï¼Œè®©è¯·æ±‚è¿‡æ¥æ‰¾åˆ°å¯¹åº”çš„Routeè¿›è¡Œå¤„ç†ã€‚



#### è‡ªå®šä¹‰æ–­è¨€

XxxRoutePredicateFactoryè§„åˆ™





### Filterè¿‡æ»¤

#### æ¦‚è¿°

å®˜ç½‘

https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories

â‰ˆ Spring MVCä¸­çš„æ‹¦æˆªå™¨

ä½œç”¨

1. è¯·æ±‚é‰´æƒ
2. å¼‚å¸¸å¤„ç†ï¼ˆæœ‰å¼‚å¸¸å°±é‡å®šå‘ï¼‰
3. è®°å½•æ¥å£è°ƒç”¨æ—¶é•¿ç»Ÿè®¡



è¿‡æ»¤å™¨ç±»å‹

1. å…¨å±€é»˜è®¤è¿‡æ»¤å™¨Global Filters

   å‡ºå‚é»˜è®¤ï¼Œç›´æ¥ä½œç”¨äºæ‰€æœ‰è·¯ç”±ï¼›ä¸éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œå®ç°GlobalFilterå³å¯

2. å•ä¸€å†…ç½®è¿‡æ»¤å™¨Gateway Filters

   ç½‘å…³è¿‡æ»¤å™¨ï¼Œä¸»è¦ä½œç”¨äºå•ä¸€è·¯ç”±æˆ–æŸä¸ªè·¯ç”±åˆ†ç»„

3. è‡ªå®šä¹‰è¿‡æ»¤å™¨

#### å…¨å±€é»˜è®¤è¿‡æ»¤å™¨Global Filters

å®˜ç½‘æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#global-filters

å¾ˆå°‘ä½¿ç”¨ï¼Œç•¥..



#### å•ä¸€å†…ç½®è¿‡æ»¤å™¨Gateway Filter

å®˜ç½‘æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories

##### éƒ¨åˆ†é…ç½®

**- è¯·æ±‚å¤´ç¯‡**

```yaml
- id: pay_routh3 #pay_routh3
  uri: lb://cloud-payment-service                #åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€
  predicates:
    - Path=/pay/gateway/filter/**              # æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”±
  filters:
    - AddRequestHeader=X-Request-xxx1,xxx1  # è¯·æ±‚å¤´kvï¼Œè‹¥ä¸€å¤´å«æœ‰å¤šå‚åˆ™é‡å†™ä¸€è¡Œè®¾ç½®
    - AddRequestHeader=X-Request-xxx2,xxx2
```



**- è¯·æ±‚å‚æ•°ç¯‡**

```yaml
filters:
  - AddRequestParameter=customerId,9527001 # æ–°å¢è¯·æ±‚å‚æ•°Parameterï¼šk ï¼Œv
  - RemoveRequestParameter=customerName   # åˆ é™¤urlè¯·æ±‚å‚æ•°customerNameï¼Œä½ ä¼ é€’è¿‡æ¥ä¹Ÿæ˜¯null
```



**- å“åº”å¤´ç¯‡**

... å…¶ä»–æƒ…å†µï¼Œè¯·å‚è€ƒgiteeæäº¤è®°å½•



#### å…¨å±€é€šç”¨é…ç½®

**æ ¼å¼å¦‚ä¸‹ï¼š**

[![pkxQyyF.png](https://s21.ax1x.com/2024/08/06/pkxQyyF.png)](https://imgse.com/i/pkxQyyF)





#### è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨

ç»Ÿè®¡æ¥å£è°ƒç”¨è€—æ—¶æƒ…å†µï¼Œè°ˆè°ˆè®¾è®¡æ€è·¯ï¼š





# SpringCloud Alibaba

## æ¦‚è¿°

å®˜æ–¹æ–‡æ¡£ï¼š

[spring-cloud-alibaba/README-zh.md at 2023.x Â· alibaba/spring-cloud-alibaba Â· GitHub](https://github.com/alibaba/spring-cloud-alibaba/blob/2023.x/README-zh.md)



- **Sentinel**

  æŠŠæµé‡ä½œä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§

- **Nacos**

  åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°

- **Seata**

  å¾®æœåŠ¡åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ

ä¸Šè¿°ä¸»è¦ä½¿ç”¨ï¼ŒSpringCloudAlibabaå…¶ä»–ç»„ä»¶ï¼š

- Rocket
- Alibaba Cloud OSS
- Alibaba Cloud SchedulerX
- Alibaba Cloud SMS



[![pkxdRTf.png](https://s21.ax1x.com/2024/08/06/pkxdRTf.png)](https://imgse.com/i/pkxdRTf)























## æ–‡æ¡£åœ°å€

### ç‰ˆæœ¬è¯´æ˜

https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E



### å‚è€ƒæ–‡æ¡£

https://spring-cloud-alibaba-group.github.io/github-pages/2022/zh-cn/2022.0.0.0-RC2.html





# Nacos - æœåŠ¡æ³¨å†Œå’Œé…ç½®ä¸­å¿ƒ

## æ¦‚è¿°

[Nacoså®˜ç½‘| Nacos é…ç½®ä¸­å¿ƒ | Nacos ä¸‹è½½| Nacos å®˜æ–¹ç¤¾åŒº | Nacos å®˜ç½‘](https://nacos.io/)

ä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°

Nacos = Eureka + Config + Busï¼ˆEurekaæ³¨å†Œä¸­å¿ƒï¼ŒConfig+BusæœåŠ¡é…ç½®ä¸­å¿ƒï¼Œæ»¡è¶³åŠ¨æ€åˆ·æ–°å¹¿æ’­é€šçŸ¥ï¼‰

= Spring Cloud Consul

[<img src="https://s21.ax1x.com/2024/08/06/pkxwe9e.png" alt="pkxwe9e.png" style="zoom:50%;" />](https://imgse.com/i/pkxwe9e)















[<img src="https://s21.ax1x.com/2024/08/06/pkxwIUK.png" alt="pkxwIUK.png" style="zoom: 50%;" />](https://imgse.com/i/pkxwIUK)













## å¿«é€Ÿå¼€å§‹ï¼ˆæœåŠ¡è€…å’Œæ¶ˆè´¹è€…ï¼‰

1. å®‰è£…

2. å¯åŠ¨

   binç›®å½•ä¸‹æ‰§è¡Œ`startup.cmd -m standalone`

3. é¡µé¢

   http://localhost:8848/nacos

4. ä¸­æ–‡å‚è€ƒæ–‡æ¡£ï¼ˆ2022ï¼‰

   https://spring-cloud-alibaba-group.github.io/github-pages/2022/zh-cn/2022.0.0.0-RC2.html
   
5. æ–°å»ºæœåŠ¡æä¾›è€…ï¼š

   **ä¾èµ–ï¼ˆnacosä¾èµ–ï¼‰**

   ```xml
   <dependency>
       <groupId>com.alibaba.cloud</groupId>
       <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
   </dependency>
   ```

   **é…ç½®**

   ```yaml
   server:
     port: 9001
   spring:
     application:
       name: nacos-payment-provider
     cloud:
       nacos:
         discovery:
           #é…ç½®Nacosåœ°å€
           server-addr: localhost:8848
   ```

   **å¯åŠ¨ç±»**

   ```java
   @SpringBootApplication
   @EnableDiscoveryClient
   public class Main9001 {
       public static void main(String[] args) {
           SpringApplication.run(Main9001.class, args);
       }
   }
   ```

6. æ–°å»ºæœåŠ¡æ¶ˆè´¹è€…

   **ä¾èµ–**

   ```xml
   <!--nacos-discovery-->
   <dependency>
       <groupId>com.alibaba.cloud</groupId>
       <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
   </dependency>
   <!--loadbalancer-->
   <dependency>
       <groupId>org.springframework.cloud</groupId>
       <artifactId>spring-cloud-starter-loadbalancer</artifactId>
   </dependency>
   ```

   **é…ç½®é¡¹**

   ```yaml
   server:
     port: 83
   spring:
     application:
       name: nacos-order-consumer
     cloud:
       nacos:
         discovery:
           server-addr: localhost:8848
   #æ¶ˆè´¹è€…å°†è¦å»è®¿é—®çš„å¾®æœåŠ¡åç§°(nacoså¾®æœåŠ¡æä¾›è€…å«ä»€ä¹ˆä½ å†™ä»€ä¹ˆ)
   service-url:
     nacos-user-service: http://nacos-payment-provider
   ```

   **å¯åŠ¨ç±»**

   ```java
   @EnableDiscoveryClient
   @SpringBootApplication
   public class Main83 {
       public static void main(String[] args) {
           SpringApplication.run(Main83.class, args);
       }
   }
   ```



## Nacosä½œé…ç½®ä¸­å¿ƒ

å®˜æ–¹æ–‡æ¡£

[Spring Cloud Alibaba å‚è€ƒæ–‡æ¡£ (spring-cloud-alibaba-group.github.io)](https://spring-cloud-alibaba-group.github.io/github-pages/2022/zh-cn/2022.0.0.0-RC2.html#_spring_cloud_alibaba_nacos_config)



### å®ç°å¤–éƒ¨åŒ–éƒ¨ç½²

#### **ä¾èµ–** 

é…ç½®ä¸­å¿ƒæ‰€éœ€é…ç½®å¦‚ä¸‹ï¼Œå½“ç„¶åœ¨Nacosä½“ç³»ä¸­è¿˜éœ€è¦è¢«æ³¨å†Œä¸­å¿ƒå‘ç°ï¼Œå› æ­¤è‡³å°‘éœ€è¦å¼•å…¥nacos-discoveryçš„ä¾èµ–

```xml
<!--bootstrap-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
<!--nacos-config-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```



#### **é…ç½®æ–‡ä»¶** 

éœ€è¦ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼šbootstrap.ymlå’Œapplication.yml

- bootstrap.yml

```yaml
# nacosé…ç½®
spring:
  application:
    name: nacos-config-client
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #NacosæœåŠ¡æ³¨å†Œä¸­å¿ƒåœ°å€
      config:
        server-addr: localhost:8848 #Nacosä½œä¸ºé…ç½®ä¸­å¿ƒåœ°å€
        file-extension: yaml #æŒ‡å®šyamlæ ¼å¼çš„é…ç½®
		group: PROD_GROUP #ä¸å†™é»˜è®¤æŒ‰ç…§DEFAULTæ¥
# nacosç«¯é…ç½®æ–‡ä»¶DataIdçš„å‘½åè§„åˆ™æ˜¯ï¼š
# ${spring.application.name}-${spring.profile.active}.${spring.cloud.nacos.config.file-extension}
# æœ¬æ¡ˆä¾‹çš„DataIDæ˜¯:nacos-config-client-dev.yaml
```



- application.yml

```yml
server:
  port: 3377
spring:
  profiles:
    active: dev # è¡¨ç¤ºå¼€å‘ç¯å¢ƒ
       #active: prod # è¡¨ç¤ºç”Ÿäº§ç¯å¢ƒ
       #active: test # è¡¨ç¤ºæµ‹è¯•ç¯å¢ƒ
```



#### **ä¸»å¯åŠ¨**

```java
@EnableDiscoveryClient
@SpringBootApplication
public class NacosConfigClient3377 {
    public static void main(String[] args) {
        SpringApplication.run(NacosConfigClient3377.class, args);
    }
}
```



#### **ä¸šåŠ¡ç±»**

> é€šè¿‡Spring CloudåŸç”Ÿæ³¨è§£ **@RefreshScope** å®ç°é…ç½®è‡ªåŠ¨æ›´æ–°

```java
@RestController
@RefreshScope //åœ¨æ§åˆ¶å™¨ç±»åŠ å…¥@RefreshScopeæ³¨è§£ä½¿å½“å‰ç±»ä¸‹çš„é…ç½®æ”¯æŒNacosçš„åŠ¨æ€åˆ·æ–°åŠŸèƒ½ã€‚
public class NacosConfigClientController {
    @Value("${config.info}")
    private String configInfo;

    @GetMapping("/config/info")
    public String getConfigInfo() {
        return configInfo;
    }
}
```



#### Nacosæ·»åŠ é…ç½®ä¿¡æ¯

å®˜ç½‘

https://nacos.io/zh-cn/docs/v2/ecology/use-nacos-with-spring-cloud.html

> åœ¨ Nacos Spring Cloud ä¸­ï¼Œ**`dataId`** çš„å®Œæ•´æ ¼å¼å¦‚ä¸‹ï¼š
>
> ```plain
> ${prefix}-${spring.profiles.active}.${file-extension}
> ```
>
> - **`prefix`** é»˜è®¤ä¸º**`spring.application.name`**çš„å€¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®é¡¹ **`spring.cloud.nacos.config.prefix`**æ¥é…ç½®ã€‚
> - **`spring.profiles.active`** å³ä¸ºå½“å‰ç¯å¢ƒå¯¹åº”çš„ profileï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒ [Spring Bootæ–‡æ¡£](https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html#boot-features-profiles)ã€‚ **æ³¨æ„ï¼šå½“ `spring.profiles.active` ä¸ºç©ºæ—¶ï¼Œå¯¹åº”çš„è¿æ¥ç¬¦ `-` ä¹Ÿå°†ä¸å­˜åœ¨ï¼ŒdataId çš„æ‹¼æ¥æ ¼å¼å˜æˆ `${prefix}.${file-extension}`**
> - **`file-exetension` **ä¸ºé…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ **`spring.cloud.nacos.config.file-extension`** æ¥é…ç½®ã€‚ç›®å‰åªæ”¯æŒ **`properties`** å’Œ **`yaml`** ç±»å‹ã€‚



#### å¤šç¯å¢ƒå¤šé¡¹ç›®ç®¡ç†

> **é—®é¢˜1ï¼š**
>
> å®é™…å¼€å‘ä¸­ï¼Œé€šå¸¸ä¸€ä¸ªç³»ç»Ÿä¼šå‡†å¤‡
>
> devå¼€å‘ç¯å¢ƒ
>
> testæµ‹è¯•ç¯å¢ƒ
>
> prodç”Ÿäº§ç¯å¢ƒã€‚
>
> å¦‚ä½•ä¿è¯æŒ‡å®šç¯å¢ƒå¯åŠ¨æ—¶æœåŠ¡èƒ½æ­£ç¡®è¯»å–åˆ°Nacosä¸Šç›¸åº”ç¯å¢ƒçš„é…ç½®æ–‡ä»¶å‘¢ï¼Ÿ
>
>  
>
> **é—®é¢˜2ï¼š**
>
> ä¸€ä¸ªå¤§å‹åˆ†å¸ƒå¼å¾®æœåŠ¡ç³»ç»Ÿä¼šæœ‰å¾ˆå¤šå¾®æœåŠ¡å­é¡¹ç›®ï¼Œ
>
> æ¯ä¸ªå¾®æœåŠ¡é¡¹ç›®åˆéƒ½ä¼šæœ‰ç›¸åº”çš„å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€é¢„å‘ç¯å¢ƒã€æ­£å¼ç¯å¢ƒ......
>
> é‚£æ€ä¹ˆå¯¹è¿™äº›å¾®æœåŠ¡é…ç½®è¿›è¡Œåˆ†ç»„å’Œå‘½åç©ºé—´ç®¡ç†å‘¢ï¼Ÿ

Nacosæ¶æ„æ–‡æ¡£ï¼š[Nacos æ¶æ„](https://nacos.io/zh-cn/docs/architecture.html)

<img src="https://cdn.nlark.com/yuque/0/2019/jpeg/338441/1561217857314-95ab332c-acfb-40b2-957a-aae26c2b5d71.jpeg" alt="nacos_data_model" style="zoom:50%;" />





# Sentinel - ç†”æ–­ä¸é™æµ

## æ¦‚è¿°

**å®˜ç½‘**

[home | Sentinel (sentinelguard.io)](https://sentinelguard.io/zh-cn/)

> **From å®˜ç½‘ï¼š**
>
> éšç€å¾®æœåŠ¡çš„æµè¡Œï¼ŒæœåŠ¡å’ŒæœåŠ¡ä¹‹é—´çš„ç¨³å®šæ€§å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚Sentinel æ˜¯é¢å‘åˆ†å¸ƒå¼ã€å¤šè¯­è¨€å¼‚æ„åŒ–æœåŠ¡æ¶æ„çš„æµé‡æ²»ç†ç»„ä»¶ï¼Œä¸»è¦ä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡è·¯ç”±ã€æµé‡æ§åˆ¶ã€æµé‡æ•´å½¢ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè‡ªé€‚åº”è¿‡è½½ä¿æŠ¤ã€çƒ­ç‚¹æµé‡é˜²æŠ¤ç­‰å¤šä¸ªç»´åº¦æ¥å¸®åŠ©å¼€å‘è€…ä¿éšœå¾®æœåŠ¡çš„ç¨³å®šæ€§ã€‚



## å¿«é€Ÿå¼€å§‹

### å¯åŠ¨sentinel

- sentinel-1.8.6ä¸‹è½½é“¾æ¥

  https://github.com/alibaba/Sentinel/releases/download/1.8.6/sentinel-dashboard-1.8.6.jar

- ç›´æ¥java -jarè¿è¡Œ

- é»˜è®¤8080ç«¯å£ï¼Œè´¦å·å¯†ç é»˜è®¤sentinel

- sentinelæœåŠ¡å¯åŠ¨æˆåŠŸï¼ï¼ï¼



### åˆ›å»ºä¸€ä¸ªè¢«sentinelç®¡ç†çš„æœåŠ¡

#### 1. ä¾èµ–

```xml
<!--SpringCloud alibaba sentinel -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```

#### 2. é…ç½®æ–‡ä»¶

```yaml
server:
  port: 8401
spring:
  application:
    name: cloudalibaba-sentinel-service
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848         #NacosæœåŠ¡æ³¨å†Œä¸­å¿ƒåœ°å€
    sentinel:
      transport:
        dashboard: localhost:8080 #é…ç½®Sentinel dashboardæ§åˆ¶å°æœåŠ¡åœ°å€
        port: 8719 #é»˜è®¤8719ç«¯å£ï¼Œå‡å¦‚è¢«å ç”¨ä¼šè‡ªåŠ¨ä»8719å¼€å§‹ä¾æ¬¡+1æ‰«æ,ç›´è‡³æ‰¾åˆ°æœªè¢«å ç”¨çš„ç«¯å£
```

#### 3. å…¶ä»–æ³¨æ„äº‹é¡¹

- å¯åŠ¨ç±»ä¸ŠåŠ ä¸Šnacos discoveræ³¨è§£
- ç¼–å†™ä¸¤ä¸ªæ¥å£æ¨¡æ‹Ÿä¸šåŠ¡ç±»
- å¯åŠ¨...

#### Next

æŒ‰ç…§å¦‚ä¸Šæ­¥éª¤åˆ›å»ºå®Œæ¯•åï¼Œè®¿é—®sentinelæ§åˆ¶å°æ˜¯ç©ºçš„

å› ä¸ºsentinelé‡‡ç”¨çš„æ˜¯æ‡’åŠ è½½ï¼Œéœ€è¦æ‰‹åŠ¨è®¿é—®ä¸€æ¬¡ç›¸å…³æ¥å£ï¼Œä»¤sentinelæ£€æµ‹åˆ°



## æµé‡æ§åˆ¶ï¼ˆé™æµï¼‰ - æµæ§æ¨¡å¼

æ–‡æ¡£ï¼š[flow-control | Sentinel (sentinelguard.io)](https://sentinelguard.io/zh-cn/docs/flow-control.html)

- ç›´æ¥
- å…³è”
- é“¾è·¯

### æ ¹æ®è°ƒç”¨æ–¹é™æµ - ç›´æ¥ï¼ˆé»˜è®¤ï¼‰

å½“æŸä¸ªæ¥å£çš„ **QPS / å¹¶å‘çº¿ç¨‹æ•°** è¾¾åˆ°æŸä¸ªé˜ˆå€¼

å°†æ‹’ç»æ–°çš„è¯·æ±‚è¿›å…¥



### å…·æœ‰å…³ç³»çš„èµ„æºæµé‡æ§åˆ¶ï¼šå…³è”æµé‡æ§åˆ¶

> **ä¸ºAèµ„æºç»‘å®šBèµ„æºï¼Œå½“Bèµ„æºè§¦å‘åˆ°æŸä¸ªé˜ˆå€¼çš„æ—¶å€™ï¼Œéœ€è¦å¯¹Aèµ„æºè¿›è¡Œé™æµ**
>
> ï¼ˆä¸¤è€…å­˜åœ¨èµ„æºäº‰æŠ¢å…³ç³»orä¾èµ–å…³ç³»ï¼Œå°±å¯ä»¥å…·å¤‡å…³è”ï¼‰
>

**æ¡ˆä¾‹ï¼š**

ç”¨æˆ·æ“ä½œè®¢å•çš„åœºæ™¯ä¸­ï¼Œéœ€è°ƒç”¨è®¢å•æ›´æ–°æ“ä½œï¼ˆå†™ï¼‰å’Œè®¢å•æŸ¥è¯¢æ“ä½œï¼ˆè¯»ï¼‰

å†™å…¥ä¼˜å…ˆçº§ > è¯»å–ä¼˜å…ˆçº§ï¼Œå½“å†™å…¥æ“ä½œè¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œéœ€å¯¹æŸ¥è¯¢æ“ä½œè¿›è¡Œé™æµ

é™æµç”Ÿæ•ˆæ—¶ï¼Œè®¢å•ï¼ˆBï¼‰æ›´æ–°å¯ä»¥æ­£å¸¸è®¿é—®ï¼ŒæŸ¥è¯¢ï¼ˆAï¼‰ä¼šè§¦å‘é™æµæç¤º

**ä½œç”¨ï¼š**

èµ„æºäº‰æŠ¢å…³ç³»ï¼šé˜²æ­¢ä¼˜å…ˆçº§ä½çš„æ“ä½œå½±å“åˆ°ä¼˜å…ˆçº§é«˜çš„æ“ä½œ

ä¸Šä¸‹æ¸¸ï¼ˆä¾èµ–ï¼‰å…³ç³»ï¼š...



### æ ¹æ®è°ƒç”¨é“¾è·¯å…¥å£é™æµï¼šé“¾è·¯é™æµ

> **æ¥è‡ªä¸åŒé“¾è·¯çš„è¯·æ±‚ï¼Œå¯¹åŒä¸€ä¸ªç›®æ ‡è®¿é—®çš„æ—¶å€™ï¼Œå®æ–½é’ˆå¯¹æ€§çš„ä¸åŒé™æµæªæ–½**
>
> å¦‚ï¼šCè¯·æ±‚æ¥è®¿é—®å°±é™æµï¼ŒDè¯·æ±‚æ¥è®¿é—®OK
>
> /testCå’Œ/testDè®¿é—®åŒä¸€ä¸ªserviceï¼Œè¾¾åˆ°é˜ˆå€¼åï¼Œå¯¹Cé™æµï¼Œä¸å½±å“D

#### æ¨¡æ‹Ÿ

1. æ–°å¢service.common()

   ```java
   @Service
   public class FlowLimitService {
       @SentinelResource(value = "common")
       public void common() {
           System.out.println("------FlowLimitService come in");
       }
   }
   ```

2. æ–°å¢testCã€testDæ¥å£ï¼Œè°ƒç”¨common

   ```java
   @Resource
   private FlowLimitService flowLimitService;
   
   @GetMapping("/testC")
   public String testC() {
       flowLimitService.common();
       return "------testC";
   }
   @GetMapping("/testD")
   public String testD() {
       flowLimitService.common();
       return "------testD";
   }
   ```

3. æ–°å¢é…ç½®é¡¹

   > Sentinelé»˜è®¤ä¼šå°†Controlleræ–¹æ³•åšcontextæ•´åˆï¼Œå¯¼è‡´é“¾è·¯æ¨¡å¼çš„æµæ§å¤±æ•ˆ
   >
   > éœ€è¦ä¿®æ”¹application.ymlï¼Œæ·»åŠ é…ç½® web-context-unify: false ï¼Œè¡¨ç¤ºå…³é—­

   ```yaml
   # controllerå±‚çš„æ–¹æ³•å¯¹serviceå±‚è°ƒç”¨ä¸è®¤ä¸ºæ˜¯åŒä¸€ä¸ªæ ¹é“¾è·¯
   spring.cloud.sentinel. web-context-unify: false 
   ```

4. sentinelæ§åˆ¶å°ä¸­é…ç½®

   [<img src="https://s21.ax1x.com/2024/08/12/pAp81iQ.png" alt="pAp81iQ.png" style="zoom: 33%;" />](https://imgse.com/i/pAp81iQ)

























## æµé‡æ§åˆ¶ï¼ˆé™æµï¼‰ - æµæ§æ•ˆæœ

- å¿«é€Ÿå¤±è´¥

- é¢„çƒ­Warm Up

  [é™æµ å†·å¯åŠ¨ Â· alibaba/Sentinel Wiki Â· GitHub](https://github.com/alibaba/Sentinel/wiki/é™æµ---å†·å¯åŠ¨)

  **å…¬å¼ï¼š** é˜ˆå€¼é™¤ä»¥å†·å´å› å­coldFactorï¼ˆé»˜è®¤å€¼ä¸º3ï¼‰ï¼Œç»è¿‡é¢„çƒ­æ—¶é•¿åæ‰ä¼šè¾¾åˆ°é˜ˆå€¼

  **æ¡ˆä¾‹ï¼š** 5såå³°å€¼è¾¾åˆ°10

  <img src="D:\File\markdownPictures\image-20240812145756528.png" alt="image-20240812145756528" style="zoom:33%;" />

  **åº”ç”¨åœºæ™¯ï¼š** ç§’æ€ä¸šåŠ¡å¼€å§‹çš„ç¬é—´ä¼šæœ‰å¾ˆå¤šæµé‡ä¸Šæ¥ï¼Œå¯èƒ½ä¼šæŠŠç³»ç»Ÿæ‰“æ­»ï¼Œä¸€å¼€å§‹æœåŠ¡å™¨æ¥å—å°‘é‡è¯·æ±‚ï¼Œå½“é¢„çƒ­äº†ä¸€å®šæ—¶é—´åï¼Œå…è®¸æ¥å—å³°å€¼çš„è¯·æ±‚

  > å¤§ç™½è¯æ¥è®²ï¼Œåˆšå¼€å§‹æŠŠ é˜ˆå€¼è°ƒä½ï¼Œä¸è¦è®©è¿‡å¤šçš„è¯·æ±‚è®¿é—®æœåŠ¡å™¨ï¼Œå¯¼è‡´å†²å®æœåŠ¡å™¨ï¼Œå…ˆè®©æœåŠ¡å™¨ä¸€ç‚¹ä¸€ç‚¹å¤„ç†ï¼Œå†æ…¢æ…¢åŠ é‡ã€‚ç»å…¸çš„ä¾‹å­ï¼šä¸€ä¸ªå¥½ä¹…æ²¡è¿åŠ¨çš„äººï¼Œä½ åˆšå¼€å§‹è®©ä»–è·‘10åœˆï¼Œä»–å¯èƒ½ä¼šç´¯æ­»ï¼Œä½†æ˜¯ä½ ç»™ä»–ä¸€ä¸ªé¢„çƒ­æ—¶é—´ï¼Œæ¯”å¦‚ ç¬¬ä¸€å¤©è·‘ 2åœˆï¼Œç¬¬ä¸‰å¤©è·‘ 3 åœˆï¼Œç¬¬å››å¤©è·‘4åœˆï¼Œä»¥æ­¤ç±»æ¨...
  >
  > å¼•è‡ªï¼š[sentinel æ§åˆ¶å°è®²è§£-æµæ§è§„åˆ™--æµæ§æ•ˆæœ:Warm Up(é¢„çƒ­)_sentinel warm up-CSDNåšå®¢](https://blog.csdn.net/qq_41712271/article/details/118336309)

- æ’é˜Ÿç­‰å¾…





## ç†”æ–­é™çº§

### ç†”æ–­ç­–ç•¥

> åœ¨ç»Ÿè®¡æ—¶é•¿å†…ï¼Œè¯·æ±‚æ•°é‡>æœ€å°è¯·æ±‚æ•°æ—¶ï¼Œå¼€å§‹è®¡ç®—æ¯”ä¾‹é˜ˆå€¼
>
> å¦‚æœæ…¢è°ƒç”¨æ¯”ä¾‹/å¼‚å¸¸æ¯”ä¾‹ï¼Œè¾¾åˆ°æ¯”ä¾‹é˜ˆå€¼ï¼Œå°±è¿›å…¥ç†”æ–­ï¼ˆå¼‚å¸¸æ•°åŒç†ï¼‰
>
> ç†”æ–­æ—¶é—´è¾¾åˆ°ç†”æ–­æ—¶é•¿åï¼Œå¼€å§‹æ–°çš„è¯·æ±‚å°è¯•ï¼ˆåŠå¼€çŠ¶æ€ï¼‰

1. æ…¢è°ƒç”¨æ¯”ä¾‹

[<img src="https://s21.ax1x.com/2024/08/12/pApJ25D.png" alt="pApJ25D.png" style="zoom:50%;" />](https://imgse.com/i/pApJ25D)



















\

2. å¼‚å¸¸æ¯”ä¾‹ ...
3. å¼‚å¸¸æ•° ... 



## é™æµä¹‹ - @SentinelResource

**æºç **

```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Inherited
public @interface SentinelResource {

    //èµ„æºåç§°
    String value() default "";

    //entryç±»å‹ï¼Œæ ‡è®°æµé‡çš„æ–¹å‘ï¼Œå–å€¼IN/OUTï¼Œé»˜è®¤æ˜¯OUT
    EntryType entryType() default EntryType.OUT;
    //èµ„æºåˆ†ç±»
    int resourceType() default 0;

    //å¤„ç†BlockExceptionçš„å‡½æ•°åç§°,å‡½æ•°è¦æ±‚ï¼š
    //1. å¿…é¡»æ˜¯ public
    //2.è¿”å›ç±»å‹ å‚æ•°ä¸åŸæ–¹æ³•ä¸€è‡´
    //3. é»˜è®¤éœ€å’ŒåŸæ–¹æ³•åœ¨åŒä¸€ä¸ªç±»ä¸­ã€‚è‹¥å¸Œæœ›ä½¿ç”¨å…¶ä»–ç±»çš„å‡½æ•°ï¼Œå¯é…ç½®blockHandlerClass ï¼Œå¹¶æŒ‡å®šblockHandlerClassé‡Œé¢çš„æ–¹æ³•ã€‚
    String blockHandler() default "";

    //å­˜æ”¾blockHandlerçš„ç±»,å¯¹åº”çš„å¤„ç†å‡½æ•°å¿…é¡»staticä¿®é¥°ã€‚
    Class<?>[] blockHandlerClass() default {};

    //ç”¨äºåœ¨æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™æä¾›fallbackå¤„ç†é€»è¾‘ã€‚ fallbackå‡½æ•°å¯ä»¥é’ˆå¯¹æ‰€
    //æœ‰ç±»å‹çš„å¼‚å¸¸ï¼ˆé™¤äº† exceptionsToIgnore é‡Œé¢æ’é™¤æ‰çš„å¼‚å¸¸ç±»å‹ï¼‰è¿›è¡Œå¤„ç†ã€‚å‡½æ•°è¦æ±‚ï¼š
    //1. è¿”å›ç±»å‹ä¸åŸæ–¹æ³•ä¸€è‡´
    //2. å‚æ•°ç±»å‹éœ€è¦å’ŒåŸæ–¹æ³•ç›¸åŒ¹é…
    //3. é»˜è®¤éœ€å’ŒåŸæ–¹æ³•åœ¨åŒä¸€ä¸ªç±»ä¸­ã€‚è‹¥å¸Œæœ›ä½¿ç”¨å…¶ä»–ç±»çš„å‡½æ•°ï¼Œå¯é…ç½®fallbackClass ï¼Œå¹¶æŒ‡å®šfallbackClassé‡Œé¢çš„æ–¹æ³•ã€‚
    String fallback() default "";

    //å­˜æ”¾fallbackçš„ç±»ã€‚å¯¹åº”çš„å¤„ç†å‡½æ•°å¿…é¡»staticä¿®é¥°ã€‚
    String defaultFallback() default "";

    //ç”¨äºé€šç”¨çš„ fallback é€»è¾‘ã€‚é»˜è®¤fallbackå‡½æ•°å¯ä»¥é’ˆå¯¹æ‰€æœ‰ç±»å‹çš„å¼‚å¸¸è¿›
    //è¡Œå¤„ç†ã€‚è‹¥åŒæ—¶é…ç½®äº† fallback å’Œ defaultFallbackï¼Œä»¥fallbackä¸ºå‡†ã€‚å‡½æ•°è¦æ±‚ï¼š
    //1. è¿”å›ç±»å‹ä¸åŸæ–¹æ³•ä¸€è‡´
    //2. æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸ºç©ºï¼Œæˆ–è€…æœ‰ä¸€ä¸ª Throwable ç±»å‹çš„å‚æ•°ã€‚
    //3. é»˜è®¤éœ€è¦å’ŒåŸæ–¹æ³•åœ¨åŒä¸€ä¸ªç±»ä¸­ã€‚è‹¥å¸Œæœ›ä½¿ç”¨å…¶ä»–ç±»çš„å‡½æ•°ï¼Œå¯é…ç½®fallbackClass ï¼Œå¹¶æŒ‡å®š fallbackClass é‡Œé¢çš„æ–¹æ³•ã€‚
    Class<?>[] fallbackClass() default {};


    //éœ€è¦traceçš„å¼‚å¸¸
    Class<? extends Throwable>[] exceptionsToTrace() default {Throwable.class};

    //æŒ‡å®šæ’é™¤å¿½ç•¥æ‰å“ªäº›å¼‚å¸¸ã€‚æ’é™¤çš„å¼‚å¸¸ä¸ä¼šè®¡å…¥å¼‚å¸¸ç»Ÿè®¡ï¼Œä¹Ÿä¸ä¼šè¿›å…¥fallbacké€»è¾‘ï¼Œè€Œæ˜¯åŸæ ·æŠ›å‡ºã€‚
    Class<? extends Throwable>[] exceptionsToIgnore() default {};
}
```



**æŒ‰èµ„æºåé™æµï¼Œä½¿ç”¨è‡ªå®šä¹‰è¿”å›ä¿¡æ¯**

sentinelä¸­æ–°å¢æµæ§ä¿¡æ¯ï¼Œèµ„æºåè¦å¡«å†™æ³¨è§£ä¸­çš„valueå€¼ï¼Œå¦åˆ™æ— æ³•ç”Ÿæ•ˆã€‚

ä¸å¯ä»¥å¡«å†™è·¯å¾„ï¼

```java
@GetMapping("/rateLimit/byResource")
@SentinelResource(value = "byResourceSentinelResource", blockHandler = "handleException")
public String byResource() {
    return "æŒ‰èµ„æºåç§°SentinelResourceé™æµæµ‹è¯•OK";
}

public String handleException(BlockException exception) {
    return "æœåŠ¡ä¸å¯ç”¨@SentinelResourceå¯åŠ¨" + "\t" + "o(â•¥ï¹â•¥)o";
}
```





**æŒ‰èµ„æºåé™æµï¼Œä½¿ç”¨è‡ªå®šä¹‰è¿”å›ä¿¡æ¯ + æœåŠ¡é™çº§å¤„ç†**

```java
@GetMapping("/rateLimit/doAction/{p1}")
@SentinelResource(value = "doActionSentinelResource",
                  blockHandler = "doActionBlockHandler", fallback = "doActionFallback")
public String doAction(@PathVariable("p1") Integer p1) {
    if (p1 == 0) {
        throw new RuntimeException("p1ç­‰äºé›¶ç›´æ¥å¼‚å¸¸");
    }
    return "doAction";
}

public String doActionBlockHandler(@PathVariable("p1") Integer p1, BlockException e) {
    log.error("sentinelé…ç½®è‡ªå®šä¹‰é™æµäº†:{}", e);
    return "sentinelé…ç½®è‡ªå®šä¹‰é™æµäº†";
}

public String doActionFallback(@PathVariable("p1") Integer p1, Throwable e) {
    log.error("ç¨‹åºé€»è¾‘å¼‚å¸¸äº†:{}", e);
    return "ç¨‹åºé€»è¾‘å¼‚å¸¸äº†" + "\t" + e.getMessage();
}
```

å¦‚æœé…ç½®é™æµï¼Œè¶…è¿‡é˜ˆå€¼åªæ˜¯è¿”å›è‡ªå®šä¹‰ä¿¡æ¯

å¦‚æœé…ç½®çš„é™æµä¸­å‘ç”Ÿäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆå°†è·³è¿‡è‡ªå®šä¹‰é™æµä¿¡æ¯ï¼Œç›´æ¥è°ƒç”¨fallbackå›æ»šæ–¹æ³•

å½“ç„¶åˆšå¦‚æœä¹Ÿè¾¾åˆ°äº†é˜ˆå€¼ï¼Œä¹Ÿä¼šè¿”å›è‡ªå®šä¹‰ä¿¡æ¯

é™æµ ï¼ å¼‚å¸¸ï¼Œéƒ½é™æµäº†ï¼Œè‚¯å®šæ‰§è¡Œä¸åˆ°å¼‚å¸¸å•¦



# Sentinel - çƒ­ç‚¹ä¸æˆæƒ

## çƒ­ç‚¹

[çƒ­ç‚¹å‚æ•°é™æµ Â· alibaba/Sentinel Wiki (github.com)](https://github.com/alibaba/Sentinel/wiki/çƒ­ç‚¹å‚æ•°é™æµ)

çƒ­ç‚¹ = ç»å¸¸è®¿é—®ï¼Œå³ç»Ÿè®¡æˆ–é™åˆ¶æŸä¸ªçƒ­ç‚¹æ•°æ®ä¸­è®¿é—®é¢‘æ¬¡æœ€é«˜çš„Top Kæ•°æ®

å¸Œæœ›å¯¹çƒ­ç‚¹æ•°æ®è®¿é—®è¿›è¡Œé™æµæˆ–å…¶ä»–æ“ä½œ

> **å¼•ç”¨ï¼š**
>
> ä½•ä¸ºçƒ­ç‚¹ï¼Ÿçƒ­ç‚¹å³ç»å¸¸è®¿é—®çš„æ•°æ®ã€‚å¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¸Œæœ›ç»Ÿè®¡æŸä¸ªçƒ­ç‚¹æ•°æ®ä¸­è®¿é—®é¢‘æ¬¡æœ€é«˜çš„ Top K æ•°æ®ï¼Œå¹¶å¯¹å…¶è®¿é—®è¿›è¡Œé™åˆ¶ã€‚æ¯”å¦‚ï¼š
>
> - å•†å“ ID ä¸ºå‚æ•°ï¼Œç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…æœ€å¸¸è´­ä¹°çš„å•†å“ ID å¹¶è¿›è¡Œé™åˆ¶
> - ç”¨æˆ· ID ä¸ºå‚æ•°ï¼Œé’ˆå¯¹ä¸€æ®µæ—¶é—´å†…é¢‘ç¹è®¿é—®çš„ç”¨æˆ· ID è¿›è¡Œé™åˆ¶
>
> çƒ­ç‚¹å‚æ•°é™æµä¼šç»Ÿè®¡ä¼ å…¥å‚æ•°ä¸­çš„çƒ­ç‚¹å‚æ•°ï¼Œå¹¶æ ¹æ®é…ç½®çš„é™æµé˜ˆå€¼ä¸æ¨¡å¼ï¼Œå¯¹åŒ…å«çƒ­ç‚¹å‚æ•°çš„èµ„æºè°ƒç”¨è¿›è¡Œé™æµã€‚çƒ­ç‚¹å‚æ•°é™æµå¯ä»¥çœ‹åšæ˜¯ä¸€ç§ç‰¹æ®Šçš„æµé‡æ§åˆ¶ï¼Œä»…å¯¹åŒ…å«çƒ­ç‚¹å‚æ•°çš„èµ„æºè°ƒç”¨ç”Ÿæ•ˆã€‚

åœ¨sentinelæ§åˆ¶å°ä¸­ï¼Œè®¾ç½®çƒ­ç‚¹é™åˆ¶

éœ€è¦å¡«å…¥å‚æ•°ï¼Œ0è¡¨ç¤ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ1è¡¨ç¤ºç¬¬äºŒä¸ªå‚æ•°ï¼Œä»¥æ­¤ç±»æ¨

å¦‚æœé…ç½®çƒ­ç‚¹ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¾¾åˆ°é˜ˆå€¼åï¼Œæ­¤ååªè¦æºå¸¦ç¬¬ä¸€ä¸ªå‚æ•°çš„è¯·æ±‚å°±ä¼šè¢«é™æµ

### å‚æ•°ä¾‹å¤–é¡¹

å‡è®¾å‚æ•°ä¸€è®¾ç½®çƒ­ç‚¹é™åˆ¶ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨å‚æ•°ä¸€ç­‰äºä¸€ä¸ªç‰¹æ®Šå€¼çš„æ—¶å€™

åŸæœ¬çš„çƒ­ç‚¹é™åˆ¶å¤±æ•ˆï¼Œå‡ºç°ä¾‹å¤–æ“ä½œã€‚é™æµå€¼å’Œå¹³æ—¶ä¸åŒ

å¦‚ï¼šå‚æ•°ä¸€çš„å€¼ä¸º778çš„æ—¶å€™ï¼Œé˜ˆå€¼å¯ä»¥è¾¾åˆ°200æˆ–å…¶ä»–..







## æˆæƒ

å®˜ç½‘ï¼š[é»‘ç™½åå•æ§åˆ¶ Â· alibaba/Sentinel Wiki (github.com)](https://github.com/alibaba/Sentinel/wiki/é»‘ç™½åå•æ§åˆ¶)

éœ€è¦æ ¹æ®è°ƒç”¨æ¥å£çš„æ¥æºåˆ¤æ–­æ˜¯å¦å…è®¸æ‰§è¡Œæœ¬æ¬¡è¯·æ±‚

æä¾›é»‘ã€ç™½åå•ä¸¤ç§æˆæƒç±»å‹ï¼Œåˆ†åˆ«å¯¹åº”ç¦æ­¢ä¸æ”¾è¡Œ

1. æ·»åŠ ä¸çŸ¥é“ä»€ä¹ˆç©æ„çš„å¤„ç†å™¨

   ```java
   @Component
   public class MyRequestOriginParser implements RequestOriginParser {
       @Override
       public String parseOrigin(HttpServletRequest httpServletRequest) {
           return httpServletRequest.getParameter("serverName");
       }
   }
   ```

2. ç„¶åæ·»åŠ æˆæƒè§„åˆ™ï¼Œå¦‚ä¸‹ï¼š

   æ­¤æ—¶å¦‚æœè®¿é—®`/empower?serverName=a`ï¼Œå°†ä¼šè¢«æ‹¦æˆª

   [<img src="https://s21.ax1x.com/2024/08/13/pApsBxf.png" alt="pApsBxf.png" style="zoom: 50%;" />](https://imgse.com/i/pApsBxf)















# Sentinel - è§„åˆ™æŒä¹…åŒ–

## é—®é¢˜

é‡å¯å¾®æœåŠ¡ï¼ŒåŸé…ç½®éƒ½å°†æ¶ˆå¤±ã€å¤±æ•ˆ



## è§£å†³æ–¹æ³•

é™æµé…ç½®è§„åˆ™æŒä¹…åŒ–åˆ°Nacosä¿å­˜

### æ­¥éª¤

1. ä¾èµ–

   ```xml
   <!--SpringCloud ailibaba sentinel-datasource-nacos -->
   <dependency>
       <groupId>com.alibaba.csp</groupId>
       <artifactId>sentinel-datasource-nacos</artifactId>
   </dependency>
   ```

2. é…ç½®æ–‡ä»¶ - é…ç½®spring.cloud.sentinel.datasource

   ```yaml
   spring:
     cloud:
       sentinel:
         datasource:
           ds1:
             nacos:
               server-addr: localhost:8848
               dataId: ${spring.application.name}
               groupId: DEFAULT_GROUP
               data-type: json
               rule-type: flow # com.alibaba.cloud.sentinel.datasource.RuleType
   ```

3. nacosä¸­æ–°å¢å¯¹åº”é…ç½®å³å¯



### é¢˜å¤–è¯..

å½“å‰ç‰ˆæœ¬sentinelä¸æ”¯æŒè‡ªåŠ¨åŒæ­¥åˆ°nacosçš„è¯

å¯èƒ½éœ€è¦è‡ªå·±ä¿®æ”¹sentinelæºç 



# ç»“ ã® å¥¥ä¹‰

## OpenFeign & Sentinel

--> fallbackæœåŠ¡é™çº§

### å‡†å¤‡å·¥ä½œ

1. nacosæ­£å¸¸å¯åŠ¨

2. sentinelæ­£å¸¸å¯åŠ¨

3. ä»»ä½•ä¸€æ–¹éƒ½éœ€è¦å¼•å…¥é€šç”¨apiåŒ…

4. æœåŠ¡æä¾›æ–¹ï¼š

   I.éœ€å¼•å…¥openfeign & sentinel & nacos-discovery

   II.éœ€é…ç½®ymlæ–‡ä»¶ï¼Œæ³¨å†Œåˆ°nacosä¸­ï¼Œå¹¶é…ç½®sentinelåœ°å€

   III.å¯åŠ¨ç±»åŠ ä¸Šæ‰€éœ€æ³¨è§£ ï¼ˆdiscoveryçš„..ï¼‰

5. é€šç”¨apiåŒ…ï¼š

   I.éœ€å¼•å…¥openfeign & sentinel

   II.æœåŠ¡æä¾›æ–¹çš„æ¥å£å†™å…¥åˆ°é€šç”¨apiä¸­ï¼Œå¹¶ä¸ºè¿œç¨‹è°ƒç”¨æ–°å»ºç»Ÿä¸€æœåŠ¡é™çº§

   ç»Ÿä¸€æœåŠ¡é™çº§ç±»å®ç°é€šç”¨apiç±»ï¼Œé‡å†™å…¶ä¸­çš„æ‰€æœ‰æ¥å£ï¼Œé™çº§ç›´æ¥èµ°å¯¹åº”é‡å†™çš„å†…å®¹

   ```java
   @FeignClient(value = "æä¾›è€…æ³¨å†Œåç§°",fallback = ç»Ÿä¸€é™çº§å¤„ç†ç±».class)
   public interface PayFeignSentinelApi{
       @GetMapping("/pay/nacos/get/{orderNo}")
       public ResultData getPayByOrderNo(@PathVariable("orderNo") String orderNo);
   }
   ```

   ```java
   @Component
   public class PayFeignSentinelApiFallBack implements PayFeignSentinelApi{
       @Override
       public ResultData getPayByOrderNo(String orderNo){
           return ResultData.fail(ReturnCodeEnum.RC500.getCode(),"å¯¹æ–¹æœåŠ¡å®•æœºæˆ–ä¸å¯ç”¨ï¼ŒFallBackæœåŠ¡é™çº§o(â•¥ï¹â•¥)o");
       }
   }
   ```

6. æœåŠ¡æ¶ˆè´¹è€…ï¼š

   I.å¼•å…¥openfeign & sentinel & nacos-discovery

   II. **é‡ä¸­ä¹‹é‡ï¼š** æ¿€æ´»Sentinelå¯¹Feignçš„æ”¯æŒ

   ```yaml
   # æ¿€æ´»Sentinelå¯¹Feignçš„æ”¯æŒ
   feign:
     sentinel:
       enabled: true
   ```

   III.å¯åŠ¨ç±»ä¸Šå¯ç”¨FeignåŠŸèƒ½`@EnableFeignClients`



å¯åŠ¨æœåŠ¡æ¶ˆè´¹è€…æŠ¥é”™ï¼š

```bash
Caused by: java.lang.IllegalStateException: Method PayFeignSentinelApi#getPayByOrderNo(String) not annotated with HTTP method type (ex. GET, POST)
...
```

åŸå› ï¼šspringboot + springcloud ç‰ˆæœ¬è¿‡é«˜ï¼Œsentinelä¸å…¼å®¹

è§£å†³æ–¹æ¡ˆï¼šé™ä½ç‰ˆæœ¬





## GateWay & Sentinel

--> æœåŠ¡é™æµ 

 











































