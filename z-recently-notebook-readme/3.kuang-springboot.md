ssm..é¡¹ç›®æ‰“åŒ…ä¸ºwaråœ¨tomcatè¿è¡Œ

springbootå†…åµŒtomcatï¼Œç›´æ¥è¿è¡Œï¼Œå¾®æœåŠ¡æ¶æ„ï¼

æ–°æœåŠ¡æ¶æ„ï¼šæœåŠ¡ç½‘æ ¼ï¼

è´­ä¹°å•†å“æµç¨‹ï¼š

ä»“åº“å†»ç»“ã€èµ„é‡‘å†»ç»“ã€éªŒè¯ï¼›è´­ä¹°æˆåŠŸï¼Œä»“åº“æ•°é‡å‡å°‘ï¼Œä»“åº“è§£å†»ï¼Œèµ„é‡‘è§£å†»



# ç¬¬ä¸€ä¸ªSpringBootç¨‹åº

## æ–°å»ºé¡¹ç›®çš„æ–¹æ³•

- Springå®˜æ–¹ç½‘ç«™æ–°å»ºï¼ˆ[Spring Initializr](https://start.spring.io/)ï¼‰
- ä½¿ç”¨é›†æˆäº†SpringBootçš„IDEAæ–°å»º



## çƒ­éƒ¨ç½²

```xml
<!--devtoolsçƒ­éƒ¨ç½²-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-devtools</artifactId>
    <optional>true</optional>
    <scope>true</scope>
</dependency>
```

> - ä¿®æ”¹ç±»â€“>ä¿å­˜ï¼šåº”ç”¨ä¼šé‡å¯
> - ä¿®æ”¹é…ç½®æ–‡ä»¶â€“>ä¿å­˜ï¼šåº”ç”¨ä¼šé‡å¯
> - ä¿®æ”¹é¡µé¢â€“>ä¿å­˜ï¼šåº”ç”¨ä¸ä¼šé‡å¯ï¼Œä½†ä¼šé‡æ–°åŠ è½½ï¼Œé¡µé¢ä¼šåˆ·æ–°

```yaml
spring:
  devtools:
    restart:
      enabled: true  #è®¾ç½®å¼€å¯çƒ­éƒ¨ç½²
      additional-paths: src/main/java #é‡å¯ç›®å½•
      exclude: WEB-INF/**
  freemarker:
    cache: false    #é¡µé¢ä¸åŠ è½½ç¼“å­˜ï¼Œä¿®æ”¹å³æ—¶ç”Ÿæ•ˆ
```

 



## è‡ªå®šä¹‰LOGOèœå•

> -resources
>
> â€‹	-banner.txt

banner.txtå†™å…¥asciiå­—ç¬¦ï¼Œå¯è¢«è¯»å–ä¸ºå¯åŠ¨ç¨‹åºæ˜¾ç¤ºçš„æ ·å¼



# åŸç†åˆçª¥

## è‡ªåŠ¨è£…é…

### pom.xml

- spring-boot-dependenciesï¼šæ ¸å¿ƒä¾èµ–åœ¨çˆ¶å·¥ç¨‹ä¸­ï¼
- å¼•å…¥springbootä¾èµ–ä¸éœ€è¦æŒ‡å®šç‰ˆæœ¬ï¼Œå°±æ˜¯æœ‰ç‰ˆæœ¬ä»“åº“



### å¯åŠ¨å™¨

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter</artifactId>
</dependency>
```

- å¯åŠ¨å™¨ï¼šè¯´ç™½äº†å°±æ˜¯Springbootçš„å¯åŠ¨åœºæ™¯ï¼›
- æ¯”å¦‚spring-boot-starter-web,ä»–å°±ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨å¯¼å…¥webç¯å¢ƒæ‰€æœ‰çš„ä¾èµ–ï¼
- springbootä¼šå°†æ‰€æœ‰çš„åŠŸèƒ½åœºæ™¯ï¼Œéƒ½å˜æˆä¸€ä¸ªä¸ªçš„å¯åŠ¨å™¨
- æˆ‘ä»¬è¦ä½¿ç”¨ä»€ä¹ˆåŠŸèƒ½ï¼Œå°±åªéœ€è¦æ‰¾åˆ°å¯¹åº”çš„å¯åŠ¨å™¨å°±å¯ä»¥äº†`starter`

,å¯åŠ¨å™¨ï¼šè¯´ç™½äº†å°±æ˜¯Springbootçš„å¯åŠ¨åœºæ™¯ï¼›
æ¯”å¦‚spring-boot-starter-web,ä»–å°±ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨å¯¼å…¥webç¯å¢ƒæ‰€æœ‰çš„ä¾èµ–ï¼
Â·springbootä¼šå°†æ‰€æœ‰çš„åŠŸèƒ½åœºæ™¯ï¼Œéƒ½å˜æˆä¸€ä¸ªä¸ªçš„å¯åŠ¨å™¨
æˆ‘ä»¬è¦ä½¿ç”¨ä»€ä¹ˆåŠŸèƒ½ï¼Œå°±åªéœ€è¦æ‰¾åˆ°å¯¹åº”çš„å¯åŠ¨å™¨å°±å¯ä»¥äº†
starter



é…ç½®æ–‡ä»¶ï¼ˆyamlï¼‰



# å±æ€§èµ‹å€¼

## @Valueæ³¨è§£

```java
public class Student {
    @Value("åå­—1")
    private String name;
    private Integer age;
    private Boolean happy;
    private Date birth;
    private Map<String,Object> maps;
    private List<Object> lists;
    private Teacher teacher;
}
```



## é…ç½®æ–‡ä»¶

### å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-configuration-processor</artifactId>
    <optional>true</optional>
</dependency>
```



### application.yamlä¸­å†™å…¥å€¼

```yaml
student:
  name: ä½ å¥½
  age: 17
  happy: false
  birth: 2020/10/10
  maps: { k1: v1,k2: v2 }
  lists:
    - code
    - music
    - girl
  teacher:
    name: è€å¸ˆ1å·
    teachAge: 20
```



### é…ç½®æ³¨è§£ (1)

`@ConfigurationProperties(prefix = "student")`

**æ³¨æ„ï¼š**å¿…é¡»ä½¿ç”¨ `@Component`

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@Component
@ConfigurationProperties(prefix = "student")
public class Student {
    @Value("åå­—1")
    private String name;
    private Integer age;
    private Boolean happy;
    private Date birth;
    private Map<String,Object> maps;
    private List<Object> lists;
    private Teacher teacher;
}
```

```yaml
student:
  name: ä½ å¥½
  age: 17
  happy: false
  birth: 2020/10/10
  maps: { k1: v1,k2: v2 }
  lists:
    - code
    - music
    - girl
  teacher:
    name: è€å¸ˆ1å·
    teachAge: 20
```



### é…ç½®æ³¨è§£ (æŒ‡å®šé…ç½®æ–‡ä»¶)

`@PropertySource(value = "classpath:xxx.properties")`

é…åˆ  `@Value`

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@Component
@PropertySource(value = "classpath:xxx.properties")
public class Student {
    @Value("${name}")
    private String name;
    private Integer age;
    private Boolean happy;
    private Date birth;
    private Map<String, Object> maps;
    private List<Object> lists;
    private Teacher teacher;
}
```

```properties
name=ä½ å¥½
age=17
happy=false
birth=2020/10/10
maps={ k1= v1,k2= v2 }
lists=[1,2,3]
teacher.teachAge=20
teacher.name=20
```



### yamlä¸­é…ç½®åŠ¨æ€å€¼

```yaml
student:
  name: ä½ å¥½${random.uuid}
  age: ${random.int}
  happy: false
  birth: 2020/10/10
  maps: { k1: v1,k2: v2 }
  hello: kkk
  lists:
    - code
    - music
    - girl
  teacher:
    name: ${student.hello:hello}_è€å¸ˆä¸€å·
    teachAge: 20
```



### **æ¾æ•£ç»‘å®š**ï¼š

å®ä½“ç±»ä¸­ä½¿ç”¨ï¼š`private String lastName;`

yamlé…ç½®æ–‡ä»¶ä¸­å±æ€§èµ‹å€¼å¯å†™ï¼š`last-name: ä½ å¥½`

## JSR303æ ¡éªŒ

ç±»ä¸Šä½¿ç”¨æ³¨è§£ï¼š**@Validated**

ç±»ä¼¼æ­£åˆ™è¡¨è¾¾å¼

> @NotNull(message="åå­—ä¸èƒ½ä¸ºç©º")
> private String userName;
>
> @Max(Value=120,message="å¹´é¾„æœ€å¤§ä¸èƒ½æŸ¥è¿‡120")
> private int age;
>
> @Email(message="é‚®ç®±æ ¼å¼é”™è¯¯")
> private String email;
>
> 
>
> **ç©ºæ£€æŸ¥**
> @Null
> éªŒè¯å¯¹è±¡æ˜¯å¦ä¸ºnull
>
> @NotNull
> éªŒè¯å¯¹è±¡æ˜¯å¦ä¸ä¸ºnull,æ— æ³•æŸ¥æ£€é•¿åº¦ä¸º8çš„å­—ç¬¦ä¸²
>
> @NotBlank
> æ£€æŸ¥çº¦æŸå­—ç¬¦ä¸²æ˜¯ä¸æ˜¯Nullè¿˜æœ‰è¢«Trimçš„é•¿åº¦æ˜¯å¦å¤§äº9ï¼Œåªå¯¹å­—ç¬¦ä¸²ï¼Œä¸”ä¼šå»æ‰å‰åç©ºæ ¼
>
> @NotEmpty
> æ£€æŸ¥çº¦æŸå…ƒç´ æ˜¯å¦ä¸ºNULLæˆ–è€…æ˜¯EMPTY.
>
> 
>
> **Booleanæ£€æŸ¥**
>
> @AssertTrue
> éªŒè¯Booleanå¯¹è±¡æ˜¯å¦ä¸ºtrue
>
> @AssertFalse
> éªŒè¯Booleanå¯¹è±¡æ˜¯å¦ä¸ºfa1se
>
> 
>
> **é•¿åº¦æ£€æŸ¥**
> @size(min=,max=) éªŒè¯å¯¹è±¡ (Array,Collection,Map,String) é•¿åº¦æ˜¯å¦åœ¨ç»™å®šçš„èŒƒå›´ä¹‹å†…
>
> @Length(min=,max=) Validates that the annotated string is between min and max included.
>
> 
>
> **æ—¥æœŸæ£€æŸ¥**
> @Past
> éªŒè¯Dateå’ŒCalendarå¯¹è±¡æ˜¯å¦åœ¨å½“å‰æ—¶é—´ä¹‹å‰
>
> @Future
> éªŒè¯Dateå’ŒCalendarå¯¹è±¡æ˜¯å¦åœ¨å½“å‰æ—¶é—´ä¹‹å
>
> @Pattern
> éªŒè¯Stringå¯¹è±¡æ˜¯å¦ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼çš„è§„åˆ™ : æ­£åˆ™è¡¨è¾¾å¼
>
> 
>
> ..........ç­‰ç­‰
> é™¤æ­¤ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ä¸€äº›æ•°æ®æ ¡éªŒè§„åˆ™



## é…ç½®æ–‡ä»¶

### ä¼˜å…ˆçº§

è¢«è¯»å–çš„å¦‚ï¼šapplication.yamlç­‰é…ç½®æ–‡ä»¶çš„ä¼˜å…ˆçº§

> - **`file:./config/`**
> - **`file:./`**
> - **`classpath:/config/`**
> - **`classpath:/`**



## Springbootå¤šç¯å¢ƒé…ç½®

å¯ä»¥é€‰æ‹©æ¿€æ´»å“ªä¸€ä¸ªé…ç½®æ–‡ä»¶

### properties

ä¾‹å¦‚å·²æœ‰æ–‡ä»¶

> - **application.properties**
> - application-dev.properties
> - application-test.properties

åœ¨**application.properties**æ–‡ä»¶ä¸­ä½¿ç”¨å‚æ•°é€‰æ‹©æ¿€æ´»

`spring.profiles.active=dev`ï¼Œä»£è¡¨æ¿€æ´»application-dev.propertiesé…ç½®æ–‡ä»¶çš„å±æ€§



### yaml

ä»…éœ€ä¸€ä¸ªæ–‡ä»¶ï¼š**application.yaml**

ç”¨ **---** åˆ†éš”ï¼Œ**profiles**æ ‡æ³¨ï¼Œ**active**è¡¨æ˜å¯ç”¨

```yaml
server:
  port: 8080
spring:
  profiles:
    active: dev

---
server:
  port: 8081
spring:
  profiles: dev

---
server:
  port: 8082
spring:
  profiles: test
```



## è‡ªåŠ¨è£…é…åŸç†ç²¾é«“

1. SpringBootå¯åŠ¨ä¼šåŠ è½½å¤§é‡çš„è‡ªåŠ¨é…ç½®ç±»ï¼›
2. æˆ‘ä»¬çœ‹æˆ‘ä»¬éœ€è¦çš„åŠŸèƒ½æœ‰æ²¡æœ‰åœ¨SpringBooté»˜è®¤å†™å¥½çš„è‡ªåŠ¨é…ç½®ç±»å½“ä¸­ï¼›
3. æˆ‘ä»¬å†æ¥çœ‹è¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»ä¸­åˆ°åº•é…ç½®äº†å“ªäº›ç»„ä»¶ï¼›(åªè¦æˆ‘ä»¬è¦ç”¨çš„ç»„ä»¶å­˜åœ¨åœ¨å…¶ä¸­ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦å†æ‰‹åŠ¨é…ç½®äº†)ï¼›
4. ç»™å®¹å™¨ä¸­è‡ªåŠ¨é…ç½®ç±»æ·»åŠ ç»„ä»¶çš„æ—¶å€™ï¼Œä¼šä»**propertiesç±»**ä¸­è·å–æŸäº›å±æ€§ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šè¿™äº›å±æ€§çš„å€¼å³å¯ï¼›

- **xxxxAutoConfigurationï¼š**è‡ªåŠ¨é…ç½®ç±»ï¼›ç»™å®¹å™¨ä¸­æ·»åŠ ç»„ä»¶ï¼›
- **xxxxPropertiesï¼š**å°è£…é…ç½®æ–‡ä»¶ä¸­ç›¸å…³å±æ€§ï¼›



**PSï¼š**å¯ä»¥é€šè¿‡**`debug=true`**æ¥æŸ¥çœ‹å“ªäº›è‡ªåŠ¨é…ç½®ç±»ç”Ÿæ•ˆäº†ï¼Œå“ªäº›æ²¡æœ‰



# SpringBoot Webå¼€å‘

## webjars

```xml
<dependency>
    <groupId>org.webjars</groupId>
    <artifactId>jquery</artifactId>
    <version>3.6.4</version>
</dependency>
```



## é™æ€èµ„æº

**èƒ½ç›´æ¥è®¿é—®é™æ€èµ„æºçš„æ‰€æœ‰è·¯å¾„ï¼š**

classpath:å³**src/main/resources**

> classpath:
>
> â€‹	/META-INF/resources/
>
> â€‹	/resources/
>
> â€‹	/static/
>
> â€‹	/public/

**ä¼˜å…ˆçº§ï¼š**resources > staticï¼ˆé»˜è®¤ï¼‰ > public



### æ¨¡æ¿å¼•æ“

- **templatesç›®å½•**ä¸‹çš„é¡µé¢åªèƒ½é€šè¿‡**controller**æ¥è·³è½¬
- é»˜è®¤çš„è§†å›¾è§£æå™¨åªèƒ½è·³è½¬.jspé¡µé¢
- å› æ­¤éœ€è¦å¼•å…¥thymeleafä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-thymeleaf</artifactId>
</dependency>
```



### Thymeleaf

**æ‰€æœ‰çš„htmlå…ƒç´ å±æ€§ï¼Œéƒ½å¯ä»¥è¢«thymeleafæ›¿æ¢æ¥ç®¡**

- åœ¨htmlä¸­ä½¿ç”¨éœ€è¦å¯¼å…¥çº¦æŸ

  ```html
  <html lang="en" xmlns:th="http://www.thymeleaf.org">
  ```

- é˜²æ­¢${xxx}æŠ¥é”™ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ³¨é‡Š

  ```html
  <!--suppress ThymeleafVariablesResolveInspection -->
  ```



#### è¯­æ³•

##### th:text  /  th:utext

```java
// controlleréƒ¨åˆ†
@GetMapping("/index")
public String index(Model model) {
    model.addAttribute("msg", "<h1>HelloThymeleaf</h1>");
    return "index";
}
```

```html
// html
<div th:text="${msg}">ä½ å¥½</div>
<div th:utext="${msg}">ä½ å¥½</div>
```

- ä½¿ç”¨äº†textçš„å°†ç›´æ¥è¾“å‡ºmsgçš„æ–‡æœ¬å†…å®¹å®Œå®Œå…¨å…¨
- ä½¿ç”¨utextçš„ä¼šå°†msgå†…å®¹ä¸­çš„htmlæ ‡ç­¾è¯†åˆ«ï¼Œå¹¶è¾“å‡ºå…¶ä½™çš„æ–‡æœ¬å†…å®¹



#### th:each

```java
// controlleréƒ¨åˆ†
...
model.addAttribute("users", Arrays.asList("ab", "cd"));
...
```

```html
// htmléƒ¨åˆ†
<div th:each="user:${users}" th:text="${user}"></div>
```



## MVC Config

æ‰©å±•springmvcï¼Œæ‰€ä»¥è¦å®ç° **WebMvcConfigurer**ï¼Œå¯¹ä¸€äº›è¦æ‰©å±•ä¿®æ”¹çš„æ–¹æ³•è¿›è¡ŒOverrideé‡å†™æ“ä½œ

```java
@Configuration
public class MyMvcConfig implements WebMvcConfigurer {
    ...
}
```



### ViewResolver

ViewResolverå®ç°äº†è§†å›¾è§£æå™¨æ¥å£çš„ç±»ï¼Œå› æ­¤å¯å°†å…¶çœ‹ä½œè§†å›¾è§£æå™¨

æ‰©å±•è¯¥è§†å›¾è§£æå™¨åŠŸèƒ½ï¼Œè‡ªå®šä¹‰è¯¥ç»„ä»¶ï¼Œå¹¶ä½¿ç”¨@Beanæ³¨è§£äº¤ç»™SpringBootï¼Œä¼šè‡ªåŠ¨è£…é…

```java
@Configuration
public class MyMvcConfig implements WebMvcConfigurer {
    @Bean
    public ViewResolver myViewResolver(){
        return new MyViewResolver();
    }

    public static class MyViewResolver implements ViewResolver {
        @Override
        public View resolveViewName(String viewName, Locale locale) throws Exception {
            return null;
        }
    }
}
```



### addViewControllers

```java
@Override
public void addViewControllers(ViewControllerRegistry registry) {
    registry.addViewController("/xxx").setViewName("index");
}
```

è®¿é—®/xxxï¼Œè·³è½¬è‡³index



## ç®¡ç†ç³»ç»Ÿå¼€å‘

### å‡†å¤‡å·¥ä½œ

å‡†å¤‡å¥½å‰ç«¯èµ„æº

1. htmlé¡µé¢æ”¾åˆ° 

   > -resources 
   >
   > â€‹	-templates

2. cssã€imgã€jsèµ„æºæ”¾åˆ°

   > -resources
   >
   > â€‹	-static



#### æ¨¡æ‹Ÿæ•°æ®

**æ³¨æ„ï¼š**daoå±‚ç»™springæ‰˜ç®¡ä½¿ç”¨**@Repository**æ³¨è§£

```java
public class DepartmentDao {
    private static Map<Integer, Department> departments = null;

    static {
        departments = new LinkedHashMap<>();
        departments.put(101, new Department(101, "101éƒ¨"));
        departments.put(102, new Department(102, "102éƒ¨"));
        departments.put(103, new Department(103, "103éƒ¨"));
        departments.put(104, new Department(104, "104éƒ¨"));
        departments.put(105, new Department(105, "105éƒ¨"));
        departments.put(106, new Department(106, "106éƒ¨"));
    }

    /**
     * è·å–æ‰€æœ‰æ•°æ®
     */
    public Collection<Department> getDepartments() {
        return departments.values();
    }

    /**
     * æ ¹æ®idè·å–éƒ¨é—¨ä¿¡æ¯
     */
    public Department getDepartment(Integer id) {
        return departments.get(id);
    }

    /**
     * æ ¹æ®idåˆ é™¤éƒ¨é—¨ä¿¡æ¯
     */
    public void deleteDepartment(Integer id) {
        departments.remove(id);
    }

    /**
     * æ–°å¢éƒ¨é—¨ä¿¡æ¯
     */
    public void addDepartment(Department department) {
        departments.put(department.getId(), department);
    }

    /**
     * ä¿®æ”¹éƒ¨é—¨ä¿¡æ¯
     */
    public void updateDepartment(Department department) {
        departments.put(department.getId(), department);
    }
}
```



### é¦–é¡µå®ç°

ä¸ºäº†è®¿é—®

> - localhost:8080
> - localhost:8080/index
> - localhost:8080/index.html

éƒ½èƒ½è·³è½¬åˆ°indexé¡µé¢ï¼Œå¯ä»¥æ‰©å±•é…ç½®MvcConfigğŸ‘‡

```java
@Configuration
public class MyMvcConfig implements WebMvcConfigurer {
    @Override
    public void addViewControllers(ViewControllerRegistry registry) {
        registry.addViewController("/").setViewName("index");
        registry.addViewController("/index.html").setViewName("index");
        registry.addViewController("/index").setViewName("index");
    }
}
```



**æ‰€æœ‰çš„é™æ€èµ„æºè¢«Thymeleafæ¥ç®¡ï¼Œå¼•ç”¨é™æ€èµ„æºæ–‡ä»¶ï¼ˆcss..ï¼‰ğŸ‘‡**

> -resources
>
> â€‹	-static
>
> â€‹		-css
>
> â€‹		-js
>
> â€‹		-img

ä½¿ç”¨@{}å¯ä»¥å¿½ç•¥static

```html
<link th:href="@{/css/index.css}" rel="stylesheet">
```



**å…³é—­æ¨¡æ¿å¼•æ“ç¼“å­˜ğŸ‘‡**

```properties
spring.thymeleaf.cache=false
```



**æ‹¼æ¥è·¯å¾„ï¼š**

```properties
server.servlet.context-path=/xxx
```

ä¾‹å¦‚ï¼šåŸæœ¬è®¿é—®localhost:8080/index.htmlå³å¯

é…ç½®è·¯å¾„åï¼Œè®¿é—®çš„æ˜¯localhost:8080/xxx/index.html



### å›½é™…åŒ–

ç‚¹å‡»åˆ‡æ¢ä¸­è‹±æ–‡ä¹‹ç±»çš„ç©æ„..

1. é¦–å…ˆç¡®ä¿é¡¹ç›®çš„æ‰€æœ‰å­—ç¬¦ç¼–ç ä¸º**utf-8**ï¼ˆfileEncodings)

2. resourcesä¸‹æ–°å»ºç›®å½•ï¼š**i18n**(internationalization ï¼ˆå›½é™…åŒ–ï¼‰ç®€ç§°ï¼ši18n)

3. i18nç›®å½•ä¸‹æ–°å¢é…ç½®æ–‡ä»¶ï¼š**login.properties** / **login_zn_CN.properties**

   ä¼šè¢«åˆå¹¶ä¸ºä¸€ä¸ª**Resource Bundle'login'**

   éœ€è¦æ–°å¢åˆ«çš„è¯­è¨€å¯ä»¥ç›´æ¥åœ¨Resource Bundleä¸Šå³é”®æ–°å¢é…ç½®æ–‡ä»¶ï¼Œå³ä¾§â€+â€œï¼Œè¾“å…¥**en_US**æ–°å¢è‹±è¯­..

4. ä¸‹è½½å¯è§†åŒ–ç¼–è¾‘æ’ä»¶ **Resource Bundle Editor**

5. è¿›å…¥login.propertiesï¼ŒIDEAä¸‹æ–¹é€‰æ‹©Resource Bundleï¼Œåœ¨loginä¸Šç‚¹å‡»â€+â€œæ·»åŠ å‚æ•°

   å³ä¾§å°±ä¼šå‡ºç°æ‰€æœ‰login_xxxçš„ç›¸å…³propertiesè¾“å…¥æ¡†é…ç½®ä¸åŒçš„å‚æ•°å€¼



**å°†ä»¥ä¸Šé…ç½®ä½¿ç”¨èµ·æ¥**

1. ç¡®è®¤è½¬æ¢ä½ç½®

   æœ‰ä¸€ä¸ªç±»ï¼šMessageSourceAutoConfigurationï¼Œåšè‡ªåŠ¨åŒ–å›½é™…è½¬æ¢

   åœ¨**application.properties**ä¸­é…ç½®è¯†åˆ«

   ```properties
   spring.messages.basename=i18n.login
   ```

2. åœ¨Thymeleafä¸­ï¼Œéœ€è¦ç”¨åˆ°å›½é™…åŒ–è½¬æ¢æ–‡å­—çš„åœ°æ–¹ä½¿ç”¨

   th:text="#{login.tip}"

   ```html
   <h1>[[#{login.tip}]]</h1>
   <input type="submit" th:value="#{login.btn}"/>
   ```

3. è¯­è¨€åˆ‡æ¢æŒ‰é’®åŠè·³è½¬**è¯·æ±‚å‚æ•°ï¼ˆlï¼‰**

   ```html
   <a th:href="@{/index.html(l='zh_CN')}">ä¸­æ–‡</a>
   <a th:href="@{/index.html(l='en_US')}">English</a>
   ```

4. ç¼–è¾‘å®ç°**åŒºåŸŸè§£æå™¨ï¼ˆLocaleResolverï¼‰**ç»„ä»¶

   ```java
   public class MyLocaleResolver implements LocaleResolver {
       @Override
       public Locale resolveLocale(HttpServletRequest request) {
           String language = request.getParameter("l");// è·å–è¯·æ±‚è¯­è¨€å‚æ•°
           Locale locale = Locale.getDefault();// è·å–é»˜è®¤çš„
           // è¯·æ±‚è¿æ¥æ˜¯å¦æºå¸¦å›½é™…åŒ–å‚æ•°
           if (!StringUtils.isEmpty(language)){
               String[] split = language.split("_");
               return new Locale(split[0],split[1]);
           }
           return locale;
       }
   
       @Override
       public void setLocale(HttpServletRequest request, 
                             HttpServletResponse response, 
                             Locale locale) {
   
       }
   }
   ```

5. åœ¨**MvcConfig**ä¸­æ³¨å…¥è¯¥è‡ªå®šä¹‰ç»„ä»¶

   ```java
   @Configuration
   public class MyMvcConfig implements WebMvcConfigurer {
       @Bean
       public LocaleResolver localeResolver(){
           return new MyLocaleResolver();
       }
   }
   ```



### è§£å†³é—®é¢˜

ç™»å½•åè¿›å…¥çš„é¡µé¢ï¼Œåœ°å€æ æ˜¾ç¤ºçš„æ˜¯ /user/login?username=xxx

æ¨¡æ‹ŸçœŸå®å¼€å‘ï¼Œåœ¨controllerå†…è·³è½¬é¡µé¢è¦é‡å®šå‘ï¼Œå¹¶åœ¨mvcé…ç½®ä¸­é…ç½®é‡å®šå‘åœ°å€æ‰“å¼€å“ªä¸ªé¡µé¢

ä¾‹å¦‚ï¼šé‡å®šå‘åˆ°main.htmlï¼Œæ‰“å¼€çš„é¡µé¢æ˜¯homePage

```java
@RequestMapping("/login")
public String login(@RequestParam("username") String username,
                    @RequestParam("pwd") String pwd,
                    Model model) {
    if (Objects.equals(username, "a") && Objects.equals(pwd, "a")){
        // ç™»é™†æˆåŠŸ
        return "redirect:/main.html";
    }else {
        model.addAttribute("msg","ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼");
        return "index";
    }
}
```

```java
@Configuration
public class MyMvcConfig implements WebMvcConfigurer {
    @Override
    public void addViewControllers(ViewControllerRegistry registry) {
        registry.addViewController("/main.html").setViewName("homePage");
    }
}
```



### æ‹¦æˆªå™¨

1. ç¼–å†™ä¸€ä¸ªLoginHandlerInterceptorç±»

   å®ç°HandlerInterceptorç±»

   é‡å†™preHandleæ–¹æ³•

   ```java
   public class LoginHandlerInterceptor implements HandlerInterceptor {
       @Override
       public boolean preHandle(HttpServletRequest request, 
                                HttpServletResponse response, 
                                Object handler) throws Exception {
           Object loginUser = request.getSession().getAttribute("loginUser");
           if (loginUser == null) {
               // æœªç™»å½•
               request.setAttribute("msg", "æ²¡æœ‰æƒé™ï¼Œè¯·å…ˆç™»å½•");
               request.getRequestDispatcher("/index.html").forward(request, response);
               return false;
           }
           return true;
       }
   }
   ```

2. åœ¨MvcConfigä¸­æ³¨å…¥è¯¥æ‹¦æˆªå™¨

   å¹¶æ·»åŠ éœ€è¦æ‹¦æˆªçš„é¡µé¢ï¼Œä¸éœ€è¦è¢«æ‹¦æˆªçš„é¡µé¢..

   ```java
   @Configuration
   public class MyMvcConfig implements WebMvcConfigurer {
       @Override
       public void addInterceptors(InterceptorRegistry registry) {
           registry.addInterceptor(new LoginHandlerInterceptor())
                   .addPathPatterns("/**")
                   .excludePathPatterns("/index.html","/","/user/login","/css/**","/js/**","/img/**");
       }
   }
   ```

3. ä½¿ç”¨Thymeleafä¸­çš„æ–¹æ³•å–sessionå€¼æ”¾å…¥é¡µé¢

   ```html
   <h1>ç™»é™†æˆåŠŸï¼æ¬¢è¿[[${session.loginUser}]]è¿›å…¥é¦–é¡µï¼</h1>
   ```



### ThymeleafæŠ½å–å‰ç«¯å¤ç”¨æ€§ç»„ä»¶

**æ³¨æ„ï¼š**å¤ç”¨æ€§é«˜çš„ä¸€äº›éƒ¨åˆ†å»ºè®®æ”¾åˆ°å…¬å…±é¡µé¢ï¼ˆcommon.htmlï¼‰ï¼Œè¿›è¡ŒæŠ½å–è°ƒç”¨

- è¢«æŠ½å–çš„éƒ¨åˆ†ï¼Œä½¿ç”¨`th:fragment="å"`

  ```html
  <div class="side_bar" th:fragment="side_bar"></div>
  ```

- ä½¿ç”¨æŠ½å–åˆ°çš„éƒ¨åˆ†ï¼š`th:insert="~{é¡µé¢::å}"`ï¼Œä¹Ÿå¯ä»¥ç”¨`th:replace`ï¼Œä¸`th:insert`ä½¿ç”¨æ–¹æ³•ç›¸åŒ

  ```html
  <div th:insert="~{homePage::side_bar}"></div>
  ```

- ååé¢æ˜¯å¯ä»¥**ä¼ å‚æ•°**çš„ï¼Œç”¨ä»¥è¡¨ç¤ºå½“å‰ä½¿ç”¨æŠ½å–éƒ¨åˆ†çš„é¡µé¢æ˜¯å“ªä¸ªé¡µé¢ï¼Œæ–¹ä¾¿å…¬å…±éƒ¨åˆ†æ˜¾ç¤ºä¸åŒçš„æ ·å¼

  **ä¾‹å¦‚ï¼š**

  > ä½¿ç”¨æŠ½å–çš„é¡µé¢ï¼š`th:replace="~{commons/commons::side_bar(active='list.html')}"`
  >
  > è¢«æŠ½å–çš„é¡µé¢ï¼š`th:class="@active=='list.html'?'active b':'b'"`
  >
  > é€šè¿‡ä½¿ç”¨æŠ½å–é¡µé¢ä¼ æ¥çš„å‚æ•°ï¼Œå†³å®šclassçš„å€¼ä¸åŒ

  ```html
  <div class="side_bar" th:fragment="side_bar">
      <ul>
          <li>
              <a th:href="@{/index.html}" th:class="${active=='index.html' ? 'active ab' : 'ab'}">
                  ä¸ªäººä¸­å¿ƒ
              </a>
          </li>
          <li th:class="${active=='list.html' ? 'active ab' : 'ab'}">
              <a th:href="@{/emps}" th:class="${active=='list.html' ? 'active ab' : 'ab'}">
                  å‘˜å·¥ç®¡ç†
              </a>
          </li>
      </ul>
  </div>
  ```

  ```html
  <div th:replace="~{commons/commons::side_bar(active = 'index.html')}"></div>
  ```



### å‰ç«¯å°ä¿®æ”¹

æ ¼å¼åŒ–æ—¥æœŸ

```html
<td th:text="${#dates.format(emp.birth,'yyyy-MM-dd HH:mm:ss')}"></td>
```





### 404

templatesä¸‹æ–°å»ºerrorç›®å½•ï¼Œerrorç›®å½•ä¸‹æ–°å»º404.htmlé¡µé¢å³å¯è‡ªåŠ¨è¯†åˆ«

å¦‚æœæœ‰æ‹¦æˆªå™¨ï¼Œç™»é™†åæ‰ä¼šè®¿é—®åˆ°404é¡µé¢





## Druidæ•°æ®æº

### æ·»åŠ ä¾èµ–

```xml
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid</artifactId>
    <version>1.1.23</version>
</dependency>
<dependency>
    <groupId>log4j</groupId>
    <artifactId>log4j</artifactId>
    <version>1.2.17</version>
</dependency>
```

**æ³¨æ„ï¼š**å› ä¸ºDruidåŒ…å«log4jï¼Œå› æ­¤è¿˜éœ€è¦å¼•å…¥log4jçš„ä¾èµ–



### Yamlæ–‡ä»¶ä¸­é…ç½®è‡ªå®šä¹‰çš„æ•°æ®æº

```yaml
spring:
  datasource:
    username: root
    password: 123456
    url: jdbc:mysql://localhost:3306/mybatis?useSSL=true&userUniceode=true&characterEncoding=utf8
    driver-class-name: com.mysql.cj.jdbc.Driver
    type: com.alibaba.druid.pool.DruidDataSource
```



### Druidç›¸å…³é…ç½®

```yaml
  #Spring Boot é»˜è®¤æ˜¯ä¸æ³¨å…¥è¿™äº›å±æ€§å€¼çš„ï¼Œéœ€è¦è‡ªå·±ç»‘å®š
    #druid æ•°æ®æºä¸“æœ‰é…ç½®
    initialSize: 5
    minIdle: 5
    maxActive: 20
    maxWait: 60000
    timeBetweenEvictionRunsMillis: 60000
    minEvictableIdleTimeMillis: 300000
    validationQuery: SELECT 1 FROM DUAL
    testWhileIdle: true
    testOnBorrow: false
    testOnReturn: false
    poolPreparedStatements: true

    #é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filtersï¼Œstat:ç›‘æ§ç»Ÿè®¡ã€log4jï¼šæ—¥å¿—è®°å½•ã€wallï¼šé˜²å¾¡sqlæ³¨å…¥
    #å¦‚æœå…è®¸æ—¶æŠ¥é”™  java.lang.ClassNotFoundException: org.apache.log4j.Priority
    #åˆ™å¯¼å…¥ log4j ä¾èµ–å³å¯ï¼ŒMaven åœ°å€ï¼šhttps://mvnrepository.com/artifact/log4j/log4j
    filters:
      commons-log.connection-logger-name: stat,wall,log4j
    maxPoolPreparedStatementPerConnectionSize: 20
    useGlobalDataSourceStat: true
    connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=500
```



### æ–°å»ºConfigé…ç½®æ–‡ä»¶

ç°åœ¨éœ€è¦ç¨‹åºå‘˜è‡ªå·±ä¸º DruidDataSource ç»‘å®šå…¨å±€é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°ï¼Œå†æ·»åŠ åˆ°å®¹å™¨ä¸­ï¼Œè€Œä¸å†ä½¿ç”¨ Spring Boot çš„è‡ªåŠ¨ç”Ÿæˆäº†ï¼›æˆ‘ä»¬éœ€è¦ è‡ªå·±æ·»åŠ  DruidDataSource ç»„ä»¶åˆ°å®¹å™¨ä¸­ï¼Œå¹¶ç»‘å®šå±æ€§

> -config
>
> â€‹	-DruidConfig.java

```java
@Configuration
public class DruidConfig {
    @Bean
    @ConfigurationProperties(prefix = "spring.datasource")
    //ç»‘å®šåˆ°application.xmlæ–‡ä»¶ä¸­ ç”Ÿæ•ˆ
    public DataSource druidDateSource(){
        return new DruidDataSource();
    }
}
```



#### åå°ç›‘æ§







# SpringSecurity

## å®‰å…¨æ¡†æ¶

- SpringSecurityï¼šèº«ä»½è®¤è¯ã€æˆæƒ
- Shiro
- **ä¸¤è€…ç±»ä¼¼**



## ç®€ä»‹

SpringSecurityï¼š

- é’ˆå¯¹Springé¡¹ç›®çš„å®‰å…¨æ¡†æ¶ï¼Œä¹Ÿæ˜¯SpringBootåº•å±‚å®‰å…¨æ¨¡å—é»˜è®¤çš„æŠ€æœ¯é€‰å‹
- å¯ä»¥å®ç°Webå®‰å…¨æ§åˆ¶ï¼Œä»…éœ€è¦å¼•å…¥spring-boot-starter-securityæ¨¡å—ï¼Œè¿›è¡Œå°‘é‡é…ç½®



## é‡è¦çš„ç±»

- WebSecurityConfigurerAdapterï¼šè‡ªå®šä¹‰Securityç­–ç•¥
- AuthenticationManagerBuilderï¼šè‡ªå®šä¹‰è®¤è¯ç­–ç•¥
- @EnableWebSecurityï¼šå¼€å¯WebSecurityæ¨¡å¼

> Spring Securityçš„ä¸¤ä¸ªä¸»è¦ç›®æ ‡æ˜¯**"è®¤è¯"**å’Œ**"æˆæƒ"**ï¼ˆè®¿é—®æ§åˆ¶ï¼‰
>
> "è®¤è¯"ï¼ˆAuthenticationï¼‰
>
> "æˆæƒâ€ï¼ˆAuthorizationï¼‰
>
> è¿™ä¸ªæ¦‚å¿µæ˜¯é€šç”¨çš„ï¼Œè€Œä¸æ˜¯åªåœ¨Spring Securityä¸­å­˜åœ¨ã€‚



## å¯¼åŒ…

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```



## SecurityConfig

> ***<u>WebSecurityConfigurerAdapteråœ¨SpringSecurity5.7ä¸­å·²å¼ƒç”¨</u>***
>
> ä¸‹é¢çš„æµ‹è¯•æ ·ä¾‹ä½¿ç”¨ç‰ˆæœ¬ï¼š
>
> **æµ‹è¯•SpringSecurity5.7ä»¥ä¸‹ï¼ˆWebSecurityConfigurerAdapter<u>*æœªå¼ƒç”¨*</u>çš„ç‰ˆæœ¬ï¼‰**
>
> - Javaï¼š8
> - SpringBootï¼š2.2.2.RELEASE
> - SpringSecurityï¼š5.2.0.RELEASE
> - æ–‡æ¡£åœ°å€ï¼š[Spring Security Reference](https://docs.spring.io/spring-security/site/docs/5.2.0.RELEASE/reference/htmlsingle/)
>
> 
>
> **æµ‹è¯•SpringSecurity5.7åŠä»¥ä¸Šï¼ˆWebSecurityConfigurerAdapter<u>*å·²å¼ƒç”¨*</u>çš„ç‰ˆæœ¬ï¼‰**
>
> - Javaï¼š17
> - SpringBootï¼š3.2.2



### ç”¨æˆ·è®¤è¯å’Œæˆæƒï¼ˆä»¥ç›´æ¥åœ¨å†…å­˜ä¸­å­˜å‚¨çš„ç”¨æˆ·åå’Œå¯†ç è¿›è¡ŒéªŒè¯ï¼‰

> -config
>
> â€‹	-SecurityConfig

> **è¯´æ˜ï¼š**
>
> - passwordEncoder(new BCryptPasswordEncoder())ï¼šå¯†ç ç¼–ç æ–¹å¼

```java
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    // æˆæƒ
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // é¦–é¡µæ‰€æœ‰äººå¯ä»¥è®¿é—®ï¼ŒåŠŸèƒ½é¡µåªæœ‰å¯¹åº”æƒé™çš„äººæ‰èƒ½è®¿é—®
        http.authorizeRequests()
                .antMatchers("/").permitAll()
                .antMatchers("/level1/**").hasRole("vip1")
                .antMatchers("/level2/**").hasRole("vip2")
                .antMatchers("/level3/**").hasRole("vip3");

        // æ²¡æœ‰æƒé™ï¼Œé»˜è®¤åˆ°ç™»é™†é¡µé¢
        http.formLogin();
    }

    // è®¤è¯
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.inMemoryAuthentication()
                .passwordEncoder(new BCryptPasswordEncoder())
                .withUser("admin1").password(new BCryptPasswordEncoder().encode("admin1")).roles("vip1", "vip3")
                .and()
                .withUser("admin2").password(new BCryptPasswordEncoder().encode("admin2")).roles("vip1", "vip2");
    }
}
```



### æ³¨é”€

> -config
>
> â€‹	-SecurityConfig

> **è¯´æ˜ï¼š**
>
> logoutSuccessUrlï¼šæŒ‡å®šæ³¨é”€æˆåŠŸè·³è½¬çš„é¡µé¢

```java
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    // æˆæƒ
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.logout().logoutSuccessUrl("/");
    }
}
```



## Security-Thymeleaf

**éœ€æ±‚ï¼š**

1. å®ç°æœªç™»å½•çœ‹åˆ°ï¼šç™»å½•æŒ‰é’®ï¼Œå·²ç™»å½•çœ‹åˆ°ï¼šç”¨æˆ·ååŠæ³¨é”€æŒ‰é’®
2. ä¸åŒè§’è‰²çš„ç”¨æˆ·ç™»å½•ï¼Œçœ‹åˆ°çš„æ¨¡å—ä¹Ÿä¸åŒ



### å¯¼åŒ…

**æ³¨æ„ç‰ˆæœ¬å¯¹åº”ï¼**

> SpringBootï¼š**<u>2.2.2.RELEASE</u>**
>
> thymeleaf-extras-springsecurityï¼š**<u>5</u>** / **<u>3.0.4.RELEASE</u>**

```xml
<dependency>
    <groupId>org.thymeleaf.extras</groupId>
    <artifactId>thymeleaf-extras-springsecurity5</artifactId>
    <version>3.0.4.RELEASE</version>
</dependency>
```



**HTMLæ ‡ç­¾å†…å¼•å…¥é“¾æ¥**

```html
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
```



### é¡µé¢ä¿®æ”¹

- **å¦‚æœæœªç™»å½•ï¼š**æ˜¾ç¤º**ç™»é™†**æŒ‰é’®
- **å¦‚æœå·²ç™»å½•ï¼š**æ˜¾ç¤º**ç”¨æˆ·å**å’Œ**æ³¨é”€**æŒ‰é’®

```html
<!--æœªç™»å½•-->
<div sec:authorize="!isAuthenticated()">
    <a class="item" th:href="@{/toLogin}">
        <i class="address card icon"></i> ç™»å½•
    </a>
</div>

<div sec:authorize="isAuthenticated()">
    <!--å·²ç™»å½•ï¼šç”¨æˆ·å-->
    <a class="item">
        ç”¨æˆ·åï¼š<span sec:authentication="name"></span>
        è§’è‰²ï¼š<span sec:authentication="authorities"></span>
    </a>
    <!--å·²ç™»å½•ï¼šæ³¨é”€-->
    <a class="item" th:href="@{/logout}">
        <i class="sign-out icon"></i> æ³¨é”€
    </a>
</div>
```



- æ ¹æ®å·²ç™»é™†è§’è‰²çš„ä¸åŒï¼Œæ˜¾ç¤ºä¸åŒçš„div
- `sec:authorize="hasRole('xxx')"`

```html
<div class="column" sec:authorize="hasRole('vip1')">
```



### è®°ä½æˆ‘åŠŸèƒ½

> -config
>
> â€‹	-SecurityConfig

> **è¯´æ˜ï¼š**
>
> è®°ä½æˆ‘åŠŸèƒ½å¼€å¯çš„æ—¶å€™ï¼Œå…¶å®å°±æ˜¯ç±»ä¼¼äºç»™äº†ä¸€ä¸ªä»¤ç‰Œï¼Œå…³é—­æµè§ˆå™¨å†æ¬¡è¿›å…¥ä¸ç”¨å†æ¬¡ç™»å½•
>
> æœ‰æ•ˆæœŸé»˜è®¤ä¸¤å‘¨ï¼ˆ14å¤©ï¼‰

```java
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    // æˆæƒ
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // å¼€å¯ è®°ä½æˆ‘ åŠŸèƒ½
        http.rememberMe();
    }
}
```





### å®šåˆ¶ä¸ºè‡ªå·±çš„Loginé¡µé¢

> - loginPageï¼šå®šä½ç™»é™†é¡µé¢
> - usernameParameterï¼šè®¾ç½®å‰ç«¯ç”¨æˆ·åå‚æ•°å¯¹åº”çš„name
> - passwordParameterï¼šè®¾ç½®å‰ç«¯å¯†ç å‚æ•°å¯¹åº”çš„name
> - loginProcessingUrlï¼šè®¾ç½®æäº¤ç™»å½•è¯·æ±‚çš„urlï¼ˆform action:"/login"ï¼‰

```java
http.formLogin().loginPage("/toLogin")
                .usernameParameter("username")
                .passwordParameter("password")
                .loginProcessingUrl("/login");
```



### è®¾ç½®"è®°ä½æˆ‘"å‚æ•°

```java
http.rememberMe().rememberMeParameter("remember");
```





# Shiro && SpringBoot

## ä»‹ç»

- Javaçš„å®‰å…¨æƒé™æ¡†æ¶
- JavaSEå’ŒJavaEEéƒ½å¯ä»¥ä½¿ç”¨
- å¯ä»¥å®Œæˆï¼šè®¤è¯ã€æˆæƒã€åŠ å¯†ã€ä¼šè¯ç®¡ç†ã€Webé›†æˆã€ç¼“å­˜..
- [Apache Shiro | Simple. Java. Security.](https://shiro.apache.org/)



## åŠŸèƒ½ï¼ˆå®˜æ–¹ï¼‰

![img](https://atts.w3cschool.cn/attachments/day_210518/202105181936039546.png)

#### Primary Concerns(ä¸»è¦)

- **Authentication**ï¼šèº«ä»½è®¤è¯ / ç™»å½•ï¼ŒéªŒè¯ç”¨æˆ·æ˜¯ä¸æ˜¯æ‹¥æœ‰ç›¸åº”çš„èº«ä»½ï¼›
- **Authorization**ï¼šæˆæƒï¼Œå³æƒé™éªŒè¯ï¼ŒéªŒè¯æŸä¸ªå·²è®¤è¯çš„ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŸä¸ªæƒé™ï¼›å³åˆ¤æ–­ç”¨æˆ·æ˜¯å¦èƒ½åšäº‹æƒ…ï¼Œå¸¸è§çš„å¦‚ï¼šéªŒè¯æŸä¸ªç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŸä¸ªè§’è‰²ã€‚æˆ–è€…ç»†ç²’åº¦çš„éªŒè¯æŸä¸ªç”¨æˆ·å¯¹æŸä¸ªèµ„æºæ˜¯å¦å…·æœ‰æŸä¸ªæƒé™ï¼›
- **Session** **Management**ï¼šä¼šè¯ç®¡ç†ï¼Œå³ç”¨æˆ·ç™»å½•åå°±æ˜¯ä¸€æ¬¡ä¼šè¯ï¼Œåœ¨æ²¡æœ‰é€€å‡ºä¹‹å‰ï¼Œå®ƒçš„æ‰€æœ‰ä¿¡æ¯éƒ½åœ¨ä¼šè¯ä¸­ï¼›ä¼šè¯å¯ä»¥æ˜¯æ™®é€š JavaSE ç¯å¢ƒçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¦‚ Web ç¯å¢ƒçš„ï¼›
- **Cryptography**ï¼šåŠ å¯†ï¼Œä¿æŠ¤æ•°æ®çš„å®‰å…¨æ€§ï¼Œå¦‚å¯†ç åŠ å¯†å­˜å‚¨åˆ°æ•°æ®åº“ï¼Œè€Œä¸æ˜¯æ˜æ–‡å­˜å‚¨ï¼›

#### Supporting Featuresï¼ˆæ”¯æŒï¼‰

- **Web Support**ï¼šWeb æ”¯æŒï¼Œå¯ä»¥éå¸¸å®¹æ˜“çš„é›†æˆåˆ° Web ç¯å¢ƒï¼›
- **Caching**ï¼šç¼“å­˜ï¼Œæ¯”å¦‚ç”¨æˆ·ç™»å½•åï¼Œå…¶ç”¨æˆ·ä¿¡æ¯ã€æ‹¥æœ‰çš„è§’è‰² / æƒé™ä¸å¿…æ¯æ¬¡å»æŸ¥ï¼Œè¿™æ ·å¯ä»¥æé«˜æ•ˆç‡ï¼›
- **Concurrency**ï¼šshiro æ”¯æŒå¤šçº¿ç¨‹åº”ç”¨çš„å¹¶å‘éªŒè¯ï¼Œå³å¦‚åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¼€å¯å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œèƒ½æŠŠæƒé™è‡ªåŠ¨ä¼ æ’­è¿‡å»ï¼›
- **Testing**ï¼šæä¾›æµ‹è¯•æ”¯æŒï¼›
- **Run As**ï¼šå…è®¸ä¸€ä¸ªç”¨æˆ·å‡è£…ä¸ºå¦ä¸€ä¸ªç”¨æˆ·ï¼ˆå¦‚æœä»–ä»¬å…è®¸ï¼‰çš„èº«ä»½è¿›è¡Œè®¿é—®ï¼›
- **Remember Me**ï¼šè®°ä½æˆ‘ï¼Œè¿™ä¸ªæ˜¯éå¸¸å¸¸è§çš„åŠŸèƒ½ï¼Œå³ä¸€æ¬¡ç™»å½•åï¼Œä¸‹æ¬¡å†æ¥çš„è¯ä¸ç”¨ç™»å½•äº†ã€‚

## å¤–éƒ¨æ¶æ„ï¼ˆå®˜æ–¹ï¼‰

å³ï¼šä»åº”ç”¨ç¨‹åºè§’åº¦è§‚å¯Ÿå¦‚ä½•ä½¿ç”¨shiroå®Œæˆå·¥ä½œ

![img](https://atts.w3cschool.cn/attachments/image/wk/shiro/2.png)

å¯ä»¥çœ‹åˆ°ï¼šåº”ç”¨ä»£ç ç›´æ¥äº¤äº’çš„å¯¹è±¡æ˜¯ Subjectï¼Œä¹Ÿå°±æ˜¯è¯´ Shiro çš„å¯¹å¤– API æ ¸å¿ƒå°±æ˜¯ Subjectï¼›å…¶æ¯ä¸ª API çš„å«ä¹‰ï¼š

**Subject**ï¼šä¸»ä½“ï¼Œä»£è¡¨äº†å½“å‰ â€œç”¨æˆ·â€ï¼Œè¿™ä¸ªç”¨æˆ·ä¸ä¸€å®šæ˜¯ä¸€ä¸ªå…·ä½“çš„äººï¼Œä¸å½“å‰åº”ç”¨äº¤äº’çš„ä»»ä½•ä¸œè¥¿éƒ½æ˜¯ Subjectï¼Œå¦‚ç½‘ç»œçˆ¬è™«ï¼Œæœºå™¨äººç­‰ï¼›å³ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼›æ‰€æœ‰ Subject éƒ½ç»‘å®šåˆ° SecurityManagerï¼Œä¸ Subject çš„æ‰€æœ‰äº¤äº’éƒ½ä¼šå§”æ‰˜ç»™ SecurityManagerï¼›å¯ä»¥æŠŠ Subject è®¤ä¸ºæ˜¯ä¸€ä¸ªé—¨é¢ï¼›SecurityManager æ‰æ˜¯å®é™…çš„æ‰§è¡Œè€…ï¼›

**SecurityManager**ï¼šå®‰å…¨ç®¡ç†å™¨ï¼›å³æ‰€æœ‰ä¸å®‰å…¨æœ‰å…³çš„æ“ä½œéƒ½ä¼šä¸ SecurityManager äº¤äº’ï¼›ä¸”å®ƒç®¡ç†ç€æ‰€æœ‰ Subjectï¼›å¯ä»¥çœ‹å‡ºå®ƒæ˜¯ Shiro çš„æ ¸å¿ƒï¼Œå®ƒè´Ÿè´£ä¸åè¾¹ä»‹ç»çš„å…¶ä»–ç»„ä»¶è¿›è¡Œäº¤äº’ï¼Œå¦‚æœå­¦ä¹ è¿‡ SpringMVCï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹æˆ DispatcherServlet å‰ç«¯æ§åˆ¶å™¨ï¼›

**Realm**ï¼šåŸŸï¼ŒShiro ä» Realm è·å–å®‰å…¨æ•°æ®ï¼ˆå¦‚ç”¨æˆ·ã€è§’è‰²ã€æƒé™ï¼‰ï¼Œå°±æ˜¯è¯´ SecurityManager è¦éªŒè¯ç”¨æˆ·èº«ä»½ï¼Œé‚£ä¹ˆå®ƒéœ€è¦ä» Realm è·å–ç›¸åº”çš„ç”¨æˆ·è¿›è¡Œæ¯”è¾ƒä»¥ç¡®å®šç”¨æˆ·èº«ä»½æ˜¯å¦åˆæ³•ï¼›ä¹Ÿéœ€è¦ä» Realm å¾—åˆ°ç”¨æˆ·ç›¸åº”çš„è§’è‰² / æƒé™è¿›è¡ŒéªŒè¯ç”¨æˆ·æ˜¯å¦èƒ½è¿›è¡Œæ“ä½œï¼›å¯ä»¥æŠŠ Realm çœ‹æˆ DataSourceï¼Œå³å®‰å…¨æ•°æ®æºã€‚

ä¹Ÿå°±æ˜¯è¯´å¯¹äºæˆ‘ä»¬è€Œè¨€ï¼Œæœ€ç®€å•çš„ä¸€ä¸ª Shiro åº”ç”¨ï¼š

1. åº”ç”¨ä»£ç é€šè¿‡ Subject æ¥è¿›è¡Œè®¤è¯å’Œæˆæƒï¼Œè€Œ Subject åˆå§”æ‰˜ç»™ SecurityManagerï¼›
2. æˆ‘ä»¬éœ€è¦ç»™ Shiro çš„ SecurityManager æ³¨å…¥ Realmï¼Œä»è€Œè®© SecurityManager èƒ½å¾—åˆ°åˆæ³•çš„ç”¨æˆ·åŠå…¶æƒé™è¿›è¡Œåˆ¤æ–­ã€‚

**ä»ä»¥ä¸Šä¹Ÿå¯ä»¥çœ‹å‡ºï¼ŒShiro ä¸æä¾›ç»´æŠ¤ç”¨æˆ· / æƒé™ï¼Œè€Œæ˜¯é€šè¿‡ Realm è®©å¼€å‘äººå‘˜è‡ªå·±æ³¨å…¥ã€‚**



## å†…éƒ¨æ¶æ„ï¼ˆå®˜æ–¹ï¼‰

![img](https://atts.w3cschool.cn/attachments/image/wk/shiro/3.png)

- **Subject**ï¼šä¸»ä½“ï¼Œå¯ä»¥çœ‹åˆ°ä¸»ä½“å¯ä»¥æ˜¯ä»»ä½•å¯ä»¥ä¸åº”ç”¨äº¤äº’çš„ â€œç”¨æˆ·â€ï¼›
- **SecurityManager**ï¼šç›¸å½“äº SpringMVC ä¸­çš„ DispatcherServlet æˆ–è€… Struts2 ä¸­çš„ FilterDispatcherï¼›æ˜¯ Shiro çš„å¿ƒè„ï¼›æ‰€æœ‰å…·ä½“çš„äº¤äº’éƒ½é€šè¿‡ SecurityManager è¿›è¡Œæ§åˆ¶ï¼›å®ƒç®¡ç†ç€æ‰€æœ‰ Subjectã€ä¸”è´Ÿè´£è¿›è¡Œè®¤è¯å’Œæˆæƒã€åŠä¼šè¯ã€ç¼“å­˜çš„ç®¡ç†ã€‚
- **Authenticator**ï¼šè®¤è¯å™¨ï¼Œè´Ÿè´£ä¸»ä½“è®¤è¯çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œå¦‚æœç”¨æˆ·è§‰å¾— Shiro é»˜è®¤çš„ä¸å¥½ï¼Œå¯ä»¥è‡ªå®šä¹‰å®ç°ï¼›å…¶éœ€è¦è®¤è¯ç­–ç•¥ï¼ˆAuthentication Strategyï¼‰ï¼Œå³ä»€ä¹ˆæƒ…å†µä¸‹ç®—ç”¨æˆ·è®¤è¯é€šè¿‡äº†ï¼›
- **Authorizer**ï¼šæˆæƒå™¨ï¼Œæˆ–è€…è®¿é—®æ§åˆ¶å™¨ï¼Œç”¨æ¥å†³å®šä¸»ä½“æ˜¯å¦æœ‰æƒé™è¿›è¡Œç›¸åº”çš„æ“ä½œï¼›å³æ§åˆ¶ç€ç”¨æˆ·èƒ½è®¿é—®åº”ç”¨ä¸­çš„å“ªäº›åŠŸèƒ½ï¼›
- **Realm**ï¼šå¯ä»¥æœ‰ 1 ä¸ªæˆ–å¤šä¸ª Realmï¼Œå¯ä»¥è®¤ä¸ºæ˜¯å®‰å…¨å®ä½“æ•°æ®æºï¼Œå³ç”¨äºè·å–å®‰å…¨å®ä½“çš„ï¼›å¯ä»¥æ˜¯ JDBC å®ç°ï¼Œä¹Ÿå¯ä»¥æ˜¯ LDAP å®ç°ï¼Œæˆ–è€…å†…å­˜å®ç°ç­‰ç­‰ï¼›ç”±ç”¨æˆ·æä¾›ï¼›æ³¨æ„ï¼šShiro ä¸çŸ¥é“ä½ çš„ç”¨æˆ· / æƒé™å­˜å‚¨åœ¨å“ªåŠä»¥ä½•ç§æ ¼å¼å­˜å‚¨ï¼›æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬åœ¨åº”ç”¨ä¸­éƒ½éœ€è¦å®ç°è‡ªå·±çš„ Realmï¼›
- **SessionManager**ï¼šå¦‚æœå†™è¿‡ Servlet å°±åº”è¯¥çŸ¥é“ Session çš„æ¦‚å¿µï¼ŒSession å‘¢éœ€è¦æœ‰äººå»ç®¡ç†å®ƒçš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™ä¸ªç»„ä»¶å°±æ˜¯ SessionManagerï¼›è€Œ Shiro å¹¶ä¸ä»…ä»…å¯ä»¥ç”¨åœ¨ Web ç¯å¢ƒï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨å¦‚æ™®é€šçš„ JavaSE ç¯å¢ƒã€EJB ç­‰ç¯å¢ƒï¼›æ‰€ä»¥å‘¢ï¼ŒShiro å°±æŠ½è±¡äº†ä¸€ä¸ªè‡ªå·±çš„ Session æ¥ç®¡ç†ä¸»ä½“ä¸åº”ç”¨ä¹‹é—´äº¤äº’çš„æ•°æ®ï¼›è¿™æ ·çš„è¯ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨ Web ç¯å¢ƒç”¨ï¼Œåˆšå¼€å§‹æ˜¯ä¸€å° Web æœåŠ¡å™¨ï¼›æ¥ç€åˆä¸Šäº†å° EJB æœåŠ¡å™¨ï¼›è¿™æ—¶æƒ³æŠŠä¸¤å°æœåŠ¡å™¨çš„ä¼šè¯æ•°æ®æ”¾åˆ°ä¸€ä¸ªåœ°æ–¹ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥å®ç°è‡ªå·±çš„åˆ†å¸ƒå¼ä¼šè¯ï¼ˆå¦‚æŠŠæ•°æ®æ”¾åˆ° Memcached æœåŠ¡å™¨ï¼‰ï¼›
- **SessionDAO**ï¼šDAO å¤§å®¶éƒ½ç”¨è¿‡ï¼Œæ•°æ®è®¿é—®å¯¹è±¡ï¼Œç”¨äºä¼šè¯çš„ CRUDï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³æŠŠ Session ä¿å­˜åˆ°æ•°æ®åº“ï¼Œé‚£ä¹ˆå¯ä»¥å®ç°è‡ªå·±çš„ SessionDAOï¼Œé€šè¿‡å¦‚ JDBC å†™åˆ°æ•°æ®åº“ï¼›æ¯”å¦‚æƒ³æŠŠ Session æ”¾åˆ° Memcached ä¸­ï¼Œå¯ä»¥å®ç°è‡ªå·±çš„ Memcached SessionDAOï¼›å¦å¤– SessionDAO ä¸­å¯ä»¥ä½¿ç”¨ Cache è¿›è¡Œç¼“å­˜ï¼Œä»¥æé«˜æ€§èƒ½ï¼›
- **CacheManager**ï¼šç¼“å­˜æ§åˆ¶å™¨ï¼Œæ¥ç®¡ç†å¦‚ç”¨æˆ·ã€è§’è‰²ã€æƒé™ç­‰çš„ç¼“å­˜çš„ï¼›å› ä¸ºè¿™äº›æ•°æ®åŸºæœ¬ä¸Šå¾ˆå°‘å»æ”¹å˜ï¼Œæ”¾åˆ°ç¼“å­˜ä¸­åå¯ä»¥æé«˜è®¿é—®çš„æ€§èƒ½
- **Cryptography**ï¼šå¯†ç æ¨¡å—ï¼ŒShiro æä¾›äº†ä¸€äº›å¸¸è§çš„åŠ å¯†ç»„ä»¶ç”¨äºå¦‚å¯†ç åŠ å¯† / è§£å¯†çš„ã€‚



## å¤–éƒ¨æ¶æ„

- Subjectï¼šç”¨æˆ·
- SecurityManagerï¼šç®¡ç†æ‰€æœ‰ç”¨æˆ·
- Realmï¼šè¿æ¥æ•°æ®



## Shiroä½¿ç”¨æ­¥éª¤

### å¯¼åŒ… - Shiroæ•´åˆSpring

```xml
<dependency>
    <groupId>org.apache.shiro</groupId>
    <artifactId>shiro-spring</artifactId>
    <version>1.4.0</version>
</dependency>
```



### ç¼–å†™é…ç½®ç±»ï¼ˆæ­ç¯å¢ƒï¼‰

**åˆ›å»ºä¸‰ä¸ªæ ¸å¿ƒå¯¹è±¡**

- ShiroFilterFactoryBeanï¼ˆéœ€è¦ğŸ‘‡ï¼‰
- DefaultWebSecurityManagerï¼ˆéœ€è¦ğŸ‘‡ï¼‰
- åˆ›å»ºrealmå¯¹è±¡ï¼Œéœ€è¦è‡ªå®šä¹‰ç±»



**åˆ›å»ºrealmè‡ªå®šä¹‰ç±»**

> -config
>
> â€‹	-UserRealm.java

```java
public class UserRealm extends AuthorizingRealm {
    // æˆæƒ
    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) {
        System.out.println("æ‰§è¡Œäº†æˆæƒ");
        return null;
    }

    // è®¤è¯
    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {
        System.out.println("æ‰§è¡Œäº†è®¤è¯");
        return null;
    }
}
```



**ç¼–å†™ShiroConfig**

> -config
>
> â€‹	-ShiroConfig.java

```java
@Configuration
public class ShiroConfig {
    //ShiroFilterFactoryBeanï¼š3
    @Bean(name = "shiroFilter")
    public ShiroFilterFactoryBean shiroFilterFactoryBean(@Qualifier("securityManager") DefaultWebSecurityManager  securityManager){
        ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();
        // è®¾ç½®å®‰å…¨ç®¡ç†å™¨
        shiroFilterFactoryBean.setSecurityManager(securityManager);
        return shiroFilterFactoryBean;
    }

    // DefaultWebSecurityManagerï¼š2
    @Bean(name = "securityManager")
    public DefaultWebSecurityManager getDefaultWebSecurityManager(@Qualifier("userRealm") UserRealm userRealm) {
        DefaultWebSecurityManager securityManager = new DefaultWebSecurityManager();
        // å…³è”userRealm,ç®¡ç†userRealm
        securityManager.setRealm(userRealm);
        return securityManager;
    }

    // åˆ›å»ºrealmå¯¹è±¡ï¼Œéœ€è¦è‡ªå®šä¹‰ç±»ï¼š1
    @Bean(name = "userRealm")
    public UserRealm userRealm() {
        return new UserRealm();
    }
}
```



### æ·»åŠ shiroçš„å†…ç½®è¿‡æ»¤å™¨

> -config
>
> â€‹	-ShiroConfig.java
>
> â€‹		-shiroFilterFactoryBean()

```java
Map<String, String> filterMap = new LinkedHashMap<>();
bean.setFilterChainDefinitionMap(filterMap);
```



åœ¨filterMapä¸­æ·»åŠ å†…ç½®è¿‡æ»¤å™¨é…ç½®åŠ**å‚æ•°**

> - anonï¼šæ— éœ€è®¤è¯å³å¯è®¿é—®
> - authcï¼šå¿…é¡»è®¤è¯äº†æ‰èƒ½è®¿é—®
> - userï¼šå¿…é¡»æ‹¥æœ‰ â€œè®°ä½æˆ‘â€ åŠŸèƒ½æ‰èƒ½ç”¨
> - permsï¼šæ‹¥æœ‰å¯¹æŸä¸ªèµ„æºçš„æƒé™æ‰èƒ½è®¿é—®
> - roleï¼šæ‹¥æœ‰æŸä¸ªè§’è‰²æƒé™æ‰èƒ½è®¿é—®

**ä¾‹å¦‚ï¼š**

```java
Map<String, String> filterMap = new LinkedHashMap<>();
filterMap.put("/user/add","anon");
filterMap.put("/user/update","authc");
bean.setFilterChainDefinitionMap(filterMap);
```

æ­¤æ—¶ï¼Œè·³è½¬user/updateé¡µé¢çš„æ—¶å€™ä¼šæ‹’ç»è®¿é—®



### åœ¨shiroè¿‡æ»¤å™¨ä¸­é…ç½®æ‹¦æˆªè·³è½¬çš„Loginé¡µé¢

```java
// è®¾ç½®ç™»é™†çš„è¯·æ±‚
bean.setLoginUrl("/toLogin");
```



### å¼€å§‹è®¤è¯

**ç®€ç•¥å›¾**

<img src="D:\File\markdownPictures\image-20240306222552634.png" alt="image-20240306222552634" style="zoom:33%;float:left" />

- **ç™»å½•Controller**ä¸­ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç ç”Ÿæˆ**token**

  ```java
  UsernamePasswordToken token = new UsernamePasswordToken(username, password);
  ```

- è·å–å½“å‰ç”¨æˆ·**è¿›è¡Œlogin**ï¼Œä¼ å…¥**token**

  ```java
  Subject subject = SecurityUtils.getSubject();
  subject.login(token);
  ```

- ä¼ å…¥çš„tokenä¼šèµ°å…¥**Shiroçš„é…ç½®ç±»**ä¸­ï¼Œå±‚å±‚è¿›å…¥åˆ°**è¢«ç®¡ç†çš„UserRealm**

- åœ¨è¯¥UserRealmä¸­è¿›è¡Œè®¤è¯ï¼Œè·å–ä¸Šé¢çš„tokenï¼Œåœ¨æ­¤å¤„ä¸æ•°æ®åº“è·å–åˆ°çš„ç”¨æˆ·åè¿›è¡Œå¯¹æ¯”

  è·å–åˆ°å¯¹åº”ç”¨æˆ·ååï¼Œå°†é€šè¿‡**SimpleAuthenticationInfo**æ–¹æ³•éªŒè¯å¯†ç 

  ç”¨æˆ·åå¦‚æœè®¤è¯å¤±è´¥å°†ç›´æ¥æŠ›å‡º**UnknownAccountException**å¼‚å¸¸

  **SimpleAuthenticationInfo**å¯†ç éªŒè¯å¤±è´¥ä¹Ÿä¼šæŠ›å‡ºå¯†ç å¼‚å¸¸

  ```java
  // è®¤è¯
  @Override
  protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {
      String username = "admin";
      String password = "admin";
      UsernamePasswordToken userToken = (UsernamePasswordToken) token;
      if (userToken.getUsername().equals(username)) {
          // æŠ›å‡ºå¼‚å¸¸ï¼šUnknownAccountException
          return null;
      }
  
      return new SimpleAuthenticationInfo("", password, "");
  }
  ```

  











# é¢˜å¤–

## Thymeleafæ ‡æ³¨

> Simple expressions:
>
> Variable Expressions: **`${...}`**
>
> Selection Variable Expressions: **`*{...}`**
>
> Message Expressions: **`#{...}`**
>
> Link URL Expressions: **`@{...}`**
>
> Fragment Expressions: **`~{...}`**





## kuangæ¨è

SemanticUI





# GitBashå‘½ä»¤ç»„

```bash
git add .;
git commit -m "æ·»åŠ äº†ç™»å½•ç•Œé¢ï¼ŒåŠé…ç½®æ‹¦æˆªè·³è½¬çš„ç™»å½•è¯·æ±‚";
git push gitee;
git push github;
```





























































